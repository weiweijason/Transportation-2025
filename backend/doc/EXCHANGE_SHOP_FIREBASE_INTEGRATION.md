# å…Œæ›å•†åº—Firebaseå¾Œç«¯æ•´åˆå ±å‘Š

## ğŸ¯ æ”¹é€²ç›®æ¨™

é€éFirebaseå¾Œç«¯Python APIå‘¼å«ï¼Œè®€å–ç•¶å‰ä½¿ç”¨è€…çœŸæ­£å‰©é¤˜çš„æ•¸é‡ï¼Œç¢ºä¿æ•¸æ“šçš„æº–ç¢ºæ€§å’Œä¸€è‡´æ€§ã€‚

## âœ… å®Œæˆçš„æ”¹é€²

### 1. **Pythonå¾Œç«¯APIå„ªåŒ–**

#### ğŸ”§ FirebaseServiceæ•´åˆ
- **ä½¿ç”¨æ¨™æº–æ–¹æ³•**: æ”¹ç”¨ `firebase_service.get_user_info(user_id)` è€Œéç›´æ¥æŸ¥è©¢Firestore
- **çµ±ä¸€æ•¸æ“šç²å–**: ç¢ºä¿èˆ‡å…¶ä»–æ¨¡çµ„ï¼ˆå¦‚daily_migrationï¼‰ä½¿ç”¨ç›¸åŒçš„æ•¸æ“šç²å–æ–¹å¼
- **å‘å¾Œå…¼å®¹**: æ”¯æŒFirestoreå’ŒRealtime Databaseçš„è‡ªå‹•åˆ‡æ›

#### ğŸ›¡ï¸ æ•¸æ“šå®Œæ•´æ€§ä¿éšœ
```python
# ç¢ºä¿æ•¸æ“šé¡å‹æ­£ç¢º
exchange_data = {
    'normal_potion_fragments': int(user_data.get('normal_potion_fragments', 0)),
    'normal_potions': int(user_data.get('normal_potions', 0)),
    'magic_circle_normal': int(user_data.get('magic_circle_normal', 0)),
    'magic_circle_advanced': int(user_data.get('magic_circle_advanced', 0)),
    'magic_circle_legendary': int(user_data.get('magic_circle_legendary', 0))
}
```

#### ğŸ”’ äº‹å‹™è™•ç†æ©Ÿåˆ¶
```python
@firebase_service.firestore_db.transactional
def update_potion_exchange(transaction, user_ref):
    # å†æ¬¡æª¢æŸ¥æœ€æ–°æ•¸æ“šï¼ˆé˜²æ­¢ä½µç™¼å•é¡Œï¼‰
    fresh_user_doc = user_ref.get(transaction=transaction)
    # é‡æ–°è¨ˆç®—ï¼ˆåŸºæ–¼æœ€æ–°æ•¸æ“šï¼‰
    # åŸå­æ€§æ›´æ–°æ“ä½œ
```

### 2. **å¼·åŒ–éŒ¯èª¤è™•ç†**

#### ğŸ“Š è©³ç´°æ—¥èªŒè¨˜éŒ„
```python
logger.info(f"æˆåŠŸç²å–ç”¨æˆ¶ {user_id} çš„å…Œæ›æ•¸æ“š: {exchange_data}")
logger.warning(f"æ‰¾ä¸åˆ°ç”¨æˆ¶è³‡æ–™: {user_id}")
logger.error(f"ç²å–å…Œæ›æ•¸æ“šå¤±æ•— - ç”¨æˆ¶ID: {user_id}, éŒ¯èª¤: {str(e)}")
```

#### ğŸš« å®‰å…¨éŒ¯èª¤è¨Šæ¯
- é¿å…æš´éœ²ç³»çµ±å…§éƒ¨éŒ¯èª¤è©³æƒ…
- ç‚ºç”¨æˆ¶æä¾›å‹å–„çš„éŒ¯èª¤æç¤º
- é–‹ç™¼äººå“¡å¯ä»¥é€šéæ—¥èªŒæŸ¥çœ‹è©³ç´°éŒ¯èª¤

### 3. **ä½µç™¼å®‰å…¨æ€§**

#### âš¡ Firestoreäº‹å‹™æ©Ÿåˆ¶
- **é˜²æ­¢ç«¶çˆ­æ¢ä»¶**: ä½¿ç”¨ `@transactional` è£é£¾å™¨
- **åŸå­æ€§æ“ä½œ**: ç¢ºä¿æ•¸æ“šæ›´æ–°çš„å®Œæ•´æ€§
- **é‡æ–°é©—è­‰**: åœ¨äº‹å‹™ä¸­é‡æ–°æª¢æŸ¥æœ€æ–°æ•¸æ“š

#### ğŸ”„ é›™é‡æ•¸æ“šæª¢æŸ¥
```python
# ç¬¬ä¸€æ¬¡æª¢æŸ¥
current_fragments = int(user_data.get('normal_potion_fragments', 0))

# äº‹å‹™ä¸­é‡æ–°æª¢æŸ¥
fresh_fragments = int(fresh_user_data.get('normal_potion_fragments', 0))
if fresh_fragments < 7:
    raise ValueError(f"ç¢ç‰‡ä¸è¶³ï¼éœ€è¦7å€‹ç¢ç‰‡ï¼Œç›®å‰åªæœ‰{fresh_fragments}å€‹")
```

### 4. **å‰ç«¯JavaScriptå¢å¼·**

#### ğŸ“ˆ è©³ç´°æ—¥èªŒè¨˜éŒ„
```javascript
console.log('é–‹å§‹è¼‰å…¥å…Œæ›æ•¸æ“š...');
console.log('APIå›æ‡‰ç‹€æ…‹:', response.status);
console.log('æ”¶åˆ°çš„å…Œæ›æ•¸æ“š:', data);
```

#### ğŸ”„ æ™ºèƒ½æ•¸æ“šåŒæ­¥
- å…Œæ›æˆåŠŸå¾Œè‡ªå‹•é‡æ–°è¼‰å…¥æ•¸æ“š
- å»¶é²è¼‰å…¥é¿å…éæ–¼é »ç¹çš„APIå‘¼å«
- æŒ‰éˆ•ç‹€æ…‹å³æ™‚æ›´æ–°

## ğŸ”§ APIç«¯é»æ”¹é€²

### ğŸ“¥ GET `/exchange-shop/api/get-exchange-data`
**æ”¹é€²å‰**:
```python
user_ref = firebase_service.firestore_db.collection('users').document(user_id)
user_doc = user_ref.get()
user_data = user_doc.to_dict()
```

**æ”¹é€²å¾Œ**:
```python
user_data = firebase_service.get_user_info(user_id)  # æ›´ç©©å¥
exchange_data = {
    'normal_potion_fragments': int(user_data.get('normal_potion_fragments', 0)),  # é¡å‹å®‰å…¨
    # ...
}
```

### ğŸ“¤ POST `/exchange-shop/api/exchange-potion-fragments`
**é—œéµæ”¹é€²**:
- âœ… äº‹å‹™æ€§æ“ä½œç¢ºä¿æ•¸æ“šä¸€è‡´æ€§
- âœ… ä½µç™¼å®‰å…¨ï¼Œé˜²æ­¢é‡è¤‡å…Œæ›
- âœ… è©³ç´°çš„æ“ä½œæ—¥èªŒ
- âœ… å‹å–„çš„éŒ¯èª¤æç¤º

### ğŸ“¤ POST `/exchange-shop/api/exchange-magic-circles`
**é—œéµæ”¹é€²**:
- âœ… æ”¯æŒå…©ç¨®å…Œæ›é¡å‹çš„äº‹å‹™è™•ç†
- âœ… è¼¸å…¥é©—è­‰å’Œé¡å‹æª¢æŸ¥
- âœ… å®Œæ•´çš„éŒ¯èª¤è™•ç†æµç¨‹

## ğŸ›¡ï¸ å®‰å…¨æ€§æå‡

### ğŸ” ç”¨æˆ¶é©—è­‰
- ä½¿ç”¨ `@login_required` è£é£¾å™¨
- é€é `current_user.id` ç²å–ç”¨æˆ¶èº«ä»½
- é˜²æ­¢æœªæˆæ¬Šè¨ªå•

### ğŸ“Š æ•¸æ“šé©—è­‰
- æ‰€æœ‰æ•¸å­—æ¬„ä½å¼·åˆ¶è½‰æ›ç‚º `int`
- æª¢æŸ¥ç”¨æˆ¶è³‡æ–™æ˜¯å¦å­˜åœ¨
- é©—è­‰å…Œæ›æ¢ä»¶æ˜¯å¦æ»¿è¶³

### ğŸ”’ åŸå­æ€§æ“ä½œ
- ä½¿ç”¨Firestoreäº‹å‹™ç¢ºä¿æ•¸æ“šä¸€è‡´æ€§
- é˜²æ­¢ä½µç™¼ä¿®æ”¹å°è‡´çš„æ•¸æ“šä¸ä¸€è‡´
- å¤±æ•—æ™‚è‡ªå‹•å›æ»¾

## ğŸ“Š æ€§èƒ½å„ªåŒ–

### âš¡ é«˜æ•ˆæ•¸æ“šç²å–
- ä½¿ç”¨ `FirebaseService.get_user_info()` çµ±ä¸€æ•¸æ“šç²å–
- æ¸›å°‘é‡è¤‡çš„FirestoreæŸ¥è©¢
- æ™ºèƒ½ç·©å­˜æ©Ÿåˆ¶ï¼ˆç”±FirebaseServiceæä¾›ï¼‰

### ğŸ”„ æœ€å°åŒ–APIå‘¼å«
- å‰ç«¯æ™ºèƒ½é‡æ–°è¼‰å…¥æ©Ÿåˆ¶
- é¿å…ä¸å¿…è¦çš„é‡è¤‡è«‹æ±‚
- æŒ‰éˆ•ç‹€æ…‹æ‰¹æ¬¡æ›´æ–°

## ğŸ§ª æ¸¬è©¦å»ºè­°

### ğŸ”§ åŠŸèƒ½æ¸¬è©¦
1. **æ•¸æ“šè¼‰å…¥æ¸¬è©¦**: ç¢ºèªå…Œæ›æ•¸æ“šæ­£ç¢ºé¡¯ç¤º
2. **å…Œæ›åŠŸèƒ½æ¸¬è©¦**: é©—è­‰å„ç¨®å…Œæ›æ“ä½œ
3. **éŒ¯èª¤è™•ç†æ¸¬è©¦**: æ¸¬è©¦å„ç¨®éŒ¯èª¤æƒ…æ³
4. **ä½µç™¼æ¸¬è©¦**: æ¨¡æ“¬å¤šç”¨æˆ¶åŒæ™‚å…Œæ›

### ğŸ“± ç”¨æˆ¶é«”é©—æ¸¬è©¦
1. **éŸ¿æ‡‰é€Ÿåº¦**: APIå›æ‡‰æ™‚é–“
2. **éŒ¯èª¤æç¤º**: å‹å–„éŒ¯èª¤è¨Šæ¯
3. **è¦–è¦ºå›é¥‹**: è¼‰å…¥ç‹€æ…‹å’ŒæˆåŠŸæç¤º
4. **æ•¸æ“šåŒæ­¥**: å³æ™‚æ›´æ–°é¡¯ç¤º

## ğŸš€ éƒ¨ç½²ç‹€æ…‹

- âœ… **å¾Œç«¯API**: å®Œå…¨é‡æ§‹ï¼Œä½¿ç”¨äº‹å‹™å’ŒFirebaseService
- âœ… **éŒ¯èª¤è™•ç†**: å®Œæ•´çš„éŒ¯èª¤æ•ç²å’Œæ—¥èªŒè¨˜éŒ„  
- âœ… **å‰ç«¯æ•´åˆ**: è©³ç´°æ—¥èªŒå’Œæ™ºèƒ½é‡æ–°è¼‰å…¥
- âœ… **å®‰å…¨æ€§**: ç”¨æˆ¶é©—è­‰å’Œæ•¸æ“šé©—è­‰
- âœ… **ä½µç™¼å®‰å…¨**: Firestoreäº‹å‹™æ©Ÿåˆ¶

**å…Œæ›å•†åº—ç¾åœ¨é€šéFirebaseå¾Œç«¯ç¢ºä¿æ•¸æ“šæº–ç¢ºæ€§å’Œä¸€è‡´æ€§ï¼** ğŸ‰

---

**æ›´æ–°æ™‚é–“**: 2025-06-17  
**æª”æ¡ˆ**: 
- `app/routes/exchange_shop.py` (å®Œå…¨é‡æ§‹)
- `app/static/js/exchange_shop/exchange_shop.js` (å¢å¼·æ—¥èªŒ)  
**ç‹€æ…‹**: âœ… å®Œæˆä¸¦å¯æŠ•å…¥ç”Ÿç”¢ä½¿ç”¨
