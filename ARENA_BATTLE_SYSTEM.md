# 道館戰鬥系統重構完成

## 🎯 系統概述

道館戰鬥系統已經完全重構，現在使用統一的Firebase後端API，移除了前端直接Firebase調用，並實現了完整的道館管理功能。

## 🚀 主要功能

### 1. 道館管理
- **動態創建**: 當玩家訪問不存在的道館時，系統自動在Firebase中創建
- **等級系統**: 支援1-5級道館，不同等級有不同的精靈使用限制
- **狀態追蹤**: 追蹤道館擁有者、守護精靈、佔領時間等

### 2. 精靈使用限制
```
等級1道館: 只能使用 N, R 稀有度精靈
等級2道館: 只能使用 N, R, SR 稀有度精靈  
等級3+道館: 可以使用所有稀有度精靈
```

### 3. 戰鬥系統
- **戰鬥邏輯**: 使用 `fight.py` 中的 `calculate_battle` 函數
- **屬性相剋**: 支援水->火->草->水和光->暗->普通->光的相剋關係
- **隨機因素**: 攻擊力和血量都有隨機波動

### 4. 佔領機制
- **直接佔領**: 無人佔領的道館可以直接佔領，無需戰鬥
- **挑戰佔領**: 已被佔領的道館需要戰鬥獲勝才能佔領
- **防止自戰**: 玩家不能挑戰自己佔領的道館

### 5. 獎勵系統
- **時間獎勵**: 道館會根據佔領時間自動產生魔法陣獎勵
- **獎勵類型**:
  - 等級1道館: 每小時1個 normal 魔法陣
  - 等級2道館: 每小時1個 advanced 魔法陣
  - 等級3道館: 每小時1個 premium 魔法陣
- **領取機制**: 只有道館擁有者可以領取獎勵

## 🔧 API 端點

### 道館管理
- `GET /game/api/arena-battle/get-arena/<arena_id>` - 獲取道館詳情
- `GET /game/api/arena-battle/get-user-creatures?arena_level=<level>` - 獲取符合等級的用戶精靈

### 戰鬥操作
- `POST /game/api/arena-battle/occupy` - 佔領道館
- `POST /game/api/arena-battle/battle` - 挑戰道館
- `POST /game/api/arena-battle/collect-rewards` - 領取獎勵

## 📱 前端功能

### 1. 響應式界面
- **道館資訊**: 顯示道館等級、擁有者、守護精靈
- **精靈選擇**: 根據道館等級自動過濾可用精靈
- **按鈕狀態**: 根據道館狀態智能顯示佔領/挑戰/獎勵按鈕

### 2. 互動體驗
- **戰鬥動畫**: 精靈對戰的視覺效果
- **即時反饋**: 操作結果的即時顯示
- **錯誤處理**: 友善的錯誤提示

### 3. 獎勵顯示
- **獎勵列表**: 顯示可領取的魔法陣獎勵
- **自動更新**: 獎勵狀態的自動刷新

## 🗄️ 數據結構

### Firebase Arena 文檔結構
```json
{
  "id": "arena-level-1-001",
  "name": "新手道館",
  "level": 1,
  "owner": "玩家名稱",
  "owner_player_id": "PLAYER123",
  "owner_creature": {
    "id": "creature123",
    "name": "火龍",
    "attack": 150,
    "hp": 1200,
    "type": "fire",
    "rarity": "R",
    "image_url": "..."
  },
  "occupied_at": "2025-01-16T10:30:00",
  "created_at": "2025-01-16T09:00:00",
  "last_updated": "2025-01-16T10:30:00",
  "total_battles": 5,
  "rewards": {
    "last_collected": "2025-01-16T09:00:00",
    "accumulated_hours": 3,
    "available_rewards": [
      {
        "circle_type": "normal",
        "quantity": 3,
        "description": "3 個 normal 魔法陣"
      }
    ]
  }
}
```

## 🔄 同步腳本

### 使用方法
```bash
python sync_arenas_to_firebase.py
```

### 功能
- 將現有道館數據同步到Firebase
- 創建測試道館
- 初始化獎勵系統

## 🎮 使用流程

### 玩家操作流程
1. **訪問道館**: 通過URL參數 `?arena_id=xxx` 訪問特定道館
2. **查看狀態**: 系統顯示道館等級、擁有者、守護精靈
3. **選擇精靈**: 從符合等級要求的精靈中選擇
4. **執行操作**:
   - 無人佔領 → 直接佔領
   - 已被佔領 → 發起挑戰
   - 自己道館 → 領取獎勵

### 戰鬥流程
1. **選擇精靈**: 確保精靈符合道館等級限制
2. **發起挑戰**: 系統執行戰鬥計算
3. **觀看動畫**: 顯示戰鬥過程動畫
4. **查看結果**: 顯示戰鬥結果和道館狀態更新

## 🛠️ 技術特點

### 後端架構
- **統一API**: 所有Firebase操作通過Python後端處理
- **錯誤處理**: 完善的異常處理和日誌記錄
- **數據驗證**: 嚴格的參數驗證和權限檢查

### 前端設計
- **無Firebase依賴**: 前端不直接調用Firebase
- **響應式設計**: 適配不同螢幕尺寸
- **用戶體驗**: 流暢的動畫和反饋

### 安全性
- **登入驗證**: 所有操作需要用戶登入
- **權限控制**: 只能操作自己的精靈和道館
- **數據校驗**: 後端驗證所有請求參數

## 📝 測試

### 測試腳本
```bash
python test_arena_battle.py
```

### 測試內容
- API端點測試
- 精靈等級限制驗證
- 獎勵計算邏輯測試
- 錯誤處理驗證

## 🚨 注意事項

1. **精靈數據**: 確保精靈數據包含 `attack`, `hp`, `rarity` 等必要字段
2. **時區處理**: 所有時間使用ISO格式字符串
3. **Firebase權限**: 確保Firebase規則允許後端服務讀寫
4. **用戶認證**: 確保用戶登入系統正常運作

## 🔮 未來擴展

- **道館排行榜**: 根據佔領時間、戰鬥次數排名
- **公會系統**: 公會間的道館爭奪戰
- **特殊事件**: 限時道館活動
- **精靈強化**: 使用魔法陣強化精靈屬性
