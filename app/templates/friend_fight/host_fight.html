{% extends "base.html" %}

{% block title %}å‰µå»ºå°æˆ°æˆ¿é–“ - ç²¾éˆå…¬è»Š{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-success text-white text-center">
                    <h3><i class="fas fa-plus-circle me-2"></i>å‰µå»ºå°æˆ°æˆ¿é–“</h3>
                </div>
                <div class="card-body">                    <div class="text-center mb-4">
                        <div class="invite-code-container p-3 bg-light rounded">
                            <h5>æˆ¿é–“IDï¼š</h5>
                            <div class="invite-code" id="room-id">è«‹å…ˆé¸æ“‡ç²¾éˆ</div>
                            <small class="text-muted" id="room-hint">é¸æ“‡ç²¾éˆå¾Œå°‡ç”Ÿæˆæˆ¿é–“IDä¾›æœ‹å‹åŠ å…¥</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-center mb-3">ä½ çš„ç²¾éˆ</h5>
                            <div class="arena-slot" id="player-slot" onclick="openModal()">
                                <span class="placeholder">
                                    <i class="fas fa-plus fa-3x"></i>
                                    <div>é¸æ“‡ç²¾éˆ</div>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-center mb-3">å°æ‰‹ç²¾éˆ</h5>
                            <div class="arena-slot opponent-slot">
                                <span class="placeholder">
                                    <i class="fas fa-hourglass-half fa-3x"></i>
                                    <div>ç­‰å¾…å°æ‰‹åŠ å…¥</div>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">                        <button id="ready-button" class="btn btn-success btn-lg" style="display:none;" onclick="createRoom()">
                            <i class="fas fa-check me-2"></i>å‰µå»ºæˆ¿é–“ä¸¦ç­‰å¾…å°æ‰‹
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="goBackWithCleanup()">
                            <i class="fas fa-arrow-left me-2"></i>è¿”å›
                        </button>
                    </div>

                    <div id="status-message" class="alert alert-info mt-3" style="display:none;">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="status-text"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç²¾éˆé¸æ“‡æ¨¡æ…‹çª—å£ -->
<div class="modal fade" id="spriteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">é¸æ“‡ä½ çš„ç²¾éˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="creature-list">
                    <!-- ç²¾éˆåˆ—è¡¨å°‡é€šéJavaScriptå‹•æ…‹åŠ è¼‰ -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .arena-slot {
        width: 250px;
        height: 250px;
        background-color: var(--card-bg);
        border: 3px dashed var(--border-color);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
        cursor: pointer;
        border-radius: 15px;
        transition: all 0.3s ease;
    }
    
    .arena-slot:hover {
        border-color: var(--primary-color);
        background-color: rgba(var(--primary-color-rgb), 0.1);
    }
    
    .arena-slot img {
        max-height: 200px;
        max-width: 200px;
        border-radius: 10px;
    }
    
    .placeholder {
        color: var(--text-muted);
        text-align: center;
    }
    
    .opponent-slot {
        cursor: default;
    }
    
    .opponent-slot:hover {
        border-color: var(--border-color);
        background-color: var(--card-bg);
    }
    
    .invite-code {
        font-size: 2rem;
        font-weight: bold;
        color: var(--success-color);
        font-family: 'Courier New', monospace;
        letter-spacing: 3px;
    }
    
    .invite-code-container {
        border: 2px solid var(--success-color);
    }
    
    .creature-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .creature-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-5px);
    }
    
    .creature-card.selected {
        border-color: var(--success-color);
        background-color: rgba(var(--success-color-rgb), 0.1);
    }
    
    [data-theme="dark"] .invite-code-container {
        background-color: var(--card-bg) !important;
        border-color: var(--success-color) !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let selectedCreatureId = null;
let roomId = null;
let statusCheckInterval = null;

function openModal() {
    loadUserCreatures();
    new bootstrap.Modal(document.getElementById('spriteModal')).show();
}

function loadUserCreatures() {
    fetch('/game/api/user/creatures')
        .then(response => response.json())        .then(data => {
            const creatureList = document.getElementById('creature-list');
            creatureList.innerHTML = '';
            
            if (Array.isArray(data) && data.length > 0) {
                data.forEach(creature => {
                    const creatureCard = createCreatureCard(creature);
                    creatureList.appendChild(creatureCard);
                });
            } else if (data.error) {
                creatureList.innerHTML = `<div class="col-12 text-center"><p class="text-danger">è¼‰å…¥éŒ¯èª¤ï¼š${data.error}</p></div>`;
            } else {
                creatureList.innerHTML = '<div class="col-12 text-center"><p class="text-muted">ä½ é‚„æ²’æœ‰æ•æ‰åˆ°ä»»ä½•ç²¾éˆï¼<br><a href="{{ url_for("game.catch") }}">ç«‹å³å»æ•æ‰</a></p></div>';
            }
        })
        .catch(error => {
            console.error('Error loading creatures:', error);
            showStatus('è¼‰å…¥ç²¾éˆå¤±æ•—', 'danger');
        });
}

function createCreatureCard(creature) {
    const div = document.createElement('div');
    div.className = 'col-md-4 col-sm-6 mb-3';
    div.innerHTML = `
        <div class="card creature-card h-100" onclick="selectCreature('${creature.id}', '${creature.name}', '${creature.image_url}')">
            <img src="${creature.image_url}" class="card-img-top" alt="${creature.name}" style="height: 150px; object-fit: cover;">
            <div class="card-body text-center">
                <h6 class="card-title">${creature.name}</h6>
                <span class="badge bg-${getElementColor(creature.element)}">${creature.element}</span>
                <div class="mt-2">
                    <small class="text-muted">åŠ›é‡: ${creature.power}</small>
                </div>
            </div>
        </div>
    `;
    return div;
}

function getElementColor(element) {
    const colors = {
        'ç«': 'danger',
        'æ°´': 'primary', 
        'æœ¨': 'success',
        'å…‰': 'warning',
        'æš—': 'dark'
    };
    return colors[element] || 'secondary';
}

function selectCreature(creatureId, creatureName, imageUrl) {
    selectedCreatureId = creatureId;
    
    // æ¸…é™¤ä¹‹å‰çš„é¸æ“‡ç‹€æ…‹
    document.querySelectorAll('.creature-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // æ¨™è¨˜ç•¶å‰é¸æ“‡
    event.currentTarget.classList.add('selected');
    
    // æ›´æ–°é¡¯ç¤º
    document.getElementById('player-slot').innerHTML = `
        <img src="${imageUrl}" alt="${creatureName}">
        <div class="mt-2"><strong>${creatureName}</strong></div>
    `;
    
    // é¡¯ç¤ºå‰µå»ºæŒ‰éˆ•
    document.getElementById('ready-button').style.display = 'inline-block';
    
    // é—œé–‰æ¨¡æ…‹çª—å£
    bootstrap.Modal.getInstance(document.getElementById('spriteModal')).hide();
}

function createRoom() {
    if (!selectedCreatureId) {
        showStatus('è«‹å…ˆé¸æ“‡ä¸€å€‹ç²¾éˆ', 'warning');
        return;
    }
    
    const button = document.getElementById('ready-button');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å‰µå»ºä¸­...';
    
    fetch('{{ url_for("friend_fight.create_room") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            creature_id: selectedCreatureId
        })
    })
    .then(response => response.json())    .then(data => {
        if (data.success) {
            roomId = data.room_id;
            document.getElementById('room-id').textContent = roomId;
            document.getElementById('room-hint').textContent = 'è«‹å°‡æ­¤IDåˆ†äº«çµ¦ä½ çš„æœ‹å‹';
            showStatus('æˆ¿é–“å‰µå»ºæˆåŠŸï¼ç­‰å¾…å°æ‰‹åŠ å…¥...', 'success');
            
            // é–‹å§‹æª¢æŸ¥æˆ¿é–“ç‹€æ…‹
            startStatusCheck();
            
            button.innerHTML = '<i class="fas fa-clock me-2"></i>ç­‰å¾…å°æ‰‹ä¸­...';
        } else {
            showStatus(data.message || 'å‰µå»ºæˆ¿é–“å¤±æ•—', 'danger');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check me-2"></i>å‰µå»ºæˆ¿é–“ä¸¦ç­‰å¾…å°æ‰‹';
        }
    })
    .catch(error => {
        console.error('Error creating room:', error);
        showStatus('å‰µå»ºæˆ¿é–“æ™‚ç™¼ç”ŸéŒ¯èª¤', 'danger');
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-check me-2"></i>å‰µå»ºæˆ¿é–“ä¸¦ç­‰å¾…å°æ‰‹';
    });
}

function startStatusCheck() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
    
    statusCheckInterval = setInterval(() => {
        if (roomId) {
            checkRoomStatus();
        }
    }, 2000);
}

function checkRoomStatus() {
    fetch(`{{ url_for("friend_fight.room_status", room_id="ROOM_ID") }}`.replace('ROOM_ID', roomId))
        .then(response => response.json())
        .then(data => {
            if (data.success && data.room_data) {
                const roomData = data.room_data;
                const status = roomData.status;
                
                if (status === 'ready') {
                    clearInterval(statusCheckInterval);
                    showStatus('å°æ‰‹å·²åŠ å…¥ï¼æ­£åœ¨è·³è½‰åˆ°å°æˆ°é é¢...', 'success');
                    
                    // è·³è½‰åˆ°å°æˆ°é é¢ï¼ˆæˆ¿ä¸»è¦–è§’ï¼‰
                    setTimeout(() => {
                        window.location.href = `{{ url_for("friend_fight.visitor_fight", room_id="ROOM_ID") }}`.replace('ROOM_ID', roomId);
                    }, 1500);
                    
                } else if (status === 'fighting') {
                    showStatus('æˆ°é¬¥é€²è¡Œä¸­...', 'warning');
                    
                } else if (status === 'finished') {
                    clearInterval(statusCheckInterval);
                    if (roomData.battle_result) {
                        showBattleResult(roomData.battle_result);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking room status:', error);
        });
}

function startBattle() {
    showStatus('æˆ°é¬¥é–‹å§‹ï¼', 'primary');
    
    fetch('{{ url_for("friend_fight.start_battle") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            room_id: roomId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showBattleResult(data.battle_result);
        } else {
            showStatus('æˆ°é¬¥é–‹å§‹å¤±æ•—ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error starting battle:', error);
        showStatus('æˆ°é¬¥é–‹å§‹æ™‚ç™¼ç”ŸéŒ¯èª¤', 'danger');
    });
}

function showBattleResult(result) {
    clearInterval(statusCheckInterval);
    
    const isWinner = result.winner === '{{ session.user.uid }}';
    const message = isWinner ? 
        `ğŸ‰ æ­å–œç²å‹ï¼ä½ çš„ ${result.winner_creature.name} æ“Šæ•—äº†å°æ‰‹çš„ ${result.loser_creature.name}ï¼` :
        `ğŸ˜¢ å¾ˆéºæ†¾è½æ•—ï¼å°æ‰‹çš„ ${result.winner_creature.name} æ“Šæ•—äº†ä½ çš„ ${result.loser_creature.name}ã€‚`;
    
    showStatus(message, isWinner ? 'success' : 'danger');
      // æ›´æ–°æŒ‰éˆ•
    document.getElementById('ready-button').innerHTML = `
        <button class="btn btn-primary me-2" onclick="cleanupAndRedirect('{{ url_for('friend_fight.choose_fight') }}')">
            <i class="fas fa-redo me-2"></i>å†ä¾†ä¸€æˆ°
        </button>
        <button class="btn btn-success me-2" onclick="cleanupAndRedirect('{{ url_for('main.home') }}')">
            <i class="fas fa-home me-2"></i>è¿”å›ä¸»é 
        </button>
        <div class="mt-3">
            <div class="alert alert-warning" id="countdown-alert">
                <i class="fas fa-clock me-2"></i>
                <span id="countdown-text">10ç§’å¾Œè‡ªå‹•è¿”å›ä¸»é ä¸¦æ¸…ç†æˆ¿é–“...</span>
            </div>
        </div>
    `;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startCountdown();
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('status-message');
    const statusText = document.getElementById('status-text');
    
    statusDiv.className = `alert alert-${type} mt-3`;
    statusText.textContent = message;
    statusDiv.style.display = 'block';
}

let countdownTimer = null;

function startCountdown() {
    let seconds = 10;
    const countdownText = document.getElementById('countdown-text');
    
    countdownTimer = setInterval(() => {
        seconds--;
        if (countdownText) {
            countdownText.textContent = `${seconds}ç§’å¾Œè‡ªå‹•è¿”å›ä¸»é ä¸¦æ¸…ç†æˆ¿é–“...`;
        }
        
        if (seconds <= 0) {
            clearInterval(countdownTimer);
            // è‡ªå‹•åŸ·è¡Œæˆ¿é–“æ¸…ç†ä¸¦è·³è½‰
            cleanupAndRedirect('{{ url_for("main.home") }}');
        }
    }, 1000);
}

function cleanupAndRedirect(url) {
    // æ¸…é™¤å€’æ•¸è¨ˆæ™‚å™¨
    if (countdownTimer) {
        clearInterval(countdownTimer);
    }
    
    // æˆ¿ä¸»è² è²¬æ¸…ç†æˆ¿é–“
    deleteRoom().then(() => {
        window.location.href = url;
    }).catch(error => {
        console.error('æ¸…ç†æˆ¿é–“å¤±æ•—:', error);
        // å³ä½¿æ¸…ç†å¤±æ•—ä¹Ÿè¦è·³è½‰ï¼Œé¿å…ç”¨æˆ¶å¡ä½
        window.location.href = url;
    });
}

function deleteRoom() {
    if (!roomId) {
        return Promise.resolve();
    }
    
    return fetch(`{{ url_for("friend_fight.delete_room", room_id="ROOM_ID") }}`.replace('ROOM_ID', roomId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('æˆ¿é–“å·²æˆåŠŸæ¸…ç†');
        } else {
            console.warn('æˆ¿é–“æ¸…ç†å¤±æ•—:', data.message);
        }
        return data;
    });
}

function goBackWithCleanup() {
    // å¦‚æœå·²ç¶“å‰µå»ºäº†æˆ¿é–“ï¼Œå…ˆæ¸…ç†å†è¿”å›
    if (roomId) {
        showStatus('æ­£åœ¨æ¸…ç†æˆ¿é–“...', 'info');
        deleteRoom().then(() => {
            window.location.href = '{{ url_for("friend_fight.choose_fight") }}';
        }).catch(error => {
            console.error('æ¸…ç†æˆ¿é–“å¤±æ•—:', error);
            // å³ä½¿æ¸…ç†å¤±æ•—ä¹Ÿè¦è¿”å›
            window.location.href = '{{ url_for("friend_fight.choose_fight") }}';
        });
    } else {
        // æ²’æœ‰å‰µå»ºæˆ¿é–“ï¼Œç›´æ¥è¿”å›
        window.location.href = '{{ url_for("friend_fight.choose_fight") }}';
    }
}

// é é¢å¸è¼‰æ™‚æ¸…ç†
window.addEventListener('beforeunload', function() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
    
    // å¦‚æœæˆ¿é–“é‚„åœ¨ç­‰å¾…ç‹€æ…‹ä¸”æˆ¿é–“IDå­˜åœ¨ï¼Œæ¸…ç†æˆ¿é–“
    if (roomId && currentRoomData && currentRoomData.status === 'waiting') {
        // ä½¿ç”¨ navigator.sendBeacon é€²è¡Œç•°æ­¥æ¸…ç†ï¼Œä¸é˜»å¡é é¢å¸è¼‰
        const deleteUrl = `{{ url_for("friend_fight.delete_room", room_id="ROOM_ID") }}`.replace('ROOM_ID', roomId);
        navigator.sendBeacon(deleteUrl);
    }
});
</script>
{% endblock %}
