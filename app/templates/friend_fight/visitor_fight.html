{% extends "base.html" %}

{% block title %}å°æˆ°æˆ¿é–“ - ç²¾éˆå…¬è»Š{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-info text-white text-center">
                    <h3><i class="fas fa-fist-raised me-2"></i>å°æˆ°æˆ¿é–“</h3>
                    <p class="mb-0">æˆ¿é–“ID: <strong>{{ room_id }}</strong></p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-5">
                            <h5 class="text-center mb-3">ä½ çš„ç²¾éˆ</h5>
                            <div class="arena-slot visitor-slot" id="visitor-slot">
                                <div id="visitor-creature-display">
                                    <span class="placeholder">
                                        <i class="fas fa-user fa-2x"></i>
                                        <div class="mt-2">ä½ çš„ç²¾éˆ</div>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <div class="vs-indicator">
                                <i class="fas fa-bolt fa-3x text-warning"></i>
                                <div class="text-center mt-2"><strong>VS</strong></div>
                            </div>
                        </div>
                        
                        <div class="col-md-5">
                            <h5 class="text-center mb-3">å°æ‰‹ç²¾éˆ</h5>
                            <div class="arena-slot host-slot" id="host-slot">
                                <div id="host-creature-display">
                                    <span class="placeholder">
                                        <i class="fas fa-user fa-2x"></i>
                                        <div class="mt-2">å°æ‰‹ç²¾éˆ</div>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <div id="status-message" class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="status-text">æ­£åœ¨è¼‰å…¥æˆ¿é–“ä¿¡æ¯...</span>
                        </div>
                          <div id="action-buttons">
                            <button class="btn btn-outline-secondary" onclick="goBackWithCleanup()">
                                <i class="fas fa-arrow-left me-2"></i>è¿”å›
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .arena-slot {
        width: 250px;
        height: 250px;
        background-color: var(--card-bg);
        border: 3px solid var(--border-color);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
        border-radius: 15px;
        transition: all 0.3s ease;
    }
    
    .visitor-slot {
        border-color: var(--primary-color);
    }
    
    .host-slot {
        border-color: var(--danger-color);
    }
    
    .arena-slot img {
        max-height: 200px;
        max-width: 200px;
        border-radius: 10px;
    }
    
    .placeholder {
        color: var(--text-muted);
        text-align: center;
    }
    
    .vs-indicator {
        text-align: center;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .battle-animation {
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    .winner-glow {
        box-shadow: 0 0 20px var(--success-color);
        border-color: var(--success-color) !important;
    }
    
    .loser-fade {
        opacity: 0.5;
        filter: grayscale(50%);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let roomId = '{{ room_id }}';
let userRole = '{{ user_role }}'; // 'host' æˆ– 'visitor'
let statusCheckInterval = null;
let currentRoomData = null;
let countdownTimer = null;

// é é¢è¼‰å…¥æ™‚é–‹å§‹æª¢æŸ¥æˆ¿é–“ç‹€æ…‹
document.addEventListener('DOMContentLoaded', function() {
    console.log('é é¢è¼‰å…¥ï¼Œæˆ¿é–“ID:', roomId, 'ç”¨æˆ¶è§’è‰²:', userRole);
    loadRoomInfo();
    startStatusCheck();
});

function loadRoomInfo() {
    fetch(`{{ url_for("friend_fight.room_status", room_id="ROOM_ID") }}`.replace('ROOM_ID', roomId))
        .then(response => response.json())
        .then(data => {
            if (data.success && data.room_data) {
                currentRoomData = data.room_data;
                updateRoomDisplay(data.room_data);
            } else {
                showStatus('æˆ¿é–“ä¸å­˜åœ¨æˆ–å·²éæœŸ', 'danger');
            }
        })
        .catch(error => {
            console.error('Error loading room info:', error);
            showStatus('è¼‰å…¥æˆ¿é–“ä¿¡æ¯å¤±æ•—', 'danger');
        });
}

function updateRoomDisplay(roomData) {
    // æ›´æ–°æˆ¿ä¸»ç²¾éˆé¡¯ç¤º
    if (roomData.host_creature) {
        document.getElementById('host-creature-display').innerHTML = `
            <img src="${roomData.host_creature.image_url}" alt="${roomData.host_creature.name}">
            <div class="mt-2"><strong>${roomData.host_creature.name}</strong></div>
            <small class="text-muted">${roomData.host_creature.element} | åŠ›é‡: ${roomData.host_creature.power}</small>
        `;
    }
    
    // æ›´æ–°è¨ªå®¢ç²¾éˆé¡¯ç¤ºï¼ˆè‡ªå·±çš„ç²¾éˆï¼‰
    if (roomData.visitor_creature) {
        document.getElementById('visitor-creature-display').innerHTML = `
            <img src="${roomData.visitor_creature.image_url}" alt="${roomData.visitor_creature.name}">
            <div class="mt-2"><strong>${roomData.visitor_creature.name}</strong></div>
            <small class="text-muted">${roomData.visitor_creature.element} | åŠ›é‡: ${roomData.visitor_creature.power}</small>
        `;
    }
    
    // æ ¹æ“šæˆ¿é–“ç‹€æ…‹æ›´æ–°ç•Œé¢
    updateStatusByRoomState(roomData.status, roomData);
}

function updateStatusByRoomState(status, roomData) {
    switch(status) {
        case 'waiting':
            if (userRole === 'host') {
                showStatus('ç­‰å¾…å°æ‰‹åŠ å…¥æˆ¿é–“...', 'info');
            } else {
                showStatus('å·²æˆåŠŸåŠ å…¥æˆ¿é–“ï¼Œç­‰å¾…æˆ¿ä¸»é–‹å§‹æˆ°é¬¥...', 'info');
            }
            break;
            
        case 'ready':
            if (userRole === 'host') {
                showStatus('å°æ‰‹å·²åŠ å…¥ï¼å¯ä»¥é–‹å§‹æˆ°é¬¥äº†', 'success');                // é¡¯ç¤ºé–‹å§‹æˆ°é¬¥æŒ‰éˆ•
                document.getElementById('action-buttons').innerHTML = `
                    <button class="btn btn-success btn-lg me-2" onclick="startBattle()">
                        <i class="fas fa-sword-cross me-2"></i>é–‹å§‹æˆ°é¬¥
                    </button>
                    <button class="btn btn-outline-secondary" onclick="goBackWithCleanup()">
                        <i class="fas fa-arrow-left me-2"></i>è¿”å›
                    </button>
                `;
            } else {
                showStatus('é›™æ–¹éƒ½å·²æº–å‚™å¥½ï¼ç­‰å¾…æˆ¿ä¸»é–‹å§‹æˆ°é¬¥...', 'warning');
            }
            break;
            
        case 'fighting':
            showStatus('æˆ°é¬¥é€²è¡Œä¸­...', 'primary');
            // æ·»åŠ æˆ°é¬¥å‹•ç•«
            document.querySelectorAll('.arena-slot').forEach(slot => {
                slot.classList.add('battle-animation');
            });
            break;
            
        case 'finished':
            clearInterval(statusCheckInterval);
            showBattleResult(roomData.battle_result);
            break;
            
        default:
            showStatus('æˆ¿é–“ç‹€æ…‹æœªçŸ¥', 'secondary');
    }
}

function startStatusCheck() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
    
    statusCheckInterval = setInterval(() => {
        if (roomId) {
            checkRoomStatus();
        }
    }, 2000);
}

function checkRoomStatus() {
    fetch(`{{ url_for("friend_fight.room_status", room_id="ROOM_ID") }}`.replace('ROOM_ID', roomId))
        .then(response => response.json())
        .then(data => {
            if (data.success && data.room_data) {
                currentRoomData = data.room_data;
                updateStatusByRoomState(data.room_data.status, data.room_data);
                
                // å¦‚æœæˆ¿é–“ç‹€æ…‹æœ‰è®ŠåŒ–ï¼Œæ›´æ–°é¡¯ç¤º
                if (data.room_data.host_creature || data.room_data.visitor_creature) {
                    updateRoomDisplay(data.room_data);
                }
            } else {
                showStatus('æˆ¿é–“é€£æ¥ä¸­æ–·', 'danger');
                clearInterval(statusCheckInterval);
            }
        })
        .catch(error => {
            console.error('Error checking room status:', error);        });
}

function startBattle() {
    if (userRole !== 'host') {
        showStatus('åªæœ‰æˆ¿ä¸»å¯ä»¥é–‹å§‹æˆ°é¬¥', 'warning');
        return;
    }
    
    showStatus('æ­£åœ¨é–‹å§‹æˆ°é¬¥...', 'info');
    
    fetch('{{ url_for("friend_fight.start_battle") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            room_id: roomId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('æˆ°é¬¥é–‹å§‹ï¼', 'primary');
            // æˆ°é¬¥çµæœæœƒé€šéæˆ¿é–“ç‹€æ…‹æª¢æŸ¥è‡ªå‹•æ›´æ–°
        } else {
            showStatus('æˆ°é¬¥é–‹å§‹å¤±æ•—ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error starting battle:', error);
        showStatus('æˆ°é¬¥é–‹å§‹æ™‚ç™¼ç”ŸéŒ¯èª¤', 'danger');
    });
}

function showBattleResult(result) {
    // ç§»é™¤æˆ°é¬¥å‹•ç•«
    document.querySelectorAll('.arena-slot').forEach(slot => {
        slot.classList.remove('battle-animation');
    });
    
    let message = '';
    let isWinner = false;
    
    if (result.winner === 'draw') {
        message = `ğŸ¤ å¹³å±€ï¼é›™æ–¹å¯¦åŠ›ç›¸ç•¶ï¼Œé€™æ˜¯ä¸€å ´ç²¾å½©çš„å°æˆ°ï¼`;
        showStatus(message, 'info');
    } else {
        // åˆ¤æ–·ç•¶å‰ç”¨æˆ¶æ˜¯å¦ç²å‹
        // userRole: 'host' æˆ– 'visitor'
        // result.winner: 'host' æˆ– 'visitor'
        isWinner = (userRole === result.winner);
        
        if (isWinner) {
            message = `ğŸ‰ æ­å–œç²å‹ï¼ä½ çš„ ${result.winner_name} æ“Šæ•—äº†å°æ‰‹çš„ ${result.loser_name}ï¼`;
            showStatus(message, 'success');
        } else {
            message = `ğŸ˜¢ å¾ˆéºæ†¾è½æ•—ï¼å°æ‰‹çš„ ${result.winner_name} æ“Šæ•—äº†ä½ çš„ ${result.loser_name}ã€‚`;
            showStatus(message, 'danger');
        }
        
        // æ·»åŠ è¦–è¦ºæ•ˆæœ
        if (userRole === 'host') {
            if (isWinner) {
                document.getElementById('visitor-slot').classList.add('winner-glow');
                document.getElementById('host-slot').classList.add('loser-fade');
            } else {
                document.getElementById('host-slot').classList.add('winner-glow');
                document.getElementById('visitor-slot').classList.add('loser-fade');
            }
        } else {
            if (isWinner) {
                document.getElementById('visitor-slot').classList.add('winner-glow');
                document.getElementById('host-slot').classList.add('loser-fade');
            } else {
                document.getElementById('host-slot').classList.add('winner-glow');
                document.getElementById('visitor-slot').classList.add('loser-fade');
            }
        }
    }      // æ›´æ–°æŒ‰éˆ•
    document.getElementById('action-buttons').innerHTML = `
        <button class="btn btn-primary me-2" onclick="cleanupAndRedirect('{{ url_for('friend_fight.choose_fight') }}')">
            <i class="fas fa-redo me-2"></i>å†ä¾†ä¸€æˆ°
        </button>
        <button class="btn btn-success me-2" onclick="cleanupAndRedirect('{{ url_for('main.home') }}')">
            <i class="fas fa-home me-2"></i>è¿”å›ä¸»é 
        </button>
        <div class="mt-3">
            <div class="alert alert-warning" id="countdown-alert">
                <i class="fas fa-clock me-2"></i>
                <span id="countdown-text">10ç§’å¾Œè‡ªå‹•è¿”å›ä¸»é ä¸¦æ¸…ç†æˆ¿é–“...</span>
            </div>
        </div>    `;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startCountdown();
}

function startCountdown() {
    let seconds = 10;
    countdownTimer = setInterval(() => {
        const countdownText = document.getElementById('countdown-text');
        if (countdownText) {
            countdownText.textContent = `${seconds}ç§’å¾Œè‡ªå‹•è¿”å›ä¸»é ä¸¦æ¸…ç†æˆ¿é–“...`;
        }
        
        seconds--;
        
        if (seconds < 0) {
            clearInterval(countdownTimer);
            // è‡ªå‹•åŸ·è¡Œæ¸…ç†ä¸¦è·³è½‰
            cleanupAndRedirect('{{ url_for("main.home") }}');
        }
    }, 1000);
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('status-message');
    const statusText = document.getElementById('status-text');
    
    statusDiv.className = `alert alert-${type}`;
    statusText.textContent = message;
}

function cleanupAndRedirect(url) {
    // æ¸…é™¤å€’æ•¸è¨ˆæ™‚å™¨
    if (countdownTimer) {
        clearInterval(countdownTimer);
    }
    
    // åªæœ‰æˆ¿ä¸»æ‰èƒ½åˆªé™¤æˆ¿é–“ï¼Œé¿å…é‡è¤‡åˆªé™¤
    if (userRole === 'host') {
        deleteRoom().then(() => {
            window.location.href = url;
        }).catch(error => {
            console.error('æ¸…ç†æˆ¿é–“å¤±æ•—:', error);
            // å³ä½¿æ¸…ç†å¤±æ•—ä¹Ÿè¦è·³è½‰ï¼Œé¿å…ç”¨æˆ¶å¡ä½
            window.location.href = url;
        });
    } else {
        // è¨ªå®¢ç›´æ¥è·³è½‰
        window.location.href = url;
    }
}

function deleteRoom() {
    return fetch(`{{ url_for("friend_fight.delete_room", room_id="ROOM_ID") }}`.replace('ROOM_ID', roomId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('æˆ¿é–“å·²æˆåŠŸæ¸…ç†');
        } else {
            console.warn('æˆ¿é–“æ¸…ç†å¤±æ•—:', data.message);
        }
        return data;
    });
}

function goBackWithCleanup() {
    // æ¸…é™¤å€’æ•¸è¨ˆæ™‚å™¨
    if (countdownTimer) {
        clearInterval(countdownTimer);
    }
    
    // åªæœ‰æˆ¿ä¸»æ‰èƒ½åˆªé™¤æˆ¿é–“
    if (userRole === 'host') {
        showStatus('æ­£åœ¨æ¸…ç†æˆ¿é–“...', 'info');
        deleteRoom().then(() => {
            window.location.href = '{{ url_for("friend_fight.choose_fight") }}';
        }).catch(error => {
            console.error('æ¸…ç†æˆ¿é–“å¤±æ•—:', error);
            // å³ä½¿æ¸…ç†å¤±æ•—ä¹Ÿè¦è¿”å›
            window.location.href = '{{ url_for("friend_fight.choose_fight") }}';
        });
    } else {
        // è¨ªå®¢ç›´æ¥è¿”å›
        window.location.href = '{{ url_for("friend_fight.choose_fight") }}';
    }
}

// é é¢å¸è¼‰æ™‚æ¸…ç†
window.addEventListener('beforeunload', function() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
    
    // é é¢é›¢é–‹æ™‚ä¹Ÿå˜—è©¦æ¸…ç†æˆ¿é–“ï¼ˆåªæœ‰æˆ¿ä¸»åŸ·è¡Œï¼‰
    if (userRole === 'host' && roomId) {
        // ä½¿ç”¨ navigator.sendBeacon é€²è¡Œç•°æ­¥æ¸…ç†ï¼Œä¸é˜»å¡é é¢å¸è¼‰
        const deleteUrl = `{{ url_for("friend_fight.delete_room", room_id="ROOM_ID") }}`.replace('ROOM_ID', roomId);
        navigator.sendBeacon(deleteUrl);
    }
});
</script>
{% endblock %}
