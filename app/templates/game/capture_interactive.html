{% extends 'base.html' %}

{% block title %}精靈捕捉 - 互動{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/game/capture_interactive.css') }}">
<style>
  /* 優化排版，調整 CSS 和 HTML 結構以避免元素重疊 */  /* 主題設定：確保深色背景在所有模式下 */
  body {
    background-color: #121212 !important;
    color: rgba(255, 255, 255, 0.87);
  }
  
  /* 覆蓋基礎模板的背景 */
  body.game-background {
    background-color: #121212 !important;
  }
  
  body.game-background::before {
    display: none !important;
  }
  
  body.light-theme {
    background-color: #121212 !important;
    color: rgba(255, 255, 255, 0.87);
  }
  
  body.dark-theme {
    background-color: #121212 !important;
    color: rgba(255, 255, 255, 0.87);
  }
  
  /* 背景上下跳動動畫 */
  @keyframes backgroundFloat {
    0%, 100% { background-position: center 0px; }
    50% { background-position: center -10px; }
  }  /* CSS 調整：新增一些間距和對齊樣式 */  
  .capture-container {
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
    max-width: 100%;
    margin: 0 auto;
    position: relative;
    z-index: 1;
    min-height: 100vh;
    background-image: url("{{ url_for('static', filename='img/catch_background.jpg') }}");
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    animation: backgroundFloat 6s ease-in-out infinite;
  }
  
  /* 確保背景圖片可見 */
  .container-fluid {
    background: transparent !important;
  }
  
  /* 響應式設計 */
  @media (max-width: 768px) {
    .capture-container {
      padding: 10px;
      gap: 10px;
    }
  }
  /* 魔法陣選擇樣式 */  
  .circle-selection-container {
    width: 100%;
    max-width: 600px;
    background-color: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(10px);
  }
  
  @media (max-width: 768px) {
    .circle-selection-container {
      max-width: 95%;
      padding: 15px;
      border-radius: 12px;
    }
  }

  .circle-types {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
  }
  
  @media (max-width: 768px) {
    .circle-types {
      gap: 8px;
    }
  }
  .circle-type-item {
    width: calc(33.333% - 10px);
    min-width: 140px;
    background-color: #f8f9fa;
    border-radius: 12px;
    padding: 12px 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    position: relative;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  @media (max-width: 768px) {
    .circle-type-item {
      width: calc(50% - 6px);
      min-width: 120px;
      padding: 10px 6px;
    }
  }
  
  @media (max-width: 480px) {
    .circle-type-item {
      width: 100%;
      max-width: 200px;
      margin: 0 auto;
    }
  }

  .circle-type-item.disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .circle-type-item:hover:not(.disabled) {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .circle-type-item.active {
    border-color: #4CAF50;
    background-color: rgba(76, 175, 80, 0.1);
  }

  .circle-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    padding: 5px;
  }

  .circle-icon img {
    max-width: 100%;
    max-height: 100%;
  }

  .normal-circle {
    background-color: rgba(104, 159, 56, 0.3);
    border: 2px solid rgba(104, 159, 56, 0.7);
  }

  .advanced-circle {
    background-color: rgba(3, 169, 244, 0.3);
    border: 2px solid rgba(3, 169, 244, 0.7);
  }  .premium-circle {
    background-color: rgba(220, 53, 69, 0.4);
    border: 2px solid rgba(220, 53, 69, 0.9);
    box-shadow: 0 0 15px rgba(220, 53, 69, 0.5), inset 0 0 10px rgba(220, 53, 69, 0.3);
  }

  .circle-name {
    font-weight: 700;
    margin-bottom: 2px;
    font-size: 0.95rem;
    color: #2c3e50;
  }

  .circle-rate {
    color: #d35400;
    font-size: 0.85rem;
    font-weight: 700;
    margin-bottom: 2px;
  }

  .circle-count {
    font-size: 0.85rem;
    color: #34495e;
    font-weight: 600;
  }  .magic-container {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 20px auto;
    display: flex;
    justify-content: center;
    align-items: center;
    background: transparent !important;
  }
  
  @media (max-width: 768px) {
    .magic-container {
      width: 250px;
      height: 250px;
      margin: 15px auto;
    }
  }
  
  @media (max-width: 480px) {
    .magic-container {
      width: 200px;
      height: 200px;
      margin: 10px auto;
    }
  }  .creature-image {
    max-width: 350px;
    margin: 0 auto;
    display: block;
    position: relative;
    z-index: 20; /* 較高的 z-index 確保圖片在魔法陣上方 */
    animation: creatureFloat 4s ease-in-out infinite;
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
  }
  
  /* 精靈上下跳動動畫 */
  @keyframes creatureFloat {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-15px); }
  }
    @media (max-width: 768px) {
    .creature-image {
      max-width: 280px;
    }
  }
  
  @media (max-width: 480px) {
    .creature-image {
      max-width: 220px;
    }
  }
  
  .creature-info {
    margin-top: 20px;
    text-align: center;
  }
  .creature-stats {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 15px;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 15px;
    padding: 20px 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(5px);
  }
  
  @media (max-width: 768px) {
    .creature-stats {
      gap: 15px;
      padding: 15px 10px;
      border-radius: 12px;
    }
  }
  
  @media (max-width: 480px) {
    .creature-stats {
      gap: 10px;
      padding: 12px 8px;
      flex-wrap: wrap;
    }
  }

  .stat-item {
    text-align: center;
    min-width: 80px;
    flex: 1;
  }
  
  @media (max-width: 480px) {
    .stat-item {
      min-width: calc(50% - 5px);
      margin-bottom: 10px;
    }
  }

  .stat-item .value {
    font-size: 1.5rem;
    margin-bottom: 5px;
  }
  
  @media (max-width: 768px) {
    .stat-item .value {
      font-size: 1.3rem;
    }
  }
  
  @media (max-width: 480px) {
    .stat-item .value {
      font-size: 1.2rem;
    }
  }

  .stat-item .label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  @media (max-width: 480px) {
    .stat-item .label {
      font-size: 0.8rem;
    }
  }  .action-buttons {
    margin-top: 25px;
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
    width: 100%;
    padding: 0 20px;
  }
  
  /* 取消按鈕樣式修正 */
  #cancelBtn {
    color: #000 !important;
    border-color: #000 !important;
    background-color: rgba(255, 255, 255, 0.9) !important;
  }
  
  #cancelBtn:hover {
    color: #fff !important;
    background-color: #000 !important;
    border-color: #000 !important;
  }
  
  @media (max-width: 768px) {
    .action-buttons {
      gap: 12px;
      padding: 0 15px;
    }
  }
  
  @media (max-width: 480px) {
    .action-buttons {
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 0 10px;
    }
    
    .action-buttons .btn {
      width: 100%;
      max-width: 280px;
    }
  }

  /* 調整模態框內容的間距 */
  .modal-body {
    padding: 20px;
  }

  .creature-detail .card {
    margin-top: 20px;
  }
    /* 魔法陣樣式 */
  .magic-circle {
    position: absolute;
    width: 250px;
    height: 250px;
    background-size: cover;
    background-position: center;
    opacity: 0;
    transform: scale(0.8);
    transition: all 1s ease;
    z-index: 10;
    border-radius: 50%;
    overflow: hidden;
  }
  
  .magic-circle.active {
    opacity: 0.8;
    transform: scale(1) rotate(180deg);
  }
  
  .magic-circle.premium.active {
    opacity: 0.9;
  }
    .magic-circle-inner {
    position: absolute;
    width: 150px;
    height: 150px;
    background-size: cover;
    background-position: center;
    opacity: 0;
    transform: scale(0.8);
    transition: all 1s ease;
    z-index: 11;
    border-radius: 50%;
    overflow: hidden;
  }
  
  .magic-circle-inner.active {
    opacity: 0.7;
    transform: scale(1) rotate(-90deg);
  }
  
  .magic-circle-inner.premium.active {
    opacity: 0.85;
  }
  
  /* 不同等級魔法陣內圈樣式 */
  .magic-circle-inner.normal {
    filter: hue-rotate(90deg);
  }
  
  .magic-circle-inner.advanced {
    filter: hue-rotate(180deg);
  }  .magic-circle-inner.premium {
    filter: hue-rotate(320deg) saturate(1.5) brightness(1.1);
    box-shadow: 0 0 20px rgba(220, 53, 69, 0.8), 0 0 40px rgba(220, 53, 69, 0.4);
  }
  
  /* 不同等級魔法陣樣式 */
  .magic-circle.normal {
    filter: hue-rotate(90deg);
  }
  
  .magic-circle.advanced {
    filter: hue-rotate(180deg);
  }
  
  .magic-circle.premium {
    filter: hue-rotate(320deg) saturate(1.5) brightness(1.1);
    box-shadow: 0 0 30px rgba(220, 53, 69, 0.6), 0 0 60px rgba(220, 53, 69, 0.3);
  }
  
  .capture-effect {
    position: absolute;
    width: 0;
    height: 0;
    background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
    border-radius: 50%;
    opacity: 0;
    transition: all 0.5s ease;
    z-index: 9;
  }
  
  .capture-effect.active {
    width: 300px;
    height: 300px;
    opacity: 1;
  }
  
  .result-message {
    position: absolute;
    font-size: 1.8rem;
    font-weight: bold;
    color: #2ecc71;
    text-shadow: 0 0 15px rgba(255,255,255,0.9), 0 2px 5px rgba(0,0,0,0.2);
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.5s ease;
    z-index: 30;
  }
    
  .result-message.visible {
    opacity: 1;
    transform: scale(1);
  }
  
  .result-message.success {
    color: #2ecc71;
  }
  
  .result-message.failure {
    color: #e74c3c;
  }
  
  .creature-image.captured {
    animation: capture-animation 1s forwards;
  }
  
  /* 不同類型魔法粒子 */
  .magic-particle {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.6);
    pointer-events: none;
    opacity: 0;
    z-index: 8;
  }
  
  .magic-particle.normal {
    background-color: rgba(104, 159, 56, 0.6);
    box-shadow: 0 0 10px rgba(104, 159, 56, 0.8);
  }
  
  .magic-particle.advanced {
    background-color: rgba(3, 169, 244, 0.6);
    box-shadow: 0 0 10px rgba(3, 169, 244, 0.8);
  }
    .magic-particle.premium {
    background-color: rgba(220, 53, 69, 0.6);
    box-shadow: 0 0 15px rgba(220, 53, 69, 0.8);
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  /* 模態框樣式優化 */
  .modal-content {
    border: none;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  
  .modal-header.bg-success {
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%) !important;
  }
  
  .modal-header.bg-danger {
    background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%) !important;
  }
  
  .stat-box {
    padding: 10px 15px;
    border-radius: 8px;
    background-color: rgba(255,255,255,0.6);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    min-width: 80px;
  }
  
  #continueButton {
    background-color: #16a085;
    border-color: #16a085;
    padding: 10px 25px;
    font-weight: 600;
    border-radius: 30px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }
  
  #continueButton:hover {
    background-color: #138a72;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
  }
  
  @keyframes float {
    from { transform: translateY(0) translateX(0); }
    to { transform: translateY(-30px) translateX(10px); }
  }
    @keyframes capture-animation {
    0% { 
      transform: scale(1) translateY(0px); 
      opacity: 1; 
      animation: creatureFloat 4s ease-in-out infinite;
    }
    50% { 
      transform: scale(0.5) translateY(-7px); 
      opacity: 0.7; 
    }
    100% { 
      transform: scale(0) translateY(0px); 
      opacity: 0; 
    }
  }
  
  /* 煙花效果樣式 */
  .firework-particle {
    position: absolute;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.8);
    z-index: 100;
    pointer-events: none;
  }
  
  @keyframes fireworkFade {
    0% { opacity: 1; }
    100% { opacity: 0; }
  }
    @keyframes fireworkMove {
    0% { transform: translate(0, 0) scale(1); }
    100% { transform: translate(var(--tx), var(--ty)) scale(0.3); }
  }
  
  /* 稀有度徽章樣式 */
  .rarity-badge {
    font-weight: 700 !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  
  .rarity-ssr {
    background: linear-gradient(135deg, #ff6b6b, #ee5a24) !important;
    box-shadow: 0 0 15px rgba(238, 90, 36, 0.5);
  }
  
  .rarity-sr {
    background: linear-gradient(135deg, #a29bfe, #6c5ce7) !important;
    box-shadow: 0 0 10px rgba(108, 92, 231, 0.5);
  }
  
  .rarity-r {
    background: linear-gradient(135deg, #74b9ff, #0984e3) !important;
    box-shadow: 0 0 8px rgba(9, 132, 227, 0.5);
  }
    .rarity-n {
    background: linear-gradient(135deg, #636e72, #2d3436) !important;
  }
    /* 屬性類型顏色樣式 */
  .type-fire { color: #e74c3c !important; }
  .type-water { color: #3498db !important; }
  .type-wood { color: #27ae60 !important; }  .type-normal { color: #95a5a6 !important; }
  .type-dark { color: #2c3e50 !important; }
  .type-light { color: #f1c40f !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">  <div class="capture-container">

    <!-- 魔法陣等級選擇 -->
    <div class="circle-selection-container mb-3">
      <h5 class="text-center mb-2" style="color: #16a085; font-weight: 700; text-shadow: 0 1px 1px rgba(0,0,0,0.1);">選擇魔法陣等級</h5>
      <div class="circle-type-info text-center mb-2">
        <small style="color: #7f8c8d;">不同等級的魔法陣有不同的捕捉成功率</small>
      </div>      <div class="circle-types">
        <div class="circle-type-item" data-type="normal">
          <div class="circle-icon normal-circle">
            <img src="{{ url_for('static', filename='img/circles/normal/magic-circle-inner.png') }}" alt="普通魔法陣">
          </div>
          <div class="circle-info">
            <div class="circle-name">普通魔法陣</div>
            <div class="circle-rate">成功率：60%</div>
            <div class="circle-count">剩餘：<span id="normalCount">∞</span> 個</div>
          </div>
        </div>
        <div class="circle-type-item" data-type="advanced">
          <div class="circle-icon advanced-circle">
            <img src="{{ url_for('static', filename='img/circles/advanced/magic-circle-inner.png') }}" alt="進階魔法陣">
          </div>
          <div class="circle-info">
            <div class="circle-name">進階魔法陣</div>
            <div class="circle-rate">成功率：80%</div>
            <div class="circle-count">剩餘：<span id="advancedCount">5</span> 個</div>
          </div>
        </div>
        <div class="circle-type-item active" data-type="premium">
          <div class="circle-icon premium-circle">
            <img src="{{ url_for('static', filename='img/circles/premium/magic-circle-inner.png') }}" alt="高級魔法陣">
          </div>
          <div class="circle-info">
            <div class="circle-name">高級魔法陣</div>
            <div class="circle-rate">成功率：95%</div>
            <div class="circle-count">剩餘：<span id="premiumCount">3</span> 個</div>
          </div>
        </div>
      </div>
    </div>    <div class="magic-container">
      <div class="magic-circle" id="magicCircle" style="display: none;"></div>
      <div class="magic-circle-inner" id="magicCircleInner" style="display: none;"></div>
      
      <!-- 將圖片放入魔法陣容器內 -->
      <img src="{{ creature.image_url }}" alt="{{ creature.name }}" class="creature-image" id="creatureImage">
      
      <!-- 添加捕捉特效元素 -->
      <div class="capture-effect" id="captureEffect"></div>
      <div class="result-message" id="resultMessage"></div>
    </div>    <div class="creature-info">
      <h3 class="text-center mb-3" style="color: #2c3e50; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
        {{ creature.name }} 
        <span class="badge rarity-badge rarity-{{ creature.rate.lower() if creature.rate else 'n' }}">
          {{ creature.rate if creature.rate else 'N' }}
        </span>
      </h3>
      <div class="creature-stats">
        <div class="stat-item">
          <div class="value" style="color: #e74c3c; font-weight: 700;">{{ creature.attack }}</div>
          <div class="label" style="font-weight: 600;">攻擊</div>
        </div>
        <div class="stat-item">
          <div class="value" style="color: #27ae60; font-weight: 700;">{{ creature.hp }}</div>
          <div class="label" style="font-weight: 600;">生命</div>
        </div>        <div class="stat-item">
          <div class="value type-{{ creature.type if creature.type else 'normal' }}" style="font-weight: 700; font-size: 1.5rem;">{{ element_types[creature.type] if creature.type in element_types else creature.type }}</div>
          <div class="label" style="font-weight: 600;">屬性</div>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-lg btn-success" id="captureBtn" style="font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <i class="fas fa-magic me-2"></i>開始捕捉
      </button>
      <button class="btn btn-lg btn-outline-dark" id="cancelBtn" style="font-weight: 600; color: #000 !important; border-color: #000 !important;">取消</button>
    </div>
  </div>
</div>

<!-- 捕捉結果模態框 -->
<div class="modal fade" id="captureResultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">      <div class="modal-header" id="resultModalHeader">
        <h5 class="modal-title" id="resultModalTitle">捕捉結果</h5>
      </div><div class="modal-body text-center">        <div id="resultContent">
          <img id="resultImage" src="{{ creature.image_url }}" alt="{{ creature.name }}" class="mb-3" style="max-width: 200px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); background: transparent !important;">
          <h4 id="resultText" style="font-weight: 700; text-shadow: 0 1px 1px rgba(0,0,0,0.1);">捕捉成功！</h4>
          <p id="resultDescription" style="font-size: 1.1rem; color: #bdc3c7;">恭喜您捕捉到了{{ creature.name }}！</p>
          
          <div class="creature-detail mt-4">
            <div class="row justify-content-center">
              <div class="col-md-10">                <div class="card" style="border-radius: 15px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.2);">                  <div class="card-header text-white" style="background: linear-gradient(135deg, #16a085 0%, #2980b9 100%); padding: 12px;">
                    <h5 class="card-title mb-0" style="font-weight: 700;">
                      {{ creature.name }} 
                      <span class="badge rarity-badge rarity-{{ creature.rate.lower() if creature.rate else 'n' }} ms-2">
                        {{ creature.rate if creature.rate else 'N' }}
                      </span>
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="d-flex justify-content-around mt-2 mb-1">
                      <div class="text-center stat-box">
                        <div class="fw-bold stat-value" style="color: #e74c3c; font-size: 1.4rem;">{{ creature.attack }}</div>
                        <div class="stat-label" style="font-weight: 600; font-size: 0.9rem; text-transform: uppercase;">攻擊</div>
                      </div>
                      <div class="text-center stat-box">
                        <div class="fw-bold stat-value" style="color: #27ae60; font-size: 1.4rem;">{{ creature.hp }}</div>
                        <div class="stat-label" style="font-weight: 600; font-size: 0.9rem; text-transform: uppercase;">生命</div>
                      </div>                      <div class="text-center stat-box">
                        <div class="fw-bold stat-value type-{{ creature.type if creature.type else 'normal' }}" style="font-size: 1.4rem;">{{ element_types[creature.type] if creature.type in element_types else creature.type }}</div>
                        <div class="stat-label" style="font-weight: 600; font-size: 0.9rem; text-transform: uppercase;">屬性</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>      <div class="modal-footer justify-content-center">
        <div class="text-center w-100 mb-2">
          <small class="text-muted">將在 <span id="countdown">5</span> 秒後自動返回地圖</small>
        </div>
        <a href="{{ url_for('game.catch') }}" class="btn btn-primary">返回地圖</a>
        <a href="{{ url_for('main.profile') }}" class="btn btn-outline-secondary">查看我的精靈</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 引入捕捉處理器 JavaScript -->
<script src="{{ url_for('static', filename='js/game/capture-handler.js') }}"></script>
<script>
  // 獲取 CSRF Token
  function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    const creatureId = '{{ creature.id }}';
    const creatureName = '{{ creature.name }}';
    const magicCircle = document.getElementById('magicCircle');
    const magicCircleInner = document.getElementById('magicCircleInner');
    const captureEffect = document.getElementById('captureEffect');
    const creatureImage = document.getElementById('creatureImage');    const captureBtn = document.getElementById('captureBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const resultMessage = document.getElementById('resultMessage');
    const circleTypeItems = document.querySelectorAll('.circle-type-item');
    
    // 魔法陣等級和剩餘數量
    const circleCounts = {
      normal: Infinity,
      advanced: 5,
      premium: 3
    };
    
    // 魔法陣成功率
    const circleRates = {
      normal: 0.6,
      advanced: 0.8,
      premium: 0.95
    };
      // 當前選擇的魔法陣類型
    let selectedCircleType = 'premium';
    
    // 初始化魔法陣背景圖片
    function initializeMagicCircleImages() {
      const circleImagePath = `{{ url_for('static', filename='img/circles/') }}${selectedCircleType}/magic-circle.png`;
      const circleInnerImagePath = `{{ url_for('static', filename='img/circles/') }}${selectedCircleType}/magic-circle-inner.png`;
      
      magicCircle.style.backgroundImage = `url("${circleImagePath}")`;
      magicCircleInner.style.backgroundImage = `url("${circleInnerImagePath}")`;
      magicCircle.className = 'magic-circle ' + selectedCircleType;
      magicCircleInner.className = 'magic-circle-inner ' + selectedCircleType;
    }
    
    // 初始化魔法陣圖片
    initializeMagicCircleImages();
    
    // 更新魔法陣選擇項顯示
    function updateCircleItems() {
      circleTypeItems.forEach(item => {
        const type = item.dataset.type;
        const countElement = item.querySelector('span');
        
        // 更新數量顯示
        if (circleCounts[type] === Infinity) {
          countElement.textContent = '∞';
        } else {
          countElement.textContent = circleCounts[type];
        }
        
        // 禁用沒有剩餘的魔法陣
        if (circleCounts[type] === 0) {
          item.classList.add('disabled');
        } else {
          item.classList.remove('disabled');
        }
      });
    }
      // 初始化魔法陣選擇
    updateCircleItems();
    
    // 設置默認選中的魔法陣
    circleTypeItems.forEach(item => {
      if (item.dataset.type === selectedCircleType) {
        item.classList.add('active');
      }
    });
    
    // 點擊選擇魔法陣
    circleTypeItems.forEach(item => {
      item.addEventListener('click', function() {
        if (this.classList.contains('disabled')) return;
        
        // 移除其他項目的 active 狀態
        circleTypeItems.forEach(i => i.classList.remove('active'));
        
        // 添加當前項目的 active 狀態
        this.classList.add('active');
        
        // 更新選擇的類型
        selectedCircleType = this.dataset.type;        // 更新魔法陣樣式和背景圖片
        magicCircle.className = 'magic-circle ' + selectedCircleType;
        magicCircleInner.className = 'magic-circle-inner ' + selectedCircleType;
        
        // 設置魔法陣背景圖片
        const circleImagePath = `{{ url_for('static', filename='img/circles/') }}${selectedCircleType}/magic-circle.png`;
        const circleInnerImagePath = `{{ url_for('static', filename='img/circles/') }}${selectedCircleType}/magic-circle-inner.png`;
        
        magicCircle.style.backgroundImage = `url("${circleImagePath}")`;
        magicCircleInner.style.backgroundImage = `url("${circleInnerImagePath}")`;
      });
    });
      // 初始隱藏魔法陣
    magicCircle.style.display = 'none';
    magicCircleInner.style.display = 'none';
    
    // 創建粒子效果
    function createParticles() {
      const container = document.querySelector('.capture-container');
      
      for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'magic-particle ' + selectedCircleType;
        
        // 隨機位置
        const x = Math.random() * 100;
        const y = Math.random() * 100;
        
        particle.style.left = `${x}%`;
        particle.style.top = `${y}%`;
        
        // 添加動畫
        const delay = Math.random() * 5;
        const duration = 3 + Math.random() * 3;
        
        particle.style.animation = `
          fadeIn 0.5s ${delay}s forwards,
          float ${duration}s ${delay}s infinite alternate
        `;
        
        container.appendChild(particle);
      }
    }
    
    // 創建煙花效果
    function createFireworks() {
      const container = document.querySelector('.capture-container');
      
      for (let i = 0; i < 50; i++) {
        const firework = document.createElement('div');
        firework.className = 'firework-particle';
        
        // 隨機顏色
        const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        firework.style.backgroundColor = randomColor;
        firework.style.boxShadow = `0 0 8px ${randomColor}`;
        
        // 隨機位置 (中心附近)
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;
        const radius = 150;
        const angle = Math.random() * Math.PI * 2;
        
        const x = centerX + Math.cos(angle) * radius * Math.random();
        const y = centerY + Math.sin(angle) * radius * Math.random();
        
        firework.style.left = `${x}px`;
        firework.style.top = `${y}px`;
        
        // 隨機大小
        const size = 3 + Math.random() * 5;
        firework.style.width = `${size}px`;
        firework.style.height = `${size}px`;
        
        // 隨機飛行方向和距離
        const tx = (Math.random() - 0.5) * 200;
        const ty = (Math.random() - 0.5) * 200;
        const duration = 0.5 + Math.random() * 1.5;
        
        firework.style.animation = `
          fireworkFade ${duration}s forwards,
          fireworkMove ${duration}s forwards
        `;
        
        firework.style.setProperty('--tx', `${tx}px`);
        firework.style.setProperty('--ty', `${ty}px`);
        
        container.appendChild(firework);
        
        // 自動移除煙花粒子
        setTimeout(() => {
          firework.remove();
        }, duration * 1000);
      }
    }
    
    // 開始捕捉
    let captureInProgress = false;
    
    captureBtn.addEventListener('click', function() {
      if (captureInProgress) return;
      
      captureInProgress = true;
      captureBtn.disabled = true;
      cancelBtn.disabled = true;
      
      // 消耗魔法陣
      if (circleCounts[selectedCircleType] !== Infinity) {
        circleCounts[selectedCircleType]--;
        updateCircleItems();
      }
        // 顯示魔法陣並啟動視覺效果
      // 確保魔法陣有正確的背景圖片
      const circleImagePath = `{{ url_for('static', filename='img/circles/') }}${selectedCircleType}/magic-circle.png`;
      const circleInnerImagePath = `{{ url_for('static', filename='img/circles/') }}${selectedCircleType}/magic-circle-inner.png`;
      
      magicCircle.style.backgroundImage = `url("${circleImagePath}")`;
      magicCircleInner.style.backgroundImage = `url("${circleInnerImagePath}")`;
      
      magicCircle.style.display = 'block';
      magicCircleInner.style.display = 'block';
      magicCircle.classList.add('active');
      setTimeout(() => { magicCircleInner.classList.add('active'); }, 500);
      setTimeout(() => { captureEffect.classList.add('active'); }, 1000);
      
      // 創建粒子特效
      createParticles();
      
      // 模擬捕捉成功率
      const successRate = circleRates[selectedCircleType];
      const isSuccess = Math.random() < successRate;
      
      // 執行捕捉 API 請求
      setTimeout(() => {
        if (isSuccess) {
          // 捕捉成功
          resultMessage.textContent = '捕捉成功！';
          resultMessage.classList.add('success', 'visible');
          creatureImage.classList.add('captured');
          createFireworks();
          
          // 使用捕捉處理器處理成功情況
          if (typeof CaptureHandler !== 'undefined') {
            CaptureHandler.captureCreature(creatureId)              .then(result => {
                // 顯示結果模態框
                setTimeout(() => {
                  const modal = new bootstrap.Modal(document.getElementById('captureResultModal'));
                  modal.show();
                  
                  // 5秒後自動跳轉到 /game/catch，並顯示倒數計時
                  let countdown = 5;
                  const countdownElement = document.getElementById('countdown');
                  const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdownElement) {
                      countdownElement.textContent = countdown;
                    }
                    if (countdown <= 0) {
                      clearInterval(countdownInterval);
                      window.location.href = "{{ url_for('game.catch') }}";
                    }
                  }, 1000);
                }, 2000);
              })
              .catch(error => {
                console.error('捕捉請求失敗:', error);
              });
          } else {            // 備用處理
            setTimeout(() => {
              const modal = new bootstrap.Modal(document.getElementById('captureResultModal'));
              modal.show();
              
              // 5秒後自動跳轉到 /game/catch，並顯示倒數計時
              let countdown = 5;
              const countdownElement = document.getElementById('countdown');
              const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownElement) {
                  countdownElement.textContent = countdown;
                }
                if (countdown <= 0) {
                  clearInterval(countdownInterval);
                  window.location.href = "{{ url_for('game.catch') }}";
                }
              }, 1000);
            }, 2000);
          }
        } else {
          // 捕捉失敗
          resultMessage.textContent = '捕捉失敗！';
          resultMessage.classList.add('failure', 'visible');
            setTimeout(() => {
            // 重置界面
            magicCircle.classList.remove('active');
            magicCircleInner.classList.remove('active');
            captureEffect.classList.remove('active');
            resultMessage.classList.remove('visible', 'success', 'failure');
            
            setTimeout(() => {
              magicCircle.style.display = 'none';
              magicCircleInner.style.display = 'none';
              captureBtn.disabled = false;
              cancelBtn.disabled = false;
              captureInProgress = false;
              
              // 清除粒子
              document.querySelectorAll('.magic-particle').forEach(p => p.remove());
              
              // 5秒後自動跳轉到 /game/catch
              setTimeout(() => {
                window.location.href = "{{ url_for('game.catch') }}";
              }, 5000);
            }, 1000);
          }, 2000);
        }
      }, 3000);
    });
    
    // 取得魔法陣類型的中文名稱
    function getCircleTypeName(type) {
      const names = {
        normal: '普通魔法陣',
        advanced: '高級魔法陣',
        premium: '頂級魔法陣'
      };
      return names[type] || type;
    }
      // 取消按鈕
    cancelBtn.addEventListener('click', function() {
      window.history.back();
    });
  });
</script>
{% endblock %}