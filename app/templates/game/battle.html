{% extends 'base.html' %}

{% block title %}站點擂台戰鬥{% endblock %}

{% block extra_css %}
<style>
  /* 響應式基礎樣式 */
  .battle-wrapper {
    background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    background-size: cover;
    background-position: center;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    position: relative;
    min-height: 100vh;
  }
  
  .battle-wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.4));
    z-index: 0;
  }
  
  .battle-content {
    position: relative;
    z-index: 1;
    padding: 15px;
  }
  
  /* 道館頭部 - 響應式設計 */
  .arena-header {
    background-size: cover;
    background-position: center;
    height: 200px;
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    margin-bottom: 20px;
  }
  
  .arena-header:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
  }
  
  .arena-header-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.6));
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    padding: 20px;
    text-align: center;
  }
  
  .arena-header-overlay h2 {
    margin-bottom: 10px;
    font-weight: 700;
    font-size: clamp(1.5rem, 4vw, 2.5rem);
  }
  
  .arena-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    color: #333;
    font-weight: bold;
    font-size: 18px;
    z-index: 2;
    animation: levelPulse 3s infinite;
  }
  
  @keyframes levelPulse {
    0%, 100% {
      transform: scale(1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);    }
    50% {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
  }
  
  /* 道館資訊卡片 - 響應式設計 */
  .arena-info {
    background: rgba(255, 255, 255, 0.98);
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    padding: 25px;
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .arena-owner-status {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    border-radius: 25px;
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 15px;
    transition: all 0.3s ease;
  }
  
  .status-free {
    background: linear-gradient(135deg, #4caf50, #66bb6a);
    color: white;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
  }
  
  .status-occupied {
    background: linear-gradient(135deg, #f44336, #e57373);
    color: white;
    box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
  }
  /* 守護精靈卡片 - 響應式優化 */
  .guardian-card {
    border-radius: 20px;
    overflow: hidden;
    background: white;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
    height: 100%;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  .guardian-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
  }
  
  .guardian-header {
    background: linear-gradient(135deg, #ff5722, #ff9800);
    color: white;
    padding: 20px 15px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  
  .guardian-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
  }
  
  .guardian-header h5 {
    position: relative;
    z-index: 1;
    margin: 0;
    font-weight: 600;
  }
  
  .guardian-img-container {
    height: 150px;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 20px;
    position: relative;
    overflow: hidden;
  }
  
  .guardian-img {
    max-height: 130px;
    max-width: 90%;
    object-fit: contain;
    filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.2));
    animation: guardianFloat 4s ease-in-out infinite;
    transition: all 0.3s ease;
  }
  
  @keyframes guardianFloat {
    0%, 100% {
      transform: translateY(0) rotate(0deg);
    }
    25% {
      transform: translateY(-5px) rotate(1deg);
    }
    50% {
      transform: translateY(-10px) rotate(0deg);
    }
    75% {
      transform: translateY(-5px) rotate(-1deg);
    }
  }
  
  .guardian-img-container::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 30px;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.08), transparent);
  }
    .guardian-stats {
    padding: 20px;
    background: white;
  }
  
  /* 統計項目 - 響應式設計 */
  .stat-item {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }
  
  .stat-item:last-child {
    margin-bottom: 0;
    border-bottom: none;
  }
  
  .stat-item:hover {
    background-color: rgba(0, 0, 0, 0.02);
    border-radius: 8px;
    padding: 8px 12px;
    margin: 0 -12px 12px -12px;
  }
  
  .stat-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 0.9rem;
    color: white;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
  }
  
  .stat-item:hover .stat-icon {
    transform: scale(1.1);
  }
  
  .power-icon {
    background: linear-gradient(135deg, #f44336, #d32f2f);
  }
  
  .type-icon {
    background: linear-gradient(135deg, #2196f3, #1976d2);
  }
  
  .rarity-icon {
    background: linear-gradient(135deg, #ff9800, #f57c00);
  }
  
  .stat-value {
    font-weight: 600;
    color: #333;
    font-size: 0.95rem;
  }
  
  /* 精靈選擇區域 - 響應式優化 */
  .creature-selection {
    background: white;
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    margin-bottom: 20px;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  .creature-selection-header {
    background: linear-gradient(135deg, #2196f3, #1976d2);
    color: white;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }
  
  .creature-selection-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
    z-index: 0;
  }
  
  .creature-selection-header h5 {
    position: relative;
    z-index: 1;
    margin: 0;
    font-weight: 600;
    display: flex;
    align-items: center;
  }
  
  .creature-selection-header h5::before {
    content: '⚔️';
    margin-right: 10px;    font-size: 1.2em;
  }
  
  /* 精靈卡片 - 響應式設計 */
  .creature-card {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    background: white;
    border: 2px solid transparent;
    position: relative;
  }
  
  .creature-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    border-color: rgba(33, 150, 243, 0.3);
  }
  
  .creature-card:active {
    transform: translateY(-4px) scale(1.01);
  }
  
  .creature-selected {
    border-color: #f44336 !important;
    box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4) !important;
    transform: translateY(-5px) scale(1.05);
  }
  
  .creature-selected::before {
    content: '✓';
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: #f44336;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    z-index: 10;
    animation: selectPulse 0.6s ease;
  }
  
  @keyframes selectPulse {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
  }
  
  .creature-image {
    height: 140px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 15px;
    position: relative;
  }
  
  .back-button {
    position: fixed;
    top: 80px;       /* 原本是 20px，改為 80px 避開導覽列 */
    left: 16px;      /* 原本是 20px，改為 16px 更貼近邊緣但不會太擠 */
    z-index: 1050;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .creature-image img {
    max-height: 120px;
    max-width: 100%;
    object-fit: contain;
    transition: all 0.3s ease;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
  }
  
  .creature-card:hover .creature-image img {
    transform: scale(1.1);
    filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.2));
  }
  
  .creature-card-body {
    padding: 16px;
    background: white;
  }
  
  .creature-card-body .card-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .creature-stats {
    font-size: 0.85rem;
    color: #666;
    line-height: 1.4;
  }
  
  /* 按鈕區域 - 響應式設計 */
  .action-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 20px;
  }
  
  .action-btn {
    padding: 14px 24px;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 12px;
    border: none;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    text-transform: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }
  
  .action-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  }
  
  .action-btn:active:not(:disabled) {
    transform: translateY(0);
  }
  
  .action-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }
  
  .btn-occupy {
    background: linear-gradient(135deg, #4caf50, #66bb6a);
    color: white;
  }
  
  .btn-battle {
    background: linear-gradient(135deg, #f44336, #e57373);
    color: white;
  }
  
  .btn-reward {
    background: linear-gradient(135deg, #ff9800, #ffb74d);
    color: white;
  }
  
  /* 獎勵區塊 */
  .reward-block {
    background: white;
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    margin-top: 20px;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  .reward-header {
    background: linear-gradient(135deg, #ff9800, #ffb74d);
    color: white;
    padding: 16px 20px;
    font-weight: 600;
  }
  
  .reward-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  .reward-item:last-child {
    border-bottom: none;
  }
  
  .reward-badge {
    background: linear-gradient(135deg, #2196f3, #64b5f6);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  /* 動畫效果 */
  .battle-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    background-color: rgba(0, 0, 0, 0.9);
    visibility: hidden;
    backdrop-filter: blur(5px);
  }
  
  .battle-animation-content {
    position: relative;
    width: min(90vw, 400px);
    height: min(90vh, 400px);
    display: flex;
    justify-content: center;
    align-items: center;
    perspective: 1000px;
  }
  
  .battle-flash {
    position: absolute;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
    opacity: 0;
    border-radius: 50%;
    z-index: 1;
    animation: flashPulse 0.5s ease;
  }
  
  @keyframes flashPulse {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 0; }
  }
  
  .challenger-img, .defender-img {
    position: absolute;
    width: clamp(80px, 20vw, 120px);
    height: clamp(80px, 20vw, 120px);
    object-fit: contain;
    z-index: 2;
    filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.7));
    border-radius: 15px;
    background: rgba(255, 255, 255, 0.1);
    padding: 10px;
  }
  
  .challenger-img {
    left: 20%;
    transform: translateX(-50%);
  }
  
  .defender-img {
    right: 20%;
    transform: translateX(50%);
  }
  
  .vs-text {
    position: absolute;
    font-size: clamp(3rem, 10vw, 6rem);
    font-weight: bold;
    color: white;
    text-shadow: 0 0 30px rgba(255, 152, 0, 0.9);
    z-index: 3;
    opacity: 0;
    animation: vsGlow 1s infinite alternate;
  }
  
  @keyframes vsGlow {
    from { text-shadow: 0 0 20px rgba(255, 152, 0, 0.8); }
    to { text-shadow: 0 0 40px rgba(255, 152, 0, 1), 0 0 60px rgba(255, 152, 0, 0.8); }
  }
  
  .result-text {
    position: absolute;
    font-size: clamp(2rem, 8vw, 4rem);
    font-weight: bold;
    text-shadow: 0 0 30px rgba(255, 255, 255, 0.9);
    z-index: 3;
    opacity: 0;
    animation: resultPulse 1s ease infinite;
  }
  
  @keyframes resultPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  
  .win-text {
    color: #4caf50;
    text-shadow: 0 0 30px rgba(76, 175, 80, 0.9);
  }
  
  .lose-text {
    color: #f44336;
    text-shadow: 0 0 30px rgba(244, 67, 54, 0.9);
  }
  
  /* 加載覆蓋層優化 */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.9));
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    color: white;
    font-size: clamp(1rem, 3vw, 1.3rem);
    backdrop-filter: blur(10px);
  }
  
  .loading-spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #2196f3;
    border-radius: 50%;
    width: clamp(40px, 10vw, 60px);
    height: clamp(40px, 10vw, 60px);
    animation: loadingSpin 1s linear infinite;
    margin-right: 15px;
  }
  
  @keyframes loadingSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* 觸摸優化 */
  @media (hover: none) and (pointer: coarse) {
    .creature-card:hover {
      transform: none;
    }
    
    .creature-card:active {
      transform: scale(0.98);
    }
    
    .action-btn:hover {
      transform: none;
    }
    
    .action-btn:active {
      transform: scale(0.98);
    }
    
    .guardian-card:hover {
      transform: none;
    }
  }
  
  /* 高對比度模式支援 */
  @media (prefers-contrast: high) {
    .arena-header-overlay {
      background: rgba(0, 0, 0, 0.8);
    }
    
    .creature-card {
      border: 2px solid #000;
    }
    
    .action-btn {
      border: 2px solid currentColor;
    }
  }
  
  /* 減少動畫偏好設定 */
  @media (prefers-reduced-motion: reduce) {
    .guardian-img,
    .creature-card,
    .action-btn,
    .arena-header,
    .battle-animation *,
    .loading-spinner {
      animation: none !important;
      transition: none !important;
    }
    
    .creature-card:hover,
    .action-btn:hover,
    .guardian-card:hover {
      transform: none !important;
    }
  }

  /* 響應式基礎樣式 */
  @media (max-width: 767.98px) {
    .battle-wrapper {
      border-radius: 10px;
    }
    
    .arena-header {
      height: 150px;
    }
    
    .arena-badge {
      width: 40px;
      height: 40px;
      font-size: 16px;
    }
    
    .arena-info {
      padding: 15px;
    }
    
    .guardian-img-container {
      height: 100px;
    }
    
    .guardian-img {
      max-height: 90px;
    }
    
    .creature-image {
      height: 100px;
    }
    
    .creature-image img {
      max-height: 80px;
    }
    
    .battle-button {
      padding: 10px 25px;
      font-size: 1rem;
    }
    
    .fighter-image {
      width: 90px;
      height: 90px;
    }
    
    .vs-container {
      width: 60px;
      margin: 10px auto;
    }
    
    .vs-badge {
      width: 40px;
      height: 40px;
      font-size: 1rem;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
    }
    
    .battle-animation-content {
      width: 250px;
      height: 250px;
    }
    
    .challenger-img, .defender-img {
      width: 90px;
      height: 90px;
    }
    
    .vs-text {
      font-size: 3rem;
    }
    
    .result-text {
      font-size: 2rem;
    }
  }
  
  /* 精靈選擇過濾器樣式 */
  .creature-filter {
    margin-bottom: 20px;
  }
  
  .creature-filter .btn-group {
    width: 100%;
    overflow: hidden;
    border-radius: 10px;
  }
  
  .creature-filter button {
    flex: 1;
    padding: 8px 15px;
    font-weight: 500;
    transition: all 0.2s;
  }
  
  .creature-filter button.active {
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2) inset;
  }
  
  /* 精靈選擇區域調整 */
  .creature-selection .card-body {
    max-height: 400px;
    overflow-y: auto;
  }
  
  /* 深色模式下的過濾按鈕 */
  [data-theme="dark"] .creature-filter button {
    border-color: #4d5656;
    color: #e0e0e0;
  }
  
  [data-theme="dark"] .creature-filter button.active {
    background-color: rgba(255, 255, 255, 0.1);
    color: #ffffff;
  }
  
  /* 定義震動動畫 */
  @keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
  }

  /* 行動裝置響應式設計 */
  @media (max-width: 768px) {
    .battle-content {
      padding: 10px;
    }
    
    .arena-header {
      height: 150px;
      margin-bottom: 15px;
    }
    
    .arena-header-overlay h2 {
      font-size: 1.5rem;
    }
    
    .arena-badge {
      width: 45px;
      height: 45px;
      font-size: 14px;
      top: 10px;
      right: 10px;
    }
    
    .arena-info {
      padding: 20px 15px;
      margin-bottom: 15px;
    }
    
    .guardian-img-container {
      height: 120px;
    }
    
    .guardian-img {
      max-height: 100px;
    }
    
    .creature-selection-header {
      padding: 15px;
    }
    
    .creature-image {
      height: 100px;
    }
    
    .creature-image img {
      max-height: 80px;
    }
    
    .creature-card-body {
      padding: 12px;
    }
    
    .action-btn {
      padding: 12px 20px;
      font-size: 0.95rem;
    }
    
    .stat-item {
      margin-bottom: 8px;
    }
    
    .stat-icon {
      width: 30px;
      height: 30px;
      margin-right: 10px;
    }
  }
  
  @media (max-width: 576px) {
    .container {
      padding-left: 10px;
      padding-right: 10px;
    }
    
    .battle-content {
      padding: 8px;
    }
    
    .arena-header {
      height: 120px;
      border-radius: 15px;
    }
    
    .arena-header-overlay h2 {
      font-size: 1.25rem;
    }
    
    .arena-badge {
      width: 40px;
      height: 40px;
      font-size: 12px;
    }
    
    .arena-info {
      padding: 15px;
    }
    
    .guardian-stats {
      padding: 15px;
    }
    
    .creature-selection-header h5 {
      font-size: 1rem;
    }
    
    .creature-card {
      margin-bottom: 10px;
    }
    
    .creature-image {
      height: 80px;
      padding: 10px;
    }
    
    .creature-image img {
      max-height: 60px;
    }
    
    .creature-card-body {
      padding: 10px;
    }
    
    .creature-card-body .card-title {
      font-size: 0.9rem;
    }
    
    .creature-stats {
      font-size: 0.8rem;
    }
    
    .action-btn {
      padding: 10px 16px;
      font-size: 0.9rem;
    }
    
    .stat-item {
      padding: 6px 0;
    }
    
    .stat-value {
      font-size: 0.85rem;
    }
  }
  
  /* 超小屏幕優化 */
  @media (max-width: 400px) {
    .arena-header-overlay h2 {
      font-size: 1.1rem;
    }
    
    .creature-selection-header h5::before {
      display: none;
    }
    
    .action-btn {
      padding: 8px 12px;
      font-size: 0.85rem;
    }
  }
  
  /* 深色模式適配 */
  @media (prefers-color-scheme: dark) {
    .arena-info {
      background: rgba(45, 52, 54, 0.95);
      color: #e0e0e0;
    }
    
    .guardian-card,
    .creature-selection,
    .reward-block {
      background: #2d3436;
      color: #ddd;
    }
    
    .creature-card {
      background: #636e72;
      color: #ddd;
    }
    
    .creature-card-body {
      background: #636e72;
    }
    
    .stat-value {
      color: #ddd;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-3 mt-2 mt-md-4">
  <div class="battle-wrapper">
    <div class="battle-content">
      <!-- 道館資訊頭部 -->
      <div class="arena-header" id="arenaHeader">
        <div class="arena-header-overlay">
          <h2 id="arenaName">道館名稱</h2>
          <p class="mb-0 opacity-75 d-none d-md-block">挑戰你的極限</p>
          <span class="arena-badge" id="arenaLevelInfo">Lv.1</span>
        </div>
      </div>
      
      <!-- 道館基本資訊 -->
      <div class="arena-info">
        <div class="row align-items-center g-2">
          <div class="col-12 col-md-auto">
            <span id="arenaStatusBadge" class="arena-owner-status status-free">
              <i class="fas fa-unlock me-2"></i> 無人佔領
            </span>
          </div>
          <div class="col-12 col-md">
            <div class="row g-1 text-sm">
              <div class="col-12 col-sm-4">
                <small class="text-muted">擁有者：<strong id="arenaOwner">無</strong></small>
              </div>
              <div class="col-6 col-sm-4">
                <small class="text-muted">等級：<strong id="arenaLevel">1</strong></small>
              </div>
              <div class="col-6 col-sm-4">
                <small class="text-muted">站點：<strong id="arenaStopId">-</strong></small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 主要內容區域 -->
      <div class="row g-3">
        <!-- 守護精靈區域 -->
        <div class="col-12 col-lg-6 order-2 order-lg-1">
          <div id="guardianInfo" class="mb-3">
            <!-- 守護精靈信息將在這裡動態載入 -->
          </div>
          
          <!-- 獎勵區塊 -->
          <div id="arenaRewardBlock" class="reward-block" style="display:none;">
            <div class="reward-header">
              <i class="fas fa-gift me-2"></i>道館獎勵
            </div>
            <div class="p-3" id="arenaRewardList">
              <!-- 獎勵列表將在這裡動態載入 -->
            </div>
          </div>
        </div>
        
        <!-- 精靈選擇和操作區域 -->
        <div class="col-12 col-lg-6 order-1 order-lg-2">
          <!-- 精靈選擇區塊 -->
          <div class="creature-selection">
            <div class="creature-selection-header">
              <h5>選擇你的精靈</h5>
            </div>
            <div class="p-3">
              <div id="creatureList" class="row g-2">
                <!-- 精靈列表將在這裡動態載入 -->
              </div>
            </div>
          </div>
          
          <!-- 操作按鈕區域 -->
          <div class="action-buttons">
            <button id="occupyBtn" class="action-btn btn-occupy" style="display:none;">
              <i class="fas fa-flag me-2"></i>直接佔領道館
            </button>
            <button id="battleBtn" class="action-btn btn-battle" style="display:none;">
              <i class="fas fa-sword me-2"></i>發起挑戰
            </button>
            <button id="collectRewardBtn" class="action-btn btn-reward" style="display:none;">
              <i class="fas fa-gift me-2"></i>領取獎勵
            </button>
          </div>
        </div>
      </div>
      
      <!-- 戰鬥結果顯示 -->
      <div id="battleResult" class="battle-result mt-4" style="display:none;">
        <div class="card border-0 shadow">
          <div id="battleResultHeader" class="card-header border-0">
            <h5 id="battleResultTitle" class="mb-0"></h5>
          </div>
          <div class="card-body">
            <div id="battleResultMessage" class="mb-3"></div>
            <div class="row g-3">
              <div class="col-6">
                <div class="text-center p-3 bg-light rounded-3">
                  <img id="challengerImg" src="" class="img-fluid mb-2" style="max-height:80px;">
                  <div class="fw-bold small" id="challengerName">挑戰者</div>
                  <small class="text-muted" id="challengerPower">ATK: - | HP: -</small>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center p-3 bg-light rounded-3">
                  <img id="defenderImg" src="" class="img-fluid mb-2" style="max-height:80px;">
                  <div class="fw-bold small" id="defenderName">守護者</div>
                  <small class="text-muted" id="defenderPower">ATK: - | HP: -</small>
                  <small class="text-muted d-block" id="defenderOwner">擁有者: -</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <a href="{{ url_for('game.catch') }}" class="btn btn-secondary rounded-circle shadow back-button" title="返回">
      <i class="fas fa-arrow-left"></i>
    </a>
  </div>
  
</div>
<!-- 加載中遮罩 -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-spinner"></div>
  <span>載入中...</span>
</div>
<!-- 戰鬥動畫 -->
<div class="battle-animation" id="battleAnimation">
  <div class="battle-animation-content">
    <img id="animationChallengerImg" class="challenger-img" src="" style="opacity:0;">
    <img id="animationDefenderImg" class="defender-img" src="" style="opacity:0;">
    <div id="vsText" class="vs-text">VS</div>
    <div id="winText" class="result-text win-text">勝利！</div>
    <div id="loseText" class="result-text lose-text">失敗</div>
    <div id="battleFlash" class="battle-flash"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局變數
let arenaData = null;
let battleAnimationTimeout = null;
let userCreatures = [];
let selectedCreature = null;

// 頁面載入完成事件
document.addEventListener('DOMContentLoaded', function() {
  console.log('戰鬥頁面已載入');
  
  // 獲取URL參數
  const urlParams = new URLSearchParams(window.location.search);
  const arenaId = urlParams.get('arena_id');
  
  if (arenaId) {
    // 獲取擂台資料
    fetchArenaById(arenaId);
  } else {
    alert('缺少擂台ID參數，無法顯示擂台資訊');
  }
  
  // 初始化按鈕事件
  initButtonEvents();
});

// 初始化按鈕事件
function initButtonEvents() {
  // 佔領按鈕
  document.getElementById('occupyBtn').addEventListener('click', function() {
    if (!selectedCreature) {
      alert('請先選擇一隻精靈');
      return;
    }
    occupyArena();
  });
  
  // 挑戰按鈕
  document.getElementById('battleBtn').addEventListener('click', function() {
    if (!selectedCreature) {
      alert('請先選擇一隻精靈');
      return;
    }
    battleArena();
  });
  
  // 領取獎勵按鈕
  document.getElementById('collectRewardBtn').addEventListener('click', function() {
    collectRewards();
  });
}

// 安全設置文本內容
function setTextContent(elementId, text) {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = text;
  }
}

// 安全設置HTML內容
function setHTML(elementId, html) {
  const element = document.getElementById(elementId);
  if (element) {
    element.innerHTML = html;
  }
}

// 安全獲取元素
function safeGetElement(elementId) {
  return document.getElementById(elementId);
}

// 顯示/隱藏加載中
function showLoading() {
  const loadingOverlay = document.getElementById('loadingOverlay');
  if (loadingOverlay) {
    loadingOverlay.style.display = 'flex';
  }
}

function hideLoading() {
  const loadingOverlay = document.getElementById('loadingOverlay');
  if (loadingOverlay) {
    loadingOverlay.style.display = 'none';
  }
}

// 設置擂台背景顏色，根據等級而非路線
function setArenaBackground(level) {
  const arenaHeader = document.getElementById('arenaHeader');
  const battleWrapper = document.querySelector('.battle-wrapper');
  
  let bgColor, bgImage;
  
  // 根據等級設置不同的顏色
  switch(level) {
    case 1:
      bgColor = '#4caf50'; // 綠色
      bgImage = 'linear-gradient(rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.3))';
      break;
    case 2:
      bgColor = '#ff9800'; // 橙色
      bgImage = 'linear-gradient(rgba(255, 152, 0, 0.1), rgba(255, 152, 0, 0.3))';
      break;
    case 3:
      bgColor = '#9c27b0'; // 紫色
      bgImage = 'linear-gradient(rgba(156, 39, 176, 0.1), rgba(156, 39, 176, 0.3))';
      break;
    case 4:
      bgColor = '#e91e63'; // 粉紅色
      bgImage = 'linear-gradient(rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.3))';
      break;
    case 5:
      bgColor = '#f44336'; // 紅色
      bgImage = 'linear-gradient(rgba(244, 67, 54, 0.1), rgba(244, 67, 54, 0.3))';
      break;
    default:
      bgColor = '#3f51b5'; // 藍色
      bgImage = 'linear-gradient(rgba(63, 81, 181, 0.1), rgba(63, 81, 181, 0.3))';
  }
  
  if (arenaHeader) {
    arenaHeader.style.backgroundColor = bgColor;
    // 設置道館等級背景圖
    const backgroundImage = `https://placehold.co/1200x300/${bgColor.replace('#', '')}/ffffff?text=等級 ${level} 道館`;
    arenaHeader.style.backgroundImage = `url('${backgroundImage}')`;
  }
  
  if (battleWrapper) {
    battleWrapper.style.backgroundImage = bgImage;
  }
}

// 通過API獲取道館資料
function fetchArenaById(arenaId) {
  console.log('通過API獲取道館:', arenaId);
  showLoading();
  
  fetch(`/game/api/arena-battle/get-arena/${arenaId}`)
    .then(response => response.json())
    .then(data => {
      hideLoading();
      if (data.success) {
        console.log('找到道館:', data.arena);
        arenaData = data.arena;
        updateArenaDisplay(data.arena);
        loadUserCreatures(data.arena.level || 1);
        
        if (data.created) {
          console.log('道館已新建');
        }
      } else {
        console.error('獲取道館失敗:', data.message);
        alert('獲取道館資料失敗: ' + data.message);
      }
    })
    .catch(error => {
      hideLoading();
      console.error('獲取道館錯誤:', error);
      alert('獲取道館資料時發生錯誤');
    });
}

// 載入用戶精靈
function loadUserCreatures(arenaLevel) {
  console.log('載入用戶精靈，道館等級:', arenaLevel);
  
  fetch(`/game/api/arena-battle/get-user-creatures?arena_level=${arenaLevel}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        userCreatures = data.creatures;
        renderCreatureList(userCreatures);
      } else {
        console.error('獲取精靈失敗:', data.message);
        document.getElementById('creatureList').innerHTML = `
          <div class="col-12 text-center py-4">
            <p class="text-danger">載入精靈失敗: ${data.message}</p>
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('載入精靈錯誤:', error);
      document.getElementById('creatureList').innerHTML = `
        <div class="col-12 text-center py-4">
          <p class="text-danger">載入精靈時發生錯誤</p>
        </div>
      `;
    });
}

// 渲染精靈列表
function renderCreatureList(creatures) {
  const creatureList = document.getElementById('creatureList');
  
  if (!creatures || creatures.length === 0) {
    creatureList.innerHTML = `
      <div class="col-12 text-center py-4">
        <p class="text-muted">您目前沒有符合此道館等級要求的精靈</p>
      </div>
    `;
    return;
  }
  
  creatureList.innerHTML = '';
  
  creatures.forEach(creature => {
    const creatureCard = document.createElement('div');
    creatureCard.className = 'col-6 col-md-4 col-lg-3 mb-2';
    
    const attack = creature.attack || creature.power || 100;
    const hp = creature.hp || (creature.power || 100) * 10;
    const rarity = creature.rarity || creature.rate || 'N';
    
    creatureCard.innerHTML = `
      <div class="creature-card" data-creature-id="${creature.id}">
        <div class="creature-image">
          <img src="${creature.image_url || '/static/img/creature.PNG'}" alt="${creature.name}">
        </div>
        <div class="creature-card-body">
          <div class="card-title">${creature.name}</div>
          <small class="text-muted">ATK: ${attack} | HP: ${hp}</small><br>
          <small class="text-muted">稀有度: ${rarity}</small>
        </div>
      </div>
    `;
    
    // 添加點擊事件
    creatureCard.addEventListener('click', function() {
      selectCreature(creature);
    });
    
    creatureList.appendChild(creatureCard);
  });
}

// 選擇精靈
function selectCreature(creature) {
  // 移除之前的選擇
  const previousSelected = document.querySelector('.creature-selected');
  if (previousSelected) {
    previousSelected.classList.remove('creature-selected');
  }
  
  // 添加新選擇
  const creatureCard = document.querySelector(`[data-creature-id="${creature.id}"]`);
  if (creatureCard) {
    creatureCard.classList.add('creature-selected');
  }
  
  selectedCreature = creature;
  console.log('選擇精靈:', creature.name);
  
  // 更新按鈕顯示
  updateButtonDisplay();
}

// 更新擂台顯示
function updateArenaDisplay(arena) {
  console.log('更新道館顯示:', arena);
  
  // 安全地更新元素
  const setTextContent = (id, text) => {
    const element = document.getElementById(id);
    if (element) element.textContent = text;
  };
  
  const setInnerHTML = (id, html) => {
    const element = document.getElementById(id);
    if (element) element.innerHTML = html;
  };
  
  // 更新基本資訊
  setTextContent('arenaName', arena.name || '未知道館');
  setTextContent('arenaLevel', `等級: ${arena.level || 1}`);
  setTextContent('arenaLevelInfo', arena.level || 1);
  setTextContent('arenaStopId', arena.stop_ids ? arena.stop_ids[0] : arena.id);
  
  // 根據等級設置背景顏色
  setArenaBackground(arena.level || 1);
  
  // 更新擂台狀態
  const arenaStatusBadge = document.getElementById('arenaStatusBadge');
  const guardianInfo = document.getElementById('guardianInfo');
  
  if (arena.owner) {
    setTextContent('arenaOwner', arena.owner);
    
    if (arenaStatusBadge) {
      arenaStatusBadge.className = 'arena-owner-status status-occupied';
      arenaStatusBadge.innerHTML = '<i class="fas fa-lock me-1"></i> 已被佔領';
    }
    
    // 顯示守護精靈信息
    if (arena.owner_creature && guardianInfo) {
      const creature = arena.owner_creature;
      const attack = creature.attack || creature.power || 100;
      const hp = creature.hp || (creature.power || 100) * 10;
      
      guardianInfo.innerHTML = `
        <div class="guardian-card">
          <div class="guardian-header">
            <h5 class="mb-0">守護精靈</h5>
          </div>
          <div class="guardian-img-container">
            <img class="guardian-img" src="${creature.image_url || creature.img || '/static/img/creature.PNG'}" alt="${creature.name}">
          </div>
          <div class="guardian-stats">
            <h5 class="mb-3 text-center">${creature.name}</h5>
            <div class="stat-item">
              <div class="stat-icon power-icon">
                <i class="fas fa-fist-raised"></i>
              </div>
              <div class="stat-value">ATK：${attack}</div>
            </div>
            <div class="stat-item">
              <div class="stat-icon power-icon">
                <i class="fas fa-heart"></i>
              </div>
              <div class="stat-value">HP：${hp}</div>
            </div>
            <div class="stat-item">
              <div class="stat-icon type-icon">
                <i class="fas fa-fire-alt"></i>
              </div>
              <div class="stat-value">類型：${creature.type || creature.element_type || '未知'}</div>
            </div>
            <div class="stat-item">
              <div class="stat-icon rarity-icon">
                <i class="fas fa-star"></i>
              </div>
              <div class="stat-value">稀有度：${creature.rarity || creature.rate || 'N'}</div>
            </div>
          </div>
        </div>
      `;
    }
  } else {
    setTextContent('arenaOwner', '無');
    
    if (arenaStatusBadge) {
      arenaStatusBadge.className = 'arena-owner-status status-free';
      arenaStatusBadge.innerHTML = '<i class="fas fa-unlock me-1"></i> 無人佔領';
    }
    
    if (guardianInfo) {
      guardianInfo.innerHTML = `
        <div class="alert alert-success">
          <i class="fas fa-info-circle me-2"></i> 此道館暫無守護精靈，你可以佔領它！
        </div>
      `;
    }
  }
  
  // 更新按鈕顯示
  updateButtonDisplay();
  
  // 更新獎勵顯示
  updateRewardDisplay(arena);
}

// 更新按鈕顯示
function updateButtonDisplay() {
  const occupyBtn = document.getElementById('occupyBtn');
  const battleBtn = document.getElementById('battleBtn');
  const collectRewardBtn = document.getElementById('collectRewardBtn');
  
  if (!arenaData) return;
  
  // 隱藏所有按鈕
  if (occupyBtn) occupyBtn.style.display = 'none';
  if (battleBtn) battleBtn.style.display = 'none';
  if (collectRewardBtn) collectRewardBtn.style.display = 'none';
  
  if (!arenaData.owner) {
    // 無人佔領，顯示佔領按鈕
    if (occupyBtn) occupyBtn.style.display = 'block';
  } else {
    // 已被佔領，顯示挑戰按鈕
    if (battleBtn) battleBtn.style.display = 'block';
    
    // 如果是自己的道館，顯示獎勵按鈕（這裡需要檢查用戶身份）
    // 暫時先顯示，實際需要後端驗證
    if (collectRewardBtn) collectRewardBtn.style.display = 'block';
  }
}

// 更新獎勵顯示
function updateRewardDisplay(arena) {
  const rewardBlock = document.getElementById('arenaRewardBlock');
  const rewardList = document.getElementById('arenaRewardList');
  
  if (!arena.owner || !arena.rewards || !rewardBlock || !rewardList) {
    if (rewardBlock) rewardBlock.style.display = 'none';
    return;
  }
  
  const rewards = arena.rewards;
  
  if (rewards.available_rewards && rewards.available_rewards.length > 0) {
    rewardBlock.style.display = 'block';
    
    let rewardHTML = '';
    rewards.available_rewards.forEach(reward => {
      rewardHTML += `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span>${reward.description}</span>
          <span class="badge bg-primary">${reward.quantity}</span>
        </div>
      `;
    });
    
    rewardList.innerHTML = rewardHTML;
  } else {
    rewardBlock.style.display = 'block';
    rewardList.innerHTML = '<p class="text-muted mb-0">目前沒有可領取的獎勵</p>';
  }
}

// 佔領道館
function occupyArena() {
  if (!selectedCreature || !arenaData) return;
  
  showLoading();
  
  fetch('/game/api/arena-battle/occupy', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      arena_id: arenaData.id,
      creature_id: selectedCreature.id
    })
  })
  .then(response => response.json())
  .then(data => {
    hideLoading();
    if (data.success) {
      alert('成功佔領道館！');
      arenaData = data.arena;
      updateArenaDisplay(data.arena);
    } else {
      alert('佔領失敗: ' + data.message);
    }
  })
  .catch(error => {
    hideLoading();
    console.error('佔領道館錯誤:', error);
    alert('佔領道館時發生錯誤');
  });
}

// 挑戰道館
function battleArena() {
  if (!selectedCreature || !arenaData) return;
  
  showLoading();
  
  fetch('/game/api/arena-battle/battle', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      arena_id: arenaData.id,
      creature_id: selectedCreature.id
    })
  })
  .then(response => response.json())
  .then(data => {
    hideLoading();
    if (data.success) {
      // 播放戰鬥動畫
      const defender = arenaData.owner_creature;
      playBattleAnimation(data.is_win, selectedCreature, defender, () => {
        // 動畫結束後顯示結果
        showBattleResult(data.is_win, data.message, selectedCreature, arenaData);
        
        // 更新道館資料
        if (data.arena) {
          arenaData = data.arena;
          updateArenaDisplay(data.arena);
        }
      });
    } else {
      alert('挑戰失敗: ' + data.message);
    }
  })
  .catch(error => {
    hideLoading();
    console.error('挑戰道館錯誤:', error);
    alert('挑戰道館時發生錯誤');
  });
}

// 領取獎勵
function collectRewards() {
  if (!arenaData) return;
  
  showLoading();
  
  fetch('/game/api/arena-battle/collect-rewards', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      arena_id: arenaData.id
    })
  })
  .then(response => response.json())
  .then(data => {
    hideLoading();
    if (data.success) {
      let message = '成功領取獎勵！\n';
      data.collected_items.forEach(item => {
        message += `- ${item.description}\n`;
      });
      alert(message);
      
      // 重新載入道館資料以更新獎勵狀態
      fetchArenaById(arenaData.id);
    } else {
      alert('領取獎勵失敗: ' + data.message);
    }
  })
  .catch(error => {
    hideLoading();
    console.error('領取獎勵錯誤:', error);
    alert('領取獎勵時發生錯誤');
  });
}

// 播放戰鬥動畫
function playBattleAnimation(isWin, challenger, defender, callback) {
  const battleAnimation = document.getElementById('battleAnimation');
  const challengerImg = document.getElementById('animationChallengerImg');
  const defenderImg = document.getElementById('animationDefenderImg');
  const vsText = document.getElementById('vsText');
  const winText = document.getElementById('winText');
  const loseText = document.getElementById('loseText');
  const battleFlash = document.getElementById('battleFlash');
  
  // 設置精靈圖片
  challengerImg.src = challenger.image_url || '/static/img/creature.PNG';
  
  if (defender) {
    defenderImg.src = defender.image_url || defender.img || '/static/img/creature.PNG';
  } else {
    defenderImg.src = '/static/img/creature.PNG';
  }
  
  // 重置所有動畫元素
  challengerImg.style.opacity = '0';
  defenderImg.style.opacity = '0';
  vsText.style.opacity = '0';
  winText.style.opacity = '0';
  loseText.style.opacity = '0';
  battleFlash.style.opacity = '0';
  
  // 顯示動畫容器
  battleAnimation.style.visibility = 'visible';
  
  // 簡化動畫序列
  setTimeout(() => {
    challengerImg.style.opacity = '1';
    defenderImg.style.opacity = '1';
  }, 500);
  
  setTimeout(() => {
    vsText.style.opacity = '1';
  }, 1000);
  
  setTimeout(() => {
    battleFlash.style.opacity = '1';
  }, 1500);
  
  setTimeout(() => {
    battleFlash.style.opacity = '0';
    vsText.style.opacity = '0';
    
    if (isWin) {
      winText.style.opacity = '1';
      defenderImg.style.opacity = '0';
    } else {
      loseText.style.opacity = '1';
      challengerImg.style.opacity = '0';
    }
  }, 2000);
  
  setTimeout(() => {
    battleAnimation.style.visibility = 'hidden';
    if (callback) callback();
  }, 3500);
}

// 顯示戰鬥結果
function showBattleResult(isWin, message, challenger, arena) {
  const battleResult = document.getElementById('battleResult');
  const resultHeader = document.getElementById('battleResultHeader');
  const resultTitle = document.getElementById('battleResultTitle');
  const resultMessage = document.getElementById('battleResultMessage');
  
  // 設置挑戰者信息
  const challengerImg = document.getElementById('challengerImg');
  const challengerName = document.getElementById('challengerName');
  const challengerPower = document.getElementById('challengerPower');
  
  if (challengerImg) challengerImg.src = challenger.image_url || '/static/img/creature.PNG';
  if (challengerName) challengerName.textContent = challenger.name;
  if (challengerPower) challengerPower.textContent = `ATK: ${challenger.attack || challenger.power || 100} | HP: ${challenger.hp || (challenger.power || 100) * 10}`;
  
  // 設置守護者信息
  const defenderImg = document.getElementById('defenderImg');
  const defenderName = document.getElementById('defenderName');
  const defenderPower = document.getElementById('defenderPower');
  const defenderOwner = document.getElementById('defenderOwner');
  
  if (arena.owner_creature) {
    const defender = arena.owner_creature;
    if (defenderImg) defenderImg.src = defender.image_url || defender.img || '/static/img/creature.PNG';
    if (defenderName) defenderName.textContent = defender.name;
    if (defenderPower) defenderPower.textContent = `ATK: ${defender.attack || defender.power || 100} | HP: ${defender.hp || (defender.power || 100) * 10}`;
    if (defenderOwner) defenderOwner.textContent = '擁有者: ' + arena.owner;
  } else {
    if (defenderImg) defenderImg.src = '/static/img/creature.PNG';
    if (defenderName) defenderName.textContent = '無守護者';
    if (defenderPower) defenderPower.textContent = 'ATK: 0 | HP: 0';
    if (defenderOwner) defenderOwner.textContent = '擁有者: 無';
  }
  
  // 設置結果樣式
  if (isWin) {
    if (battleResult) battleResult.className = 'battle-result mt-4 result-success';
    if (resultHeader) resultHeader.className = 'card-header bg-success text-white';
    if (resultTitle) resultTitle.innerHTML = '<i class="fas fa-trophy me-2"></i>挑戰成功！';
    if (resultMessage) resultMessage.className = 'alert alert-success';
  } else {
    if (battleResult) battleResult.className = 'battle-result mt-4 result-fail';
    if (resultHeader) resultHeader.className = 'card-header bg-danger text-white';
    if (resultTitle) resultTitle.innerHTML = '<i class="fas fa-times-circle me-2"></i>挑戰失敗！';
    if (resultMessage) resultMessage.className = 'alert alert-danger';
  }
  
  // 設置結果消息
  if (resultMessage) resultMessage.innerHTML = `<i class="fas fa-info-circle me-2"></i>${message}`;
  
  // 顯示結果
  if (battleResult) {
    battleResult.style.display = 'block';
    setTimeout(() => {
      battleResult.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);
  }
}

// 當頁面離開時，清除所有定時器
window.addEventListener('beforeunload', function() {
  if (battleAnimationTimeout) {
    clearTimeout(battleAnimationTimeout);
  }
});
</script>
{% endblock %}