{% extends 'base.html' %}

{% block title %}精靈捕捉{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #map {
    height: 500px;
    width: 100%;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 1;
    touch-action: none;
    user-select: none;
    position: relative;
  }
  
  /* 確保地圖容器相對於其父元素定位 */
  .map-container {
    position: relative; 
    width: 100%;
    z-index: 1;
  }
  
  /* 嘗試防止其他元素干擾地圖互動 */
  .card-body {
    overflow: visible;
    z-index: auto;
  }
  
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    visibility: hidden;
  }
  
  .loading-spinner {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: conic-gradient(transparent, var(--primary-color));
    -webkit-mask: radial-gradient(white, transparent 70%);
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .route-line {
    display: inline-block;
    width: 20px;
    height: 4px;
    margin-right: 5px;
    vertical-align: middle;
    border-radius: 2px;
  }
  
  .bus-routes-legend {
    padding: 12px;
    background: var(--card-bg-color);
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .user-marker {
    z-index: 1000;
  }
  
  .arena-marker {
    width: 36px;
    height: 36px;
    z-index: 1000;
    filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.3));
    transition: all 0.3s;
  }
  
  .arena-marker:hover {
    transform: scale(1.2);
  }
  
  .creature-marker {
    z-index: 900;
    filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.3));
    animation: bounce 2s infinite;
  }
  
  @keyframes bounce {
    0%, 100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-10px);
    }
  }
  
  .game-tab-content {
    min-height: 600px;
  }
  
  /* 遊戲化頁籤 */
  .game-tabs .nav-item {
    position: relative;
    z-index: 1;
  }
  
  .game-tabs .nav-link {
    border: none;
    padding: 12px 20px;
    font-weight: 600;
    color: var(--text-color);
    border-radius: 10px 10px 0 0;
    margin-right: 5px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s;
  }
  
  .game-tabs .nav-link.active {
    color: white;
    background-color: var(--primary-color);
    box-shadow: 0 -3px 10px rgba(0,0,0,0.1);
  }
  
  .game-tabs .nav-link.active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: linear-gradient(120deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
    z-index: -1;
  }
  
  .game-tabs .nav-link:hover:not(.active) {
    background-color: rgba(128,128,128,0.1);
  }
  
  .game-tabs .nav-link i {
    margin-right: 8px;
  }
  
  /* 擂台卡片 */
  .arena-card {
    transition: all 0.3s;
    background-position: center;
    background-size: cover;
    position: relative;
    overflow: hidden;
    min-height: 180px;
  }
  
  .arena-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.7) 100%);
    z-index: 0;
  }
  
  .arena-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
  }
  
  .arena-card-header {
    position: relative;
    z-index: 1;
    color: white;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
  }
  
  .arena-card-body {
    position: relative;
    z-index: 1;
    color: white;
  }
  
  .arena-level-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
    color: var(--dark-color);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 1;
  }
  
  /* 捕捉成功模態框 */
  .catch-modal .modal-content {
    border-radius: 20px;
    overflow: hidden;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  
  .catch-modal .modal-header {
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .catch-modal .modal-body {
    padding: 30px;
    text-align: center;
  }
  
  .catch-success-image {
    max-height: 200px;
    filter: drop-shadow(0px 5px 10px rgba(0,0,0,0.2));
    animation: float 3s ease-in-out infinite;
  }
  
  .catch-sparkle {
    position: absolute;
    width: 20px;
    height: 20px;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFD700"><path d="M12 0L14.59 9.41 24 12 14.59 14.59 12 24 9.41 14.59 0 12 9.41 9.41z"/></svg>');
    background-size: contain;
    opacity: 0.8;
    z-index: 10;
    pointer-events: none;
  }

  /* 深色模式適配 */
  [data-theme="dark"] .section-title {
    color: var(--text-color);
  }
  
  [data-theme="dark"] .badge.bg-light {
    background-color: #495057 !重要;
    color: #e9ecef !重要;
  }
  
  [data-theme="dark"] .small.text-muted,
  [data-theme="dark"] small.text-muted {
    color: #adb5bd !重要;
  }
  
  [data-theme="dark"] .leaflet-tile {
    filter: brightness(0.8) contrast(1.2);
  }
  
  [data-theme="dark"] .leaflet-container {
    background-color: #333;
  }
  
  [data-theme="dark"] .creature-stats .stat-item {
    background-color: #2d2d2d;
  }
  
  [data-theme="dark"] .creature-stats .small.text-muted {
    color: #adb5bd !重要;
  }
  
  [data-theme="dark"] .btn-outline-primary,
  [data-theme="dark"] .btn-outline-secondary {
    color: var(--text-color);
    border-color: var(--link-color);
  }
  
  [data-theme="dark"] .btn-outline-primary:hover,
  [data-theme="dark"] .btn-outline-secondary:hover {
    color: #fff;
    background-color: var(--link-color);
  }
  
  [data-theme="dark"] .card-header.bg-danger,
  [data-theme="dark"] .card-header.bg-info,
  [data-theme="dark"] .card-header.bg-success,
  [data-theme="dark"] .card-header.bg-primary,
  [data-theme="dark"] .card-header.bg-warning {
    color: white !重要;
  }
  
  [data-theme="dark"] .alert-info {
    background-color: rgba(23, 162, 184, 0.2);
    color: var(--text-color);
    border-color: rgba(23, 162, 184, 0.3);
  }
  
  /* 修正深色模式下圖例文字問題 */
  [data-theme="dark"] .bus-routes-legend {
    color: var(--text-color);
  }
  
  [data-theme="dark"] .bus-routes-legend h6 {
    color: var(--text-color);
  }
  
  [data-theme="dark"] .current-location p,
  [data-theme="dark"] .current-location strong {
    color: var(--text-color);
  }
  
  [data-theme="dark"] #arenaList h5 {
    color: var(--text-color);
  }
  
  /* 移動設備適配 */
  @media (max-width: 767.98px) {
    #map {
      height: 350px;
    }
    
    .game-tabs .nav-link {
      padding: 8px 12px;
      font-size: 0.9rem;
    }
    
    .arena-card {
      min-height: 150px;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
    }
    
    .catch-success-image {
      max-height: 150px;
    }
  }

  /* 新增精靈樣式 */
  .route-creature {
    animation: bounce 2s infinite;
    z-index: 900;
    cursor: pointer;
    transition: transform 0.3s;
  }
  
  .route-creature:hover {
    transform: scale(1.2);
  }
  
  /* 精靈倒計時樣式 */
  .creature-timer {
    position: absolute;
    bottom: -15px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 1px 6px;
    border-radius: 10px;
    font-size: 10px;
    white-space: nowrap;
  }
  
  /* 新增精靈類型顏色 */
  .creature-fire {
    background-color: #e74c3c !重要;
  }
  
  .creature-water {
    background-color: #3498db !重要;
  }
  
  .creature-earth {
    background-color: #8e44ad !重要;
  }
  
  .creature-air {
    background-color: #2ecc71 !重要;
  }
  
  .creature-electric {
    background-color: #f1c40f !重要;
  }
  
  .creature-normal {
    background-color: #95a5a6 !重要;
  }
  
  /* 精靈稀有度 */
  .creature-common {
    border: 2px solid #bdc3c7 !重要;
  }
  
  .creature-uncommon {
    border: 2px solid #3498db !重要;
  }
  
  .creature-rare {
    border: 2px solid #9b59b6 !重要;
  }
  
  .creature-legendary {
    border: 2px solid #f1c40f !重要;
    box-shadow: 0 0 10px #f39c12 !重要;
  }
  
  /* 精靈更新指示器 */
  .update-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 12px;
    z-index: 1000;
    display: none;
  }
  
  /* 精靈捕捉動畫效果 */
  @keyframes catchEffect {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.5); opacity: 0.7; }
    100% { transform: scale(0); opacity: 0; }
  }
  
  .catch-animation {
    animation: catchEffect 0.5s forwards;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="section-title text-center mb-4"><i class="fas fa-map-marked-alt me-2"></i>精靈探索捕捉</h2>
  
  <!-- 頁籤導航 -->
  <ul class="nav nav-tabs game-tabs mb-4" id="gameTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-content" type="button" role="tab" aria-controls="map-content" aria-selected="true">
        <i class="fas fa-map"></i>路線地圖
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="arenas-tab" data-bs-toggle="tab" data-bs-target="#arenas-content" type="button" role="tab" aria-controls="arenas-content" aria-selected="false">
        <i class="fas fa-trophy"></i>站牌擂台
      </button>
    </li>
  </ul>
  
  <!-- 頁籤內容 -->
  <div class="tab-content game-tab-content" id="gameTabsContent">
    <!-- 地圖頁籤 -->
    <div class="tab-pane fade show active" id="map-content" role="tabpanel" aria-labelledby="map-tab">
      <div class="row">
        <div class="col-md-12">
          <div class="card shadow-lg mb-4">
            <div class="card-body p-3">
              <div id="map" class="mb-3"></div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="bus-routes-legend mb-3">
                    <h6 class="mb-2"><i class="fas fa-route me-2"></i>路線圖例</h6>
                    <div class="d-flex flex-wrap">
                      <div class="me-4 mb-2 d-flex align-items-center">
                        <span class="route-line" style="background-color: #ff9800;"></span>
                        <span>貓空右線</span>
                      </div>
                      <div class="me-4 mb-2 d-flex align-items-center">
                        <span class="route-line" style="background-color: #4caf50;"></span>
                        <span>貓空左線(動物園)</span>
                      </div>
                      <div class="me-4 mb-2 d-flex align-items-center">
                        <span class="route-line" style="background-color: #9c27b0;"></span>
                        <span>貓空左線(指南宮)</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="current-location">
                      <p class="mb-0"><i class="fas fa-location-arrow me-2 text-primary"></i><strong>當前位置:</strong> <span id="currentLocation" class="ms-2 badge bg-light text-dark">尚未定位</span></p>
                    </div>
                    <div class="d-flex gap-2">
                      <button id="refreshLocationBtn" class="btn btn-sm btn-primary">
                        <i class="fas fa-crosshairs me-1"></i>重新定位
                      </button>
                      <button id="initMapBtn" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-sync-alt me-1"></i>重整地圖
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 提示信息 -->
              <div class="alert alert-info mt-3">
                <div class="d-flex">
                  <div class="me-3">
                    <i class="fas fa-info-circle fa-2x"></i>
                  </div>
                  <div>
                    <h5 class="alert-heading">遊戲提示</h5>
                    <p class="mb-0">地圖上將隨機生成精靈，點擊標記可以嘗試捕捉。精靈每5分鐘會更新一次。靠近站牌時，您可以挑戰該站牌的擂台！</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 擂台頁籤 -->
    <div class="tab-pane fade" id="arenas-content" role="tabpanel" aria-labelledby="arenas-tab">
      <div class="row">
        <div class="col-md-12">
          <div class="card shadow-lg mb-4">
            <div class="card-header bg-danger text-white">
              <h5 class="card-title mb-0"><i class="fas fa-trophy me-2"></i>站牌擂台挑戰</h5>
            </div>
            <div class="card-body">
              <p class="mb-3">這些是貓空纜車路線上的站牌擂台（道館），您可以使用您的精靈挑戰並佔領它們！擊敗當前的擂主即可成為新的擂主。</p>
              
              <!-- 擂台列表 -->
              <div id="arenaList" class="row g-3">
                <!-- 擂台列表將由JavaScript動態生成 -->
                <div class="col-12 text-center py-5">
                  <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">正在加載擂台資訊...</span>
                  </div>
                  <p class="mt-2">正在加載擂台資訊...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 加載中遮罩 -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<!-- 精靈更新指示器 -->
<div id="updateIndicator" class="update-indicator">
  <i class="fas fa-sync-alt me-2"></i><span id="updateCountdown">30</span>秒後更新精靈
</div>

<!-- 捕捉成功模態框 -->
<div class="modal fade catch-modal" id="catchSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white text-center">
        <h5 class="modal-title w-100"><i class="fas fa-check-circle me-2"></i>捕捉成功！</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body position-relative">
        <p id="catchSuccessMessage" class="lead"></p>
        <div class="text-center mb-3">
          <img id="caughtCreatureImage" src="" alt="捕捉到的精靈" class="catch-success-image">
          <!-- 裝飾性閃光效果 -->
          <div class="catch-sparkle" style="top:20%; left:30%;"></div>
          <div class="catch-sparkle" style="top:15%; left:60%;"></div>
          <div class="catch-sparkle" style="top:50%; left:20%;"></div>
          <div class="catch-sparkle" style="top:60%; left:70%;"></div>
          <div class="catch-sparkle" style="top:30%; left:80%;"></div>
        </div>
        <div class="creature-stats d-flex justify-content-around mb-4">
          <div class="stat-item text-center">
            <span class="d-block fs-4 fw-bold text-primary" id="creature-power">--</span>
            <span class="small text-muted">力量</span>
          </div>
          <div class="stat-item text-center">
            <span class="d-block fs-4 fw-bold text-success" id="creature-type">--</span>
            <span class="small text-muted">屬性</span>
          </div>
          <div class="stat-item text-center">
            <span class="d-block fs-4 fw-bold text-warning" id="creature-rarity">--</span>
            <span class="small text-muted">稀有度</span>
          </div>
        </div>
        <p class="mb-0 text-center">該精靈已被添加到您的收藏中！</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">繼續探索</button>
        <a href="{{ url_for('main.profile') }}" class="btn btn-primary">
          <i class="fas fa-book me-1"></i>查看我的精靈
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 載入Leaflet庫 -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- 引入公車路線地圖相關JS -->
<script type="module" src="{{ url_for('static', filename='js/bus-route-map.js') }}"></script>

<!-- 緊急修復腳本 - 修復地圖拖動問題 -->
<script src="{{ url_for('static', filename='js/map-emergency-fix.js') }}"></script>

<!-- 生成精靈和初始化地圖 -->
<script>
// 全局變數
var gameMap;
var arenaList = [];
var currentCreatures = [];
var capturedCreatures = 0;
var updateTimer = 30;
var updateInterval;
var creatureUpdateInterval = 30000; // 30秒更新一次

// 頁面載入完成事件
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM內容載入完成');
  
  // 初始化地圖 (使用一個延遲確保DOM完全渲染)
  setTimeout(initializeMap, 500);
  
  // 綁定更新位置按鈕
  document.getElementById('refreshLocationBtn').addEventListener('click', function() {
    console.log('點擊了重新定位按鈕');
    showLoading();
    if (typeof updateUserLocation === 'function') {
      updateUserLocation().then(() => {
        hideLoading();
      }).catch(() => {
        hideLoading();
        showGameAlert('無法獲取您的位置，請確保已授予位置權限。', 'warning');
      });
    } else {
      console.error('updateUserLocation 函數不存在');
      hideLoading();
    }
  });
  
  // 綁定重新載入地圖按鈕
  document.getElementById('initMapBtn').addEventListener('click', function() {
    console.log('點擊了重新載入地圖按鈕');
    showLoading();
    initializeMap();
    setTimeout(hideLoading, 1000);
  });
  
  // 處理頁籤切換事件，確保地圖正確渲染
  const mapTab = document.getElementById('map-tab');
  if (mapTab) {
    mapTab.addEventListener('shown.bs.tab', function() {
      console.log('地圖頁籤被啟用');
      if (gameMap) {
        console.log('調整地圖大小');
        gameMap.invalidateSize();
      } else {
        console.log('地圖未初始化，嘗試初始化');
        initializeMap();
      }
    });
  }
  
  // 更新擂台列表當擂台標籤被點擊時
  const arenasTab = document.getElementById('arenas-tab');
  if (arenasTab) {
    arenasTab.addEventListener('shown.bs.tab', function() {
      console.log('擂台頁籤被啟用');
      fetchArenasInfo();
    });
  }
  
  // 初始化捕捉模態框動畫效果
  initCatchModal();
  
  // 初始化倒計時更新
  startUpdateCountdown();
});

// 開始精靈更新倒計時
function startUpdateCountdown() {
  updateTimer = 30;
  document.getElementById('updateCountdown').textContent = updateTimer;
  document.getElementById('updateIndicator').style.display = 'block';
  
  if (updateInterval) {
    clearInterval(updateInterval);
  }
  
  updateInterval = setInterval(function() {
    updateTimer--;
    document.getElementById('updateCountdown').textContent = updateTimer;
    
    if (updateTimer <= 0) {
      // 時間到，更新精靈
      fetchRouteCreatures();
      // 重置計時器
      updateTimer = 30;
    }
  }, 1000);
}

// 獲取路線上的精靈
function fetchRouteCreatures() {
  console.log('獲取路線上的精靈...');
  document.getElementById('updateIndicator').style.display = 'none';
  
  // 調用API獲取所有路線上的精靈
  fetch('/game/api/route-creatures/get-all')
    .then(response => {
      if (!response.ok) {
        throw new Error('獲取精靈失敗');
      }
      return response.json();
    })
    .then(data => {
      console.log('獲取到的精靈:', data);
      
      if (data.success) {
        // 清除當前地圖上的精靈
        if (window.creaturesLayer) {
          window.creaturesLayer.clearLayers();
        }
        
        // 更新精靈列表
        currentCreatures = data.creatures;
        
        // 在地圖上顯示精靈
        displayCreaturesOnMap(currentCreatures);
        
        // 重新開始倒計時
        startUpdateCountdown();
      } else {
        console.error('獲取精靈返回失敗:', data.message);
        showGameAlert('獲取精靈資訊失敗: ' + data.message, 'warning');
      }
    })
    .catch(error => {
      console.error('獲取精靈錯誤:', error);
      showGameAlert('無法連接到伺服器，請稍後再試！', 'danger');
      
      // 發生錯誤時也重新開始倒計時
      startUpdateCountdown();
    });
}

// 在地圖上顯示精靈 - 最終版本
function displayCreaturesOnMap(creatures) {
  if (!gameMap) {
    console.error('地圖未初始化');
    return;
  }
  
  // 清空所有現有標記（不依賴圖層）
  gameMap.eachLayer(layer => {
    if (layer instanceof L.Marker && layer._icon && layer._icon.classList.contains('spirit-marker')) {
      gameMap.removeLayer(layer);
    }
  });
  
  if (!creatures || creatures.length === 0) {
    console.log('沒有精靈可顯示');
    return;
  }
  
  console.log(`嘗試在地圖上顯示 ${creatures.length} 隻精靈`);
  
  // 獲取當前時間
  const now = new Date().getTime() / 1000;
  
  // 創建超醒目測試標記（紅色大標記）
  const testMarker = L.marker([25.033, 121.565], {
    icon: L.divIcon({
      html: `<div style="
        width: 60px; 
        height: 60px; 
        background-color: red; 
        border: 4px solid white;
        border-radius: 50%; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        color: white; 
        font-weight: bold;
        font-size: 16px;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
      ">測試</div>`,
      className: 'test-marker',
      iconSize: [60, 60],
      iconAnchor: [30, 30]
    })
  }).addTo(gameMap);
  
  console.log('超醒目測試標記已添加');
  
  // 存儲已創建的標記
  const createdMarkers = [];
  
  // 為每個精靈創建標記
  creatures.forEach((creature, index) => {
    // 獲取基本信息
    const position = creature.position || { lat: 25.033 + (Math.random() * 0.02), lng: 121.565 + (Math.random() * 0.02) };
    const name = creature.name || '未知精靈';
    const elementType = creature.element_type || 'normal';
    const species = creature.species || '一般種';
    
    // 計算剩餘時間
    let remainingTime = 0;
    if (creature.expires_at) {
      remainingTime = Math.max(0, Math.floor(creature.expires_at - now));
    }
    const minutes = Math.floor(remainingTime / 60);
    const seconds = remainingTime % 60;
    const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // 根據元素類型獲取顏色
    let bgColor;
    switch(elementType) {
      case 'fire': bgColor = '#e74c3c'; break;
      case 'water': bgColor = '#3498db'; break;
      case 'earth': bgColor = '#8e44ad'; break;
      case 'air': bgColor = '#2ecc71'; break;
      case 'electric': bgColor = '#f1c40f'; break;
      default: bgColor = '#95a5a6';
    }
    
    // 獲取表情符號
    let emoji = getCreatureEmoji(elementType);
    
    // 創建醒目的圖標HTML（增加尺寸和邊框）
    const iconHtml = `
      <div style="
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: ${bgColor};
        border: 3px solid white;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 0 10px rgba(0,0,0,0.7);
        color: white;
        font-weight: bold;
        font-size: 22px;
        position: relative;
        z-index: 1000;
      ">
        ${emoji}
        <div style="
          position: absolute;
          bottom: -15px;
          left: 50%;
          transform: translateX(-50%);
          background-color: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 2px 8px;
          border-radius: 10px;
          font-size: 11px;
          white-space: nowrap;
          font-weight: normal;
          border: 1px solid white;
        ">${timeStr}</div>
      </div>
    `;
    
    try {
      // 確保位置為有效數值
      const lat = parseFloat(position.lat);
      const lng = parseFloat(position.lng);
      
      if (isNaN(lat) || isNaN(lng)) {
        console.error(`精靈 ${name} 位置無效:`, position);
        return;
      }
      
      // 使用超高zIndex值來確保標記位於頂部
      const icon = L.divIcon({
        html: iconHtml,
        className: 'spirit-marker spirit-marker-' + index,
        iconSize: [50, 50],
        iconAnchor: [25, 25]
      });
      
      // 創建標記並設置高zIndex
      const marker = L.marker([lat, lng], { 
        icon: icon,
        zIndexOffset: 1000 + index  // 確保高於其他地圖元素
      });
      
      // 直接添加到地圖
      marker.addTo(gameMap);
      
      // 添加彈出框
      marker.bindPopup(`
        <div class="text-center py-2">
          <h5 class="mb-2">${name}</h5>
          <p class="mb-2">
            <span class="badge ${getTypeBadgeClass(elementType)}">${getElementTypeName(elementType)}</span>
            <span class="badge ${getRarityBadgeClass(species)}">${species}</span>
          </p>
          <p class="mb-3">
            <strong>力量:</strong> ${creature.power || 10} | 
            <strong>防禦:</strong> ${creature.defense || 10} | 
            <strong>生命:</strong> ${creature.hp || 100}
          </p>
          <button class="btn btn-success btn-sm w-100 catch-btn" onclick="catchCreature('${creature.id}')">
            <i class="fas fa-hand-sparkles me-1"></i>捕捉
          </button>
          <p class="mt-2 mb-0"><small>剩餘時間: ${timeStr}</small></p>
        </div>
      `);
      
      // 點擊事件
      marker.on('click', function() {
        marker.openPopup();
      });
      
      // 保存標記並添加到列表中
      creature.marker = marker;
      createdMarkers.push(marker);
      
      console.log(`第 ${index+1} 隻精靈 ${name} 標記已創建`);
    } catch (err) {
      console.error(`創建精靈 ${name} 標記時發生錯誤:`, err);
    }
  });
  
  console.log(`成功創建 ${createdMarkers.length} 個精靈標記`);
  
  // 如果有精靈，平移到第一個精靈的位置
  if (createdMarkers.length > 0 && creatures[0] && creatures[0].position) {
    const pos = creatures[0].position;
    console.log(`平移到第一個精靈位置:`, pos);
    gameMap.setView([parseFloat(pos.lat), parseFloat(pos.lng)], 16);
    
    // 額外確認：在標記附近添加一個大型指示器
    L.circleMarker([parseFloat(pos.lat), parseFloat(pos.lng)], {
      radius: 30,
      color: 'yellow',
      fillColor: 'transparent',
      weight: 5,
      opacity: 0.8,
      dashArray: '5, 10'
    }).addTo(gameMap);
  }
  
  // 強制刷新地圖
  gameMap.invalidateSize();
  
  // 返回創建的標記
  return createdMarkers;
}

// 捕捉精靈的函數
function catchCreature(creatureId) {
  // 查找點擊的精靈
  const creature = currentCreatures.find(c => c.id === creatureId);
  if (!creature) {
    console.error('找不到指定精靈:', creatureId);
    showGameAlert('這個精靈已經消失了，請尋找其他精靈。', 'warning');
    return;
  }
  
  // 顯示加載中
  showLoading();
  
  // 呼叫API捕捉精靈
  fetch('/game/api/route-creatures/catch', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ creatureId: creatureId })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('捕捉精靈失敗');
    }
    return response.json();
  })
  .then(data => {
    hideLoading();
    
    if (data.success) {
      console.log('捕捉成功:', data);
      
      // 應用捕捉動畫效果
      const markerElement = creature.marker.getElement();
      if (markerElement) {
        markerElement.classList.add('catch-animation');
        
        // 等待動畫完成後從地圖移除
        setTimeout(function() {
          if (window.creaturesLayer) {
            window.creaturesLayer.removeLayer(creature.marker);
          }
        }, 500);
      } else {
        // 如果無法獲取DOM元素，直接從地圖中移除
        if (window.creaturesLayer) {
          window.creaturesLayer.removeLayer(creature.marker);
        }
      }
      
      // 從精靈列表中移除
      const index = currentCreatures.findIndex(c => c.id === creatureId);
      if (index !== -1) {
        currentCreatures.splice(index, 1);
      }
      
      // 更新計數
      capturedCreatures++;
      
      // 更新模態框內容
      document.getElementById('catchSuccessMessage').textContent = data.message;
      document.getElementById('caughtCreatureImage').src = data.creature.image_url || getDefaultCreatureImage(data.creature.element_type, data.creature.name);
      document.getElementById('creature-power').textContent = data.creature.power;
      document.getElementById('creature-type').textContent = data.creature.element_type;
      document.getElementById('creature-rarity').textContent = data.creature.species;
      
      // 顯示成功模態框
      const successModal = new bootstrap.Modal(document.getElementById('catchSuccessModal'));
      successModal.show();
      
      // 播放音效和動畫
      animateSparkles();
      playCatchSound();
    } else {
      console.error('捕捉失敗:', data);
      showGameAlert(data.message || '捕捉精靈失敗，請稍後再試！', 'warning');
    }
  })
  .catch(error => {
    console.error('捕捉精靈錯誤:', error);
    hideLoading();
    showGameAlert('捕捉精靈失敗，請稍後再試！', 'danger');
  });
}

// 獲取精靈默認圖片
function getDefaultCreatureImage(type, name) {
  const color = getTypeColor(type);
  return `https://placehold.co/200x200/${color}/white?text=${encodeURIComponent(name || '未知精靈')}`;
}

// 初始化地圖的函數
function initializeMap() {
  console.log('開始初始化地圖...');
  showLoading();
  
  // 確認地圖容器存在
  const mapContainer = document.getElementById('map');
  if (!mapContainer) {
    console.error('找不到地圖容器元素 #map');
    hideLoading();
    showGameAlert('地圖容器元素不存在，請刷新頁面重試。', 'danger');
    return;
  }
  
  // 確保 Leaflet 庫已載入
  if (typeof L === 'undefined') {
    console.error('Leaflet 庫未載入或未定義');
    hideLoading();
    showGameAlert('地圖庫未載入，請刷新頁面重試。', 'danger');
    return;
  }
  
  try {
    // 嘗試直接創建地圖，不再依賴模組導出的函數
    createDirectMap();
  } catch (error) {
    console.error('初始化地圖時發生錯誤:', error);
    hideLoading();
    showGameAlert('地圖初始化失敗，請檢查網絡連接並刷新頁面重試。', 'danger');
  }
}

// 備用：直接創建地圖（不依賴模組）
function createDirectMap() {
  console.log('使用直接方法初始化地圖');
  try {
    // 如果已經有地圖實例，先移除
    if (gameMap && typeof gameMap.remove === 'function') {
      gameMap.remove();
    }
    
    // 創建新的地圖實例
    gameMap = L.map('map', {
      center: [25.0165, 121.5375],
      zoom: 14,
      attributionControl: true,
      zoomControl: true,
      dragging: true,      
      scrollWheelZoom: true, 
      doubleClickZoom: true, 
      touchZoom: true,     
      boxZoom: true,       
      tap: true           
    });
    
    console.log('地圖實例已創建');
    
    // 添加基本地圖圖層（測試多個圖層來源以確保至少一個能夠載入）
    try {
      // 嘗試使用OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(gameMap);
      console.log('OpenStreetMap 圖層已添加');
    } catch (tileError) {
      console.warn('無法添加OpenStreetMap圖層，嘗試備用圖層', tileError);
      
      try {
        // 備用地圖源: CartoDB
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: 'abcd',
          maxZoom: 19
        }).addTo(gameMap);
        console.log('CartoDB 圖層已添加');
      } catch (backupTileError) {
        console.error('所有地圖圖層添加失敗', backupTileError);
        showGameAlert('地圖圖層載入失敗，請檢查網絡連接並刷新頁面重試。', 'danger');
      }
    }
    
    // 創建必要的圖層
    window.routeLayer = L.layerGroup().addTo(gameMap);
    window.stopsLayer = L.layerGroup().addTo(gameMap);
    window.busesLayer = L.layerGroup().addTo(gameMap);
    window.creaturesLayer = L.layerGroup().addTo(gameMap);
    window.arenaLayer = L.layerGroup().addTo(gameMap);
    
    console.log('地圖圖層已創建');
    
    // 加入默認數據
    setupDefaultData();
    
    // 完成初始化
    finishMapInitialization();
  } catch (directError) {
    console.error('備用地圖初始化也失敗:', directError);
    hideLoading();
    showGameAlert('地圖初始化失敗，請檢查網絡連接並刷新頁面重試。', 'danger');
    throw directError; // 重新拋出錯誤以便於調試
  }
}

// 設置默認數據（當模組加載失敗時使用）
function setupDefaultData() {
  // 設置默認路線顏色
  window.routeColors = {
    'cat_right': '#ff9800',
    'cat_left': '#4caf50',
    'cat_left_zhinan': '#9c27b0'
  };
  
  // 設置默認座標（空陣列，將在實際操作中填充）
  window.routeCoordinates = {
    'cat_right': [],
    'cat_left': [],
    'cat_left_zhinan': []
  };
  
  // 設置精靈生成參數
  window.MAX_CREATURES_PER_ROUTE = 3;
  window.CREATURE_LIFETIME = 300000; // 5分鐘
  window.SPAWN_INTERVAL = 60000;     // 1分鐘
  window.SPAWN_CHANCE = 0.3;         // 30%機率
  
  // 設置精靈類型
  window.routeCreatureTypes = {
    'cat_right': [
      { id: 'cr1', name: '火焰鼠', type: '火系', rarity: '普通', power: 10 },
      { id: 'cr2', name: '閃電貓', type: '電系', rarity: '稀有', power: 25 }
    ],
    'cat_left': [
      { id: 'cl1', name: '水靈兔', type: '水系', rarity: '普通', power: 12 },
      { id: 'cl2', name: '綠葉猴', type: '土系', rarity: '稀有', power: 27 }
    ],
    'cat_left_zhinan': [
      { id: 'cz1', name: '風翔鷹', type: '風系', rarity: '史詩', power: 35 },
      { id: 'cz2', name: '雷擊獅', type: '電系', rarity: '傳說', power: 50 }
    ]
  };
  
  // 默認用戶位置（台北市）
  window.userLocation = [25.0330, 121.5654];
}

// 完成地圖初始化後的共同操作
function finishMapInitialization() {
  try {
    // 加載路線（如果函數存在）
    if (typeof loadCatRightRoute === 'function') {
      console.log('載入路線-右線');
      loadCatRightRoute();
    }
    
    if (typeof loadCatLeftRoute === 'function') {
      console.log('載入路線-左線');
      loadCatLeftRoute();
    }
    
    if (typeof loadCatLeftZhinanRoute === 'function') {
      console.log('載入路線-左線指南宮');
      loadCatLeftZhinanRoute();
    }
    
    // 加載站點和道館
    if (typeof loadAllBusStops === 'function') {
      console.log('載入站點和道館');
      loadAllBusStops();
    }
    
    // 調整地圖大小以確保正確渲染
    setTimeout(function() {
      console.log('調整地圖大小');
      if (gameMap && typeof gameMap.invalidateSize === 'function') {
        gameMap.invalidateSize();
      }
    }, 500);
    
    // 更新用戶位置（如果函數存在）
    if (typeof updateUserLocation === 'function') {
      console.log('更新用戶位置');
      updateUserLocation().catch(err => {
        console.warn('位置更新失敗:', err);
      });
    } else {
      // 如果無法獲取位置，使用默認位置標記
      addDefaultLocationMarker();
    }
    
    // 載入路線精靈
    fetchRouteCreatures();
    
    console.log('地圖初始化完成');
    hideLoading();
  } catch (finishError) {
    console.error('完成地圖初始化時發生錯誤:', finishError);
    hideLoading();
    showGameAlert('地圖功能部分載入失敗，部分功能可能不可用。', 'warning');
  }
}

// 添加默認位置標記
function addDefaultLocationMarker() {
  if (!gameMap) return;
  
  const defaultPos = [25.0330, 121.5654]; // 台北市中心
  window.userLocation = defaultPos;
  
  // 創建用戶位置標記
  window.userMarker = L.marker(defaultPos, {
    icon: L.divIcon({
      className: 'user-marker',
      html: '<div style="background-color:#FFA500;width:20px;height:20px;border-radius:50%;border:3px solid white;"></div>',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    })
  }).addTo(gameMap);
  
  // 創建用戶範圍圓圈
  window.userCircle = L.circle(defaultPos, {
    radius: 300,
    color: '#FFA500',
    fillColor: '#FFA500',
    fillOpacity: 0.1,
    weight: 1
  }).addTo(gameMap);
  
  // 更新地圖視角
  gameMap.setView(defaultPos, 14);
  
  // 更新位置顯示
  const locationElement = document.getElementById('currentLocation');
  if (locationElement) {
    locationElement.textContent = `默認位置 (無法獲取實際位置)`;
  }
}

// 根據精靈類型獲取表情符號
function getCreatureEmoji(type) {
  switch(type) {
    case 'water': return '💧';
    case 'fire': return '🔥';
    case 'earth': return '🌱';
    case 'air': return '💨';
    case 'electric': return '⚡';
    default: return '✨';
  }
}

// 根據精靈類型獲取顏色
function getTypeColor(type) {
  switch(type) {
    case 'water': return '3498db';
    case 'fire': return 'e74c3c';
    case 'earth': return '8e44ad';
    case 'air': return '2ecc71';
    case 'electric': return 'f1c40f';
    default: return '95a5a6';
  }
}

// 根據精靈類型獲取徽章類別
function getTypeBadgeClass(type) {
  switch(type) {
    case 'water': return 'bg-primary';
    case 'fire': return 'bg-danger';
    case 'earth': return 'bg-warning';
    case 'air': return 'bg-info';
    case 'electric': return 'bg-warning';
    default: return 'bg-secondary';
  }
}

// 根據稀有度獲取徽章類別
function getRarityBadgeClass(rarity) {
  switch(rarity) {
    case '一般種': return 'bg-secondary';
    case '罕見種': return 'bg-info';
    case '稀有種': return 'bg-primary';
    case '傳說種': return 'bg-danger';
    default: return 'bg-secondary';
  }
}

// 元素類型轉換為中文顯示
function getElementTypeName(type) {
  switch(type) {
    case 'fire': return '火系';
    case 'water': return '水系';
    case 'earth': return '土系';
    case 'air': return '風系';
    case 'electric': return '電系';
    case 0: return '火系'; // 數字枚舉值 (FIRE = 0)
    case 1: return '水系'; // 數字枚舉值 (WATER = 1)
    case 2: return '土系'; // 數字枚舉值 (EARTH = 2)
    case 3: return '風系'; // 數字枚舉值 (AIR = 3)
    case 4: return '電系'; // 數字枚舉值 (ELECTRIC = 4)
    default: return '一般系';
  }
}

// 根據稀有度獲取 z-index 值
function getZIndexByRarity(rarity) {
  switch(rarity) {
    case '傳說種': return 1000;
    case '稀有種': return 900;
    case '罕見種': return 800;
    default: return 700;  // 一般種
  }
}

// 獲取擂台列表
function fetchArenasInfo() {
  console.log('獲取擂台資訊');
  showLoading();
  
  const arenaListElement = document.getElementById('arenaList');
  if (!arenaListElement) {
    console.error('找不到擂台列表元素');
    hideLoading();
    return;
  }
  
  // 如果尚未獲取到擂台列表，等待道館加載完成
  if (!window.busStopsArenas || Object.keys(window.busStopsArenas).length === 0) {
    console.log('尚未獲取到擂台列表，等待一秒後重試');
    setTimeout(fetchArenasInfo, 1000);
    return;
  }
  
  // 清空列表
  arenaListElement.innerHTML = '';
  
  // 將擂台資訊轉換為陣列
  arenaList = Object.values(window.busStopsArenas);
  
  if (arenaList.length === 0) {
    arenaListElement.innerHTML = '<div class="col-12 text-center py-5"><p>找不到任何擂台資訊</p></div>';
    hideLoading();
    return;
  }
  
  // 按照路線分組
  const groupedArenas = {};
  
  arenaList.forEach(arena => {
    if (!groupedArenas[arena.routeName]) {
      groupedArenas[arena.routeName] = [];
    }
    groupedArenas[arena.routeName].push(arena);
  });
  
  // 生成HTML
  Object.keys(groupedArenas).forEach(routeName => {
    const arenas = groupedArenas[routeName];
    
    // 添加路線標題
    const routeColor = getRouteColorByName(routeName);
    arenaListElement.innerHTML += `
      <div class="col-12 mb-3">
        <div class="d-flex align-items-center mb-2">
          <span class="route-line" style="background-color:${routeColor};"></span>
          <h5 class="mb-0">${routeName} 站點道館</h5>
        </div>
      </div>
    `;
    
    // 添加該路線的擂台
    arenas.forEach(arena => {
      const arenaCard = document.createElement('div');
      arenaCard.className = 'col-md-4 col-sm-6 mb-3';
      arenaCard.innerHTML = `
        <div class="card arena-card" style="background-image: url('https://placehold.co/600x400/${routeColor.replace('#', '')}/white?text=${encodeURIComponent(arena.stopName)}')">
          <div class="arena-level-badge">${arena.level}</div>
          <div class="card-header arena-card-header text-center">
            <h5 class="mb-0">${arena.stopName}</h5>
          </div>
          <div class="card-body arena-card-body d-flex flex-column justify-content-end">
            <div class="arena-status mb-2">
              <p class="mb-0"><small>擂主: ${arena.owner || '無'}</small></p>
              <p class="mb-0"><small>守護精靈: ${arena.guardianName || '無'}</small></p>
            </div>
            <button class="btn btn-light btn-sm challenge-arena-btn" 
                  onclick="goToArena('${arena.stopId}', '${arena.stopName}', '${arena.routeName}')">
              <i class="fas fa-trophy me-1"></i>前往道館
            </button>
          </div>
        </div>
      `;
      arenaListElement.appendChild(arenaCard);
    });
  });
  
  console.log('擂台列表生成完成');
  hideLoading();
}

// 前往道館的函數
function goToArena(stopId, stopName, routeName) {
  // 獲取目前位置（用於lat和lon參數）
  const location = userLocation || [25.0282, 121.5432]; // 默認位置
  
  window.location.href = `/game/battle?stopId=${stopId}&stopName=${encodeURIComponent(stopName)}&routeName=${encodeURIComponent(routeName)}&lat=${location[0]}&lon=${location[1]}`;
}

// 根據路線名稱獲取顏色
function getRouteColorByName(routeName) {
  if (routeName.includes('右線')) {
    return '#ff9800';
  } else if (routeName.includes('左線') && routeName.includes('動物園')) {
    return '#4caf50';
  } else if (routeName.includes('左線') && routeName.includes('指南宮')) {
    return '#9c27b0';
  }
  return '#3498db'; // 預設藍色
}

// 顯示遊戲提示
function showGameAlert(message, type = 'info') {
  const alertContainer = document.createElement('div');
  alertContainer.className = `alert alert-${type} alert-dismissible fade show game-alert position-fixed`;
  alertContainer.style.top = '80px';
  alertContainer.style.right = '20px';
  alertContainer.style.zIndex = '9999';
  alertContainer.style.maxWidth = '300px';
  alertContainer.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.2)';
  
  alertContainer.innerHTML = `
    <div class="d-flex">
      <div class="me-3">
        <i class="fas fa-${type === 'danger' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
      </div>
      <div>${message}</div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  
  document.body.appendChild(alertContainer);
  
  // 自動消失
  setTimeout(() => {
    const bsAlert = new bootstrap.Alert(alertContainer);
    bsAlert.close();
  }, 5000);
}

// 初始化捕捉模態框動畫
function initCatchModal() {
  const modal = document.getElementById('catchSuccessModal');
  if (modal) {
    modal.addEventListener('shown.bs.modal', function() {
      animateSparkles();
    });
  }
}

// 閃光動畫
function animateSparkles() {
  const sparkles = document.querySelectorAll('.catch-sparkle');
  sparkles.forEach(sparkle => {
    // 重置動畫
    sparkle.style.animation = 'none';
    sparkle.offsetHeight; // 觸發重排
    
    // 隨機位置
    const top = 10 + Math.random() * 80;
    const left = 10 + Math.random() * 80;
    sparkle.style.top = `${top}%`;
    sparkle.style.left = `${left}%`;
    
    // 隨機大小
    const size = 10 + Math.random() * 20;
    sparkle.style.width = `${size}px`;
    sparkle.style.height = `${size}px`;
    
    // 隨機動畫
    const duration = 1 + Math.random() * 2;
    const delay = Math.random() * 0.5;
    sparkle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite alternate`;
  });
}

// 播放捕捉成功音效
function playCatchSound() {
  // 如果可以，這裡可以添加聲音效果
  console.log('播放捕捉成功音效');
}

// 顯示載入中
function showLoading() {
  document.getElementById('loadingOverlay').style.visibility = 'visible';
}

// 隱藏載入中
function hideLoading() {
  document.getElementById('loadingOverlay').style.visibility = 'hidden';
}

// 當發生錯誤時，在控制台輸出錯誤信息
window.onerror = function(message, source, lineno, colno, error) {
  console.error('全局錯誤:', message, 'at', source, lineno, colno);
  hideLoading();
  return false;
};
</script>
{% endblock %}