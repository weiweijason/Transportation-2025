{% extends 'base.html' %}

{% block title %}ç²¾éˆæ•æ‰{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #map {
    height: 500px;
    width: 100%;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
  }
  
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    visibility: hidden;
  }
  
  .loading-spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .route-line {
    display: inline-block;
    width: 20px;
    height: 3px;
    margin-right: 5px;
    vertical-align: middle;
  }
  
  .bus-routes-legend {
    padding: 10px;
    background: white;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  
  .user-marker {
    z-index: 1000;
  }
  
  .arena-marker {
    width: 36px;
    height: 36px;
    z-index: 1000;
  }
  
  .creature-marker {
    z-index: 900;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">ç²¾éˆå…¬è»ŠéŠæˆ²</h2>
  
  <!-- é ç±¤å°èˆª -->
  <ul class="nav nav-tabs mb-4" id="gameTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-content" type="button" role="tab" aria-controls="map-content" aria-selected="true">è·¯ç·šåœ°åœ–</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="arenas-tab" data-bs-toggle="tab" data-bs-target="#arenas-content" type="button" role="tab" aria-controls="arenas-content" aria-selected="false">ç«™ç‰Œæ“‚å°</button>
    </li>
  </ul>
  
  <!-- é ç±¤å…§å®¹ -->
  <div class="tab-content" id="gameTabsContent">
    <!-- åœ°åœ–é ç±¤ -->
    <div class="tab-pane fade show active" id="map-content" role="tabpanel" aria-labelledby="map-tab">
      <div class="row">
        <div class="col-md-12">
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0">è²“ç©ºçºœè»Šè·¯ç·šåœ°åœ–</h5>
            </div>
            <div class="card-body">
              <div id="map"></div>
              
              <div class="row mt-3">
                <div class="col-12">
                  <div class="bus-routes-legend">
                    <h6>è·¯ç·šåœ–ä¾‹ï¼š</h6>
                    <div class="d-flex flex-wrap">
                      <div class="me-4 mb-2">
                        <span class="route-line" style="background-color: #ff9800;"></span>
                        <span>è²“ç©ºå³ç·š</span>
                      </div>
                      <div class="me-4 mb-2">
                        <span class="route-line" style="background-color: #4caf50;"></span>
                        <span>è²“ç©ºå·¦ç·š(å‹•ç‰©åœ’)</span>
                      </div>
                      <div class="me-4 mb-2">
                        <span class="route-line" style="background-color: #9c27b0;"></span>
                        <span>è²“ç©ºå·¦ç·š(æŒ‡å—å®®)</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="row mt-3">
                <div class="col-md-6">
                  <p><strong>ç•¶å‰ä½ç½®:</strong> <span id="currentLocation">å°šæœªå®šä½</span></p>
                </div>
                <div class="col-md-6 text-end">
                  <button id="refreshLocationBtn" class="btn btn-sm btn-primary">é‡æ–°å®šä½</button>
                  <button id="initMapBtn" class="btn btn-sm btn-success">é‡æ–°è¼‰å…¥åœ°åœ–</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ“‚å°é ç±¤ -->
    <div class="tab-pane fade" id="arenas-content" role="tabpanel" aria-labelledby="arenas-tab">
      <div class="row">
        <div class="col-md-12">
          <div class="card mb-4">
            <div class="card-header bg-danger text-white">
              <h5 class="card-title mb-0">ç«™ç‰Œæ“‚å°</h5>
            </div>
            <div class="card-body">
              <p class="mb-3">é€™äº›æ˜¯è²“ç©ºçºœè»Šè·¯ç·šä¸Šçš„ç«™ç‰Œæ“‚å°ï¼ˆé“é¤¨ï¼‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨çš„ç²¾éˆæŒ‘æˆ°ä¸¦ä½”é ˜å®ƒå€‘ï¼</p>
              <div class="row" id="arenaList">
                <!-- æ“‚å°åˆ—è¡¨å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                <div class="col-12 text-center py-5">
                  <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">æ­£åœ¨åŠ è¼‰æ“‚å°è³‡è¨Š...</span>
                  </div>
                  <p class="mt-2">æ­£åœ¨åŠ è¼‰æ“‚å°è³‡è¨Š...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- åŠ è¼‰ä¸­é®ç½© -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<!-- æ•æ‰æˆåŠŸæ¨¡æ…‹æ¡† -->
<div class="modal fade" id="catchSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">æ•æ‰æˆåŠŸï¼</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="catchSuccessMessage"></p>
        <div class="text-center my-3">
          <img id="caughtCreatureImage" src="" alt="æ•æ‰åˆ°çš„ç²¾éˆ" class="img-fluid" style="max-height: 200px;">
        </div>
        <p>è©²ç²¾éˆå·²è¢«æ·»åŠ åˆ°æ‚¨çš„æ”¶è—ä¸­ï¼</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
        <a href="{{ url_for('main.profile') }}" class="btn btn-primary">æŸ¥çœ‹æˆ‘çš„ç²¾éˆ</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- è¼‰å…¥Leafletåº« -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- å¼•å…¥å…¬è»Šè·¯ç·šåœ°åœ–ç›¸é—œJS -->
<script src="{{ url_for('static', filename='js/bus-route-map.js') }}"></script>

<!-- ç”Ÿæˆç²¾éˆå’Œåˆå§‹åŒ–åœ°åœ– -->
<script>
// å…¨å±€è®Šæ•¸
var gameMap;
var arenaList = [];

// é é¢è¼‰å…¥å®Œæˆäº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMå…§å®¹è¼‰å…¥å®Œæˆ');
  
  // æª¢æŸ¥mapå…ƒç´ æ˜¯å¦å­˜åœ¨
  const mapElement = document.getElementById('map');
  if (!mapElement) {
    console.error('æ‰¾ä¸åˆ°IDç‚ºmapçš„å…ƒç´ !');
    alert('æ‰¾ä¸åˆ°åœ°åœ–å®¹å™¨å…ƒç´ !');
    return;
  }
  
  console.log('æ‰¾åˆ°åœ°åœ–å®¹å™¨å…ƒç´ ï¼Œé–‹å§‹åˆå§‹åŒ–åœ°åœ–');
  
  // åˆå§‹åŒ–åœ°åœ– (ä½¿ç”¨ä¸€å€‹å»¶é²ç¢ºä¿DOMå®Œå…¨æ¸²æŸ“)
  setTimeout(initializeMap, 500);
  
  // ç¶å®šæ›´æ–°ä½ç½®æŒ‰éˆ•
  const refreshLocationBtn = document.getElementById('refreshLocationBtn');
  if (refreshLocationBtn) {
    refreshLocationBtn.addEventListener('click', function() {
      console.log('é»æ“Šäº†é‡æ–°å®šä½æŒ‰éˆ•');
      if (typeof updateUserLocation === 'function') {
        updateUserLocation();
      } else {
        console.error('updateUserLocation å‡½æ•¸ä¸å­˜åœ¨');
      }
    });
  }
  
  // ç¶å®šé‡æ–°è¼‰å…¥åœ°åœ–æŒ‰éˆ•
  const initMapBtn = document.getElementById('initMapBtn');
  if (initMapBtn) {
    initMapBtn.addEventListener('click', function() {
      console.log('é»æ“Šäº†é‡æ–°è¼‰å…¥åœ°åœ–æŒ‰éˆ•');
      initializeMap();
    });
  }
  
  // è™•ç†é ç±¤åˆ‡æ›äº‹ä»¶ï¼Œç¢ºä¿åœ°åœ–æ­£ç¢ºæ¸²æŸ“
  const mapTab = document.getElementById('map-tab');
  if (mapTab) {
    mapTab.addEventListener('shown.bs.tab', function() {
      console.log('åœ°åœ–é ç±¤è¢«å•Ÿç”¨');
      if (gameMap) {
        console.log('èª¿æ•´åœ°åœ–å¤§å°');
        gameMap.invalidateSize();
      } else {
        console.log('åœ°åœ–æœªåˆå§‹åŒ–ï¼Œå˜—è©¦åˆå§‹åŒ–');
        initializeMap();
      }
    });
  }
  
  // æ›´æ–°æ“‚å°åˆ—è¡¨
  fetchArenasInfo();
});

// åˆå§‹åŒ–åœ°åœ–çš„å‡½æ•¸
function initializeMap() {
  console.log('é–‹å§‹åˆå§‹åŒ–åœ°åœ–...');
  try {
    // ä½¿ç”¨ bus-route-map.js ä¸­çš„åˆå§‹åŒ–å‡½æ•¸
    gameMap = initMap('map');
    
    if (gameMap) {
      console.log('åœ°åœ–æˆåŠŸåˆå§‹åŒ–');
      
      // åŠ è¼‰è·¯ç·š
      console.log('è¼‰å…¥è·¯ç·š');
      loadCatRightRoute();
      loadCatLeftRoute();
      loadCatLeftZhinanRoute();
      
      // åŠ è¼‰ç«™é»å’Œé“é¤¨
      console.log('è¼‰å…¥ç«™é»å’Œé“é¤¨');
      loadAllBusStops();
      
      // èª¿æ•´åœ°åœ–å¤§å°ä»¥ç¢ºä¿æ­£ç¢ºæ¸²æŸ“
      setTimeout(function() {
        console.log('èª¿æ•´åœ°åœ–å¤§å°');
        gameMap.invalidateSize();
      }, 500);
      
      // è¨­ç½®ç²¾éˆç”Ÿæˆå®šæ™‚å™¨
      console.log('è¨­ç½®ç²¾éˆç”Ÿæˆå®šæ™‚å™¨');
      startCreatureSpawning();
    } else {
      console.error('åœ°åœ–åˆå§‹åŒ–å¤±æ•—ï¼ŒgameMap ç‚º null');
    }
  } catch (error) {
    console.error('åˆå§‹åŒ–åœ°åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    alert('åˆå§‹åŒ–åœ°åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
  }
}

// ç²¾éˆç”Ÿæˆç›¸é—œå‡½æ•¸
function startCreatureSpawning() {
  console.log('é–‹å§‹ç²¾éˆç”Ÿæˆç³»çµ±');
  
  // æ¸…é™¤ç¾æœ‰ç²¾éˆ
  if (creaturesLayer) {
    creaturesLayer.clearLayers();
  }
  routeCreatures = [];
  
  // åˆå§‹ç”Ÿæˆä¸€äº›ç²¾éˆ
  spawnCreaturesOnRoutes();
  
  // å®šæ™‚ç”Ÿæˆæ–°ç²¾éˆ
  setInterval(spawnCreaturesOnRoutes, SPAWN_INTERVAL);
}

// åœ¨è·¯ç·šä¸Šç”Ÿæˆç²¾éˆ
function spawnCreaturesOnRoutes() {
  console.log('å˜—è©¦åœ¨è·¯ç·šä¸Šç”Ÿæˆç²¾éˆ');
  
  // ç§»é™¤è¶…éå­˜åœ¨æ™‚é–“çš„ç²¾éˆ
  const currentTime = Date.now();
  routeCreatures = routeCreatures.filter(creature => {
    if (currentTime > creature.spawnTime + CREATURE_LIFETIME) {
      console.log(`ç²¾éˆ ${creature.name} å­˜åœ¨æ™‚é–“åˆ°ï¼Œæ¶ˆå¤±`);
      if (creature.marker) {
        creaturesLayer.removeLayer(creature.marker);
      }
      return false;
    }
    return true;
  });
  
  // ç‚ºæ¯æ¢è·¯ç·šå˜—è©¦ç”Ÿæˆç²¾éˆ
  Object.keys(routeCoordinates).forEach(routeKey => {
    // æª¢æŸ¥è©²è·¯ç·šä¸Šçš„ç²¾éˆæ•¸é‡
    const routeCreatureCount = routeCreatures.filter(c => c.routeKey === routeKey).length;
    
    // å¦‚æœè©²è·¯ç·šç²¾éˆæ•¸é‡æœªé”åˆ°ä¸Šé™ï¼Œå˜—è©¦ç”Ÿæˆ
    if (routeCreatureCount < MAX_CREATURES_PER_ROUTE) {
      // æª¢æŸ¥ç”Ÿæˆæ©Ÿç‡
      if (Math.random() < SPAWN_CHANCE) {
        // ç²å–è·¯ç·šåº§æ¨™
        const coordinates = routeCoordinates[routeKey];
        
        if (coordinates.length > 0) {
          // å¾è·¯ç·šä¸Šéš¨æ©Ÿé¸æ“‡ä¸€å€‹ä½ç½®
          const randomIndex = Math.floor(Math.random() * coordinates.length);
          const position = coordinates[randomIndex];
          
          // å¾è©²è·¯ç·šçš„ç²¾éˆåˆ—è¡¨ä¸­éš¨æ©Ÿé¸æ“‡ä¸€ç¨®
          const routeCreatureList = routeCreatureTypes[routeKey];
          const randomCreatureIndex = Math.floor(Math.random() * routeCreatureList.length);
          const creatureTemplate = routeCreatureList[randomCreatureIndex];
          
          // å‰µå»ºç²¾éˆå¯¦ä¾‹
          const creatureId = `${creatureTemplate.id}-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
          const creature = {
            ...creatureTemplate,
            id: creatureId,
            position: position,
            routeKey: routeKey,
            spawnTime: Date.now()
          };
          
          // å‰µå»ºç²¾éˆåœ–æ¨™
          const creatureIcon = L.divIcon({
            className: 'creature-marker',
            html: `
              <div style="
                width: 40px;
                height: 40px;
                background-color: ${routeColors[routeKey]};
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                border: 2px solid white;
                box-shadow: 0 0 5px rgba(0,0,0,0.5);
                color: white;
                font-weight: bold;
                font-size: 18px;
              ">
                ğŸ’«
              </div>
            `,
            iconSize: [40, 40],
            iconAnchor: [20, 20]
          });
          
          // å‰µå»ºåœ°åœ–æ¨™è¨˜
          const marker = L.marker(position, {
            icon: creatureIcon,
            zIndexOffset: 900
          }).addTo(creaturesLayer);
          
          // ç¶å®šå½ˆå‡ºæ¡†
          marker.bindPopup(`
            <div style="text-align:center;">
              <h5>${creature.name}</h5>
              <p>é¡å‹: ${creature.type} | ç¨€æœ‰åº¦: ${creature.rarity}</p>
              <p>åŠ›é‡: ${creature.power}</p>
              <button class="btn btn-success btn-sm catch-btn" onclick="catchCreature('${creature.id}')">æ•æ‰</button>
            </div>
          `);
          
          // ä¿å­˜æ¨™è¨˜å¼•ç”¨
          creature.marker = marker;
          
          // æ·»åŠ åˆ°ç²¾éˆåˆ—è¡¨
          routeCreatures.push(creature);
          
          console.log(`åœ¨ ${routeKey} è·¯ç·šä¸Šç”Ÿæˆç²¾éˆ: ${creature.name}`);
        }
      }
    }
  });
}

// æ•æ‰ç²¾éˆçš„å‡½æ•¸
function catchCreature(creatureId) {
  // å°‹æ‰¾å°æ‡‰çš„ç²¾éˆè³‡è¨Š
  const creature = routeCreatures.find(c => c.id === creatureId);
  if (!creature) {
    console.error('æ‰¾ä¸åˆ°æŒ‡å®šç²¾éˆ:', creatureId);
    return;
  }
  
  // é¡¯ç¤ºåŠ è¼‰ä¸­
  showLoading();
  
  // å‡†å‚™è¦ç™¼é€åˆ°å¾Œç«¯çš„è³‡æ–™
  const creatureData = {
    creatureId: creature.id,
    creatureName: creature.name,
    creatureType: creature.type,
    creatureRarity: creature.rarity,
    creaturePower: creature.power,
    creatureImg: creature.img
  };
  
  // ç™¼é€åˆ°å¾Œç«¯API
  fetch('/game/api/catch-creature', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(creatureData)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('æ•æ‰ç²¾éˆå¤±æ•—');
    }
    return response.json();
  })
  .then(data => {
    console.log('æ•æ‰æˆåŠŸ:', data);
    
    // å¾åœ°åœ–ä¸Šå’Œåˆ—è¡¨ä¸­ç§»é™¤è©²ç²¾éˆ
    if (creature.marker) {
      creaturesLayer.removeLayer(creature.marker);
    }
    
    const index = routeCreatures.findIndex(c => c.id === creatureId);
    if (index !== -1) {
      routeCreatures.splice(index, 1);
    }
    
    // é¡¯ç¤ºæˆåŠŸæ¨¡æ…‹æ¡†
    document.getElementById('catchSuccessMessage').textContent = data.message;
    document.getElementById('caughtCreatureImage').src = creature.img;
    
    const successModal = new bootstrap.Modal(document.getElementById('catchSuccessModal'));
    successModal.show();
  })
  .catch(error => {
    console.error('æ•æ‰ç²¾éˆéŒ¯èª¤:', error);
    alert('æ•æ‰ç²¾éˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼');
  })
  .finally(() => {
    // éš±è—åŠ è¼‰ä¸­
    hideLoading();
  });
}

// ç²å–æ“‚å°åˆ—è¡¨
function fetchArenasInfo() {
  console.log('ç²å–æ“‚å°è³‡è¨Š');
  
  const arenaListElement = document.getElementById('arenaList');
  if (!arenaListElement) {
    console.error('æ‰¾ä¸åˆ°æ“‚å°åˆ—è¡¨å…ƒç´ ');
    return;
  }
  
  // å¦‚æœå°šæœªç²å–åˆ°æ“‚å°åˆ—è¡¨ï¼Œç­‰å¾…é“é¤¨åŠ è¼‰å®Œæˆ
  if (!window.busStopsArenas || Object.keys(window.busStopsArenas).length === 0) {
    console.log('å°šæœªç²å–åˆ°æ“‚å°åˆ—è¡¨ï¼Œç­‰å¾…ä¸€ç§’å¾Œé‡è©¦');
    setTimeout(fetchArenasInfo, 1000);
    return;
  }
  
  // æ¸…ç©ºåˆ—è¡¨
  arenaListElement.innerHTML = '';
  
  // å°‡æ“‚å°è³‡è¨Šè½‰æ›ç‚ºé™£åˆ—
  arenaList = Object.values(window.busStopsArenas);
  
  if (arenaList.length === 0) {
    arenaListElement.innerHTML = '<div class="col-12 text-center py-5"><p>æ‰¾ä¸åˆ°ä»»ä½•æ“‚å°è³‡è¨Š</p></div>';
    return;
  }
  
  // æŒ‰ç…§è·¯ç·šåˆ†çµ„
  const groupedArenas = {};
  
  arenaList.forEach(arena => {
    if (!groupedArenas[arena.routeName]) {
      groupedArenas[arena.routeName] = [];
    }
    groupedArenas[arena.routeName].push(arena);
  });
  
  // ç”ŸæˆHTML
  Object.keys(groupedArenas).forEach(routeName => {
    const arenas = groupedArenas[routeName];
    
    // æ·»åŠ è·¯ç·šæ¨™é¡Œ
    const routeColor = getRouteColorByName(routeName);
    const routeSection = document.createElement('div');
    routeSection.classList.add('col-12', 'mb-4');
    routeSection.innerHTML = `
      <div class="card">
        <div class="card-header" style="background-color:${routeColor};color:white;">
          <h5 class="mb-0">${routeName} ç«™é»é“é¤¨</h5>
        </div>
        <div class="card-body">
          <div class="row arena-route-row" id="arena-route-${routeName.replace(/[\(\)]/g, '')}"></div>
        </div>
      </div>
    `;
    arenaListElement.appendChild(routeSection);
    
    // æ·»åŠ è©²è·¯ç·šçš„æ“‚å°
    const routeRowElement = document.getElementById(`arena-route-${routeName.replace(/[\(\)]/g, '')}`);
    
    arenas.forEach(arena => {
      const arenaCard = document.createElement('div');
      arenaCard.classList.add('col-md-4', 'mb-3');
      arenaCard.innerHTML = `
        <div class="card arena-card">
          <div class="card-header text-center" style="background-color:${routeColor};color:white;">
            <h6 class="mb-0">${arena.name}</h6>
          </div>
          <div class="card-body text-center">
            <p><strong>ç­‰ç´š:</strong> ${arena.level} ç´š</p>
            <p><strong>ç«™é»:</strong> ${arena.stopName}</p>
            <button class="btn btn-danger mt-2 challenge-arena-btn" 
                  onclick="showArenaInfo('${arena.stopId}', '${arena.stopName}', '${arena.routeName}')">
              å‰å¾€é“é¤¨
            </button>
          </div>
        </div>
      `;
      routeRowElement.appendChild(arenaCard);
    });
  });
  
  console.log('æ“‚å°åˆ—è¡¨ç”Ÿæˆå®Œæˆ');
}

// æ ¹æ“šè·¯ç·šåç¨±ç²å–é¡è‰²
function getRouteColorByName(routeName) {
  if (routeName.includes('å³ç·š')) {
    return '#ff9800';
  } else if (routeName.includes('å·¦ç·š') && routeName.includes('å‹•ç‰©åœ’')) {
    return '#4caf50';
  } else if (routeName.includes('å·¦ç·š') && routeName.includes('æŒ‡å—å®®')) {
    return '#9c27b0';
  }
  return '#3498db'; // é è¨­è—è‰²
}

// ç•¶ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œåœ¨æ§åˆ¶å°è¼¸å‡ºéŒ¯èª¤ä¿¡æ¯
window.onerror = function(message, source, lineno, colno, error) {
  console.error('å…¨å±€éŒ¯èª¤:', message, 'at', source, lineno, colno);
  return false;
};
</script>
{% endblock %}