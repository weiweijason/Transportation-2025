{% extends 'base.html' %}

{% block title %}ç²¾éˆæ•æ‰{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #map {
    height: 500px;
    width: 100%;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 1;
  }
  
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    visibility: hidden;
  }
  
  .loading-spinner {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: conic-gradient(transparent, var(--primary-color));
    -webkit-mask: radial-gradient(white, transparent 70%);
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .route-line {
    display: inline-block;
    width: 20px;
    height: 4px;
    margin-right: 5px;
    vertical-align: middle;
    border-radius: 2px;
  }
  
  .bus-routes-legend {
    padding: 12px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .user-marker {
    z-index: 1000;
  }
  
  .arena-marker {
    width: 36px;
    height: 36px;
    z-index: 1000;
    filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.3));
    transition: all 0.3s;
  }
  
  .arena-marker:hover {
    transform: scale(1.2);
  }
  
  .creature-marker {
    z-index: 900;
    filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.3));
    animation: bounce 2s infinite;
  }
  
  @keyframes bounce {
    0%, 100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-10px);
    }
  }
  
  .game-tab-content {
    min-height: 600px;
  }
  
  /* éŠæˆ²åŒ–é ç±¤ */
  .game-tabs .nav-item {
    position: relative;
    z-index: 1;
  }
  
  .game-tabs .nav-link {
    border: none;
    padding: 12px 20px;
    font-weight: 600;
    color: #495057;
    border-radius: 10px 10px 0 0;
    margin-right: 5px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s;
  }
  
  .game-tabs .nav-link.active {
    color: white;
    background-color: var(--primary-color);
    box-shadow: 0 -3px 10px rgba(0,0,0,0.1);
  }
  
  .game-tabs .nav-link.active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: linear-gradient(120deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
    z-index: -1;
  }
  
  .game-tabs .nav-link:hover:not(.active) {
    background-color: rgba(0,0,0,0.05);
  }
  
  .game-tabs .nav-link i {
    margin-right: 8px;
  }
  
  /* æ“‚å°å¡ç‰‡ */
  .arena-card {
    transition: all 0.3s;
    background-position: center;
    background-size: cover;
    position: relative;
    overflow: hidden;
    min-height: 180px;
  }
  
  .arena-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.7) 100%);
    z-index: 0;
  }
  
  .arena-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
  }
  
  .arena-card-header {
    position: relative;
    z-index: 1;
    color: white;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
  }
  
  .arena-card-body {
    position: relative;
    z-index: 1;
    color: white;
  }
  
  .arena-level-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
    color: var(--dark-color);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 1;
  }
  
  /* æ•æ‰æˆåŠŸæ¨¡æ…‹æ¡† */
  .catch-modal .modal-content {
    border-radius: 20px;
    overflow: hidden;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  
  .catch-modal .modal-header {
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .catch-modal .modal-body {
    padding: 30px;
    text-align: center;
  }
  
  .catch-success-image {
    max-height: 200px;
    filter: drop-shadow(0px 5px 10px rgba(0,0,0,0.2));
    animation: float 3s ease-in-out infinite;
  }
  
  .catch-sparkle {
    position: absolute;
    width: 20px;
    height: 20px;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFD700"><path d="M12 0L14.59 9.41 24 12 14.59 14.59 12 24 9.41 14.59 0 12 9.41 9.41z"/></svg>');
    background-size: contain;
    opacity: 0.8;
    z-index: 10;
    pointer-events: none;
  }
  
  /* ç§»å‹•è¨­å‚™é©é… */
  @media (max-width: 767.98px) {
    #map {
      height: 350px;
    }
    
    .game-tabs .nav-link {
      padding: 8px 12px;
      font-size: 0.9rem;
    }
    
    .arena-card {
      min-height: 150px;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
    }
    
    .catch-success-image {
      max-height: 150px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="section-title text-center mb-4"><i class="fas fa-map-marked-alt me-2"></i>ç²¾éˆæ¢ç´¢æ•æ‰</h2>
  
  <!-- é ç±¤å°èˆª -->
  <ul class="nav nav-tabs game-tabs mb-4" id="gameTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-content" type="button" role="tab" aria-controls="map-content" aria-selected="true">
        <i class="fas fa-map"></i>è·¯ç·šåœ°åœ–
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="arenas-tab" data-bs-toggle="tab" data-bs-target="#arenas-content" type="button" role="tab" aria-controls="arenas-content" aria-selected="false">
        <i class="fas fa-trophy"></i>ç«™ç‰Œæ“‚å°
      </button>
    </li>
  </ul>
  
  <!-- é ç±¤å…§å®¹ -->
  <div class="tab-content game-tab-content" id="gameTabsContent">
    <!-- åœ°åœ–é ç±¤ -->
    <div class="tab-pane fade show active" id="map-content" role="tabpanel" aria-labelledby="map-tab">
      <div class="row">
        <div class="col-md-12">
          <div class="card shadow-lg mb-4">
            <div class="card-body p-3">
              <div id="map" class="mb-3"></div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="bus-routes-legend mb-3">
                    <h6 class="mb-2"><i class="fas fa-route me-2"></i>è·¯ç·šåœ–ä¾‹</h6>
                    <div class="d-flex flex-wrap">
                      <div class="me-4 mb-2 d-flex align-items-center">
                        <span class="route-line" style="background-color: #ff9800;"></span>
                        <span>è²“ç©ºå³ç·š</span>
                      </div>
                      <div class="me-4 mb-2 d-flex align-items-center">
                        <span class="route-line" style="background-color: #4caf50;"></span>
                        <span>è²“ç©ºå·¦ç·š(å‹•ç‰©åœ’)</span>
                      </div>
                      <div class="me-4 mb-2 d-flex align-items-center">
                        <span class="route-line" style="background-color: #9c27b0;"></span>
                        <span>è²“ç©ºå·¦ç·š(æŒ‡å—å®®)</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="current-location">
                      <p class="mb-0"><i class="fas fa-location-arrow me-2 text-primary"></i><strong>ç•¶å‰ä½ç½®:</strong> <span id="currentLocation" class="ms-2 badge bg-light text-dark">å°šæœªå®šä½</span></p>
                    </div>
                    <div class="d-flex gap-2">
                      <button id="refreshLocationBtn" class="btn btn-sm btn-primary">
                        <i class="fas fa-crosshairs me-1"></i>é‡æ–°å®šä½
                      </button>
                      <button id="initMapBtn" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-sync-alt me-1"></i>é‡æ•´åœ°åœ–
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- æç¤ºä¿¡æ¯ -->
              <div class="alert alert-info mt-3">
                <div class="d-flex">
                  <div class="me-3">
                    <i class="fas fa-info-circle fa-2x"></i>
                  </div>
                  <div>
                    <h5 class="alert-heading">éŠæˆ²æç¤º</h5>
                    <p class="mb-0">åœ°åœ–ä¸Šå°‡éš¨æ©Ÿç”Ÿæˆç²¾éˆï¼Œé»æ“Šæ¨™è¨˜å¯ä»¥å˜—è©¦æ•æ‰ã€‚é è¿‘ç«™ç‰Œæ™‚ï¼Œæ‚¨å¯ä»¥æŒ‘æˆ°è©²ç«™ç‰Œçš„æ“‚å°ï¼</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ“‚å°é ç±¤ -->
    <div class="tab-pane fade" id="arenas-content" role="tabpanel" aria-labelledby="arenas-tab">
      <div class="row">
        <div class="col-md-12">
          <div class="card shadow-lg mb-4">
            <div class="card-header bg-danger text-white">
              <h5 class="card-title mb-0"><i class="fas fa-trophy me-2"></i>ç«™ç‰Œæ“‚å°æŒ‘æˆ°</h5>
            </div>
            <div class="card-body">
              <p class="mb-3">é€™äº›æ˜¯è²“ç©ºçºœè»Šè·¯ç·šä¸Šçš„ç«™ç‰Œæ“‚å°ï¼ˆé“é¤¨ï¼‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ‚¨çš„ç²¾éˆæŒ‘æˆ°ä¸¦ä½”é ˜å®ƒå€‘ï¼æ“Šæ•—ç•¶å‰çš„æ“‚ä¸»å³å¯æˆç‚ºæ–°çš„æ“‚ä¸»ã€‚</p>
              
              <!-- æ“‚å°åˆ—è¡¨ -->
              <div id="arenaList" class="row g-3">
                <!-- æ“‚å°åˆ—è¡¨å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                <div class="col-12 text-center py-5">
                  <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">æ­£åœ¨åŠ è¼‰æ“‚å°è³‡è¨Š...</span>
                  </div>
                  <p class="mt-2">æ­£åœ¨åŠ è¼‰æ“‚å°è³‡è¨Š...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- åŠ è¼‰ä¸­é®ç½© -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<!-- æ•æ‰æˆåŠŸæ¨¡æ…‹æ¡† -->
<div class="modal fade catch-modal" id="catchSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white text-center">
        <h5 class="modal-title w-100"><i class="fas fa-check-circle me-2"></i>æ•æ‰æˆåŠŸï¼</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body position-relative">
        <p id="catchSuccessMessage" class="lead"></p>
        <div class="text-center mb-3">
          <img id="caughtCreatureImage" src="" alt="æ•æ‰åˆ°çš„ç²¾éˆ" class="catch-success-image">
          <!-- è£é£¾æ€§é–ƒå…‰æ•ˆæœ -->
          <div class="catch-sparkle" style="top:20%; left:30%;"></div>
          <div class="catch-sparkle" style="top:15%; left:60%;"></div>
          <div class="catch-sparkle" style="top:50%; left:20%;"></div>
          <div class="catch-sparkle" style="top:60%; left:70%;"></div>
          <div class="catch-sparkle" style="top:30%; left:80%;"></div>
        </div>
        <div class="creature-stats d-flex justify-content-around mb-4">
          <div class="stat-item text-center">
            <span class="d-block fs-4 fw-bold text-primary" id="creature-power">--</span>
            <span class="small text-muted">åŠ›é‡</span>
          </div>
          <div class="stat-item text-center">
            <span class="d-block fs-4 fw-bold text-success" id="creature-type">--</span>
            <span class="small text-muted">å±¬æ€§</span>
          </div>
          <div class="stat-item text-center">
            <span class="d-block fs-4 fw-bold text-warning" id="creature-rarity">--</span>
            <span class="small text-muted">ç¨€æœ‰åº¦</span>
          </div>
        </div>
        <p class="mb-0 text-center">è©²ç²¾éˆå·²è¢«æ·»åŠ åˆ°æ‚¨çš„æ”¶è—ä¸­ï¼</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ç¹¼çºŒæ¢ç´¢</button>
        <a href="{{ url_for('main.profile') }}" class="btn btn-primary">
          <i class="fas fa-book me-1"></i>æŸ¥çœ‹æˆ‘çš„ç²¾éˆ
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- è¼‰å…¥Leafletåº« -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- å¼•å…¥å…¬è»Šè·¯ç·šåœ°åœ–ç›¸é—œJS -->
<script src="{{ url_for('static', filename='js/bus-route-map.js') }}"></script>

<!-- ç”Ÿæˆç²¾éˆå’Œåˆå§‹åŒ–åœ°åœ– -->
<script>
// å…¨å±€è®Šæ•¸
var gameMap;
var arenaList = [];
var currentCreatures = [];
var capturedCreatures = 0;

// é é¢è¼‰å…¥å®Œæˆäº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMå…§å®¹è¼‰å…¥å®Œæˆ');
  
  // åˆå§‹åŒ–åœ°åœ– (ä½¿ç”¨ä¸€å€‹å»¶é²ç¢ºä¿DOMå®Œå…¨æ¸²æŸ“)
  setTimeout(initializeMap, 500);
  
  // ç¶å®šæ›´æ–°ä½ç½®æŒ‰éˆ•
  document.getElementById('refreshLocationBtn').addEventListener('click', function() {
    console.log('é»æ“Šäº†é‡æ–°å®šä½æŒ‰éˆ•');
    showLoading();
    if (typeof updateUserLocation === 'function') {
      updateUserLocation().then(() => {
        hideLoading();
      }).catch(() => {
        hideLoading();
        showGameAlert('ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®ï¼Œè«‹ç¢ºä¿å·²æˆäºˆä½ç½®æ¬Šé™ã€‚', 'warning');
      });
    } else {
      console.error('updateUserLocation å‡½æ•¸ä¸å­˜åœ¨');
      hideLoading();
    }
  });
  
  // ç¶å®šé‡æ–°è¼‰å…¥åœ°åœ–æŒ‰éˆ•
  document.getElementById('initMapBtn').addEventListener('click', function() {
    console.log('é»æ“Šäº†é‡æ–°è¼‰å…¥åœ°åœ–æŒ‰éˆ•');
    showLoading();
    initializeMap();
    setTimeout(hideLoading, 1000);
  });
  
  // è™•ç†é ç±¤åˆ‡æ›äº‹ä»¶ï¼Œç¢ºä¿åœ°åœ–æ­£ç¢ºæ¸²æŸ“
  const mapTab = document.getElementById('map-tab');
  if (mapTab) {
    mapTab.addEventListener('shown.bs.tab', function() {
      console.log('åœ°åœ–é ç±¤è¢«å•Ÿç”¨');
      if (gameMap) {
        console.log('èª¿æ•´åœ°åœ–å¤§å°');
        gameMap.invalidateSize();
      } else {
        console.log('åœ°åœ–æœªåˆå§‹åŒ–ï¼Œå˜—è©¦åˆå§‹åŒ–');
        initializeMap();
      }
    });
  }
  
  // æ›´æ–°æ“‚å°åˆ—è¡¨ç•¶æ“‚å°æ¨™ç±¤è¢«é»æ“Šæ™‚
  const arenasTab = document.getElementById('arenas-tab');
  if (arenasTab) {
    arenasTab.addEventListener('shown.bs.tab', function() {
      console.log('æ“‚å°é ç±¤è¢«å•Ÿç”¨');
      fetchArenasInfo();
    });
  }
  
  // åˆå§‹åŒ–æ•æ‰æ¨¡æ…‹æ¡†å‹•ç•«æ•ˆæœ
  initCatchModal();
});

// åˆå§‹åŒ–åœ°åœ–çš„å‡½æ•¸
function initializeMap() {
  console.log('é–‹å§‹åˆå§‹åŒ–åœ°åœ–...');
  try {
    // ä½¿ç”¨ bus-route-map.js ä¸­çš„åˆå§‹åŒ–å‡½æ•¸
    gameMap = initMap('map');
    
    if (gameMap) {
      console.log('åœ°åœ–æˆåŠŸåˆå§‹åŒ–');
      
      // åŠ è¼‰è·¯ç·š
      console.log('è¼‰å…¥è·¯ç·š');
      loadCatRightRoute();
      loadCatLeftRoute();
      loadCatLeftZhinanRoute();
      
      // åŠ è¼‰ç«™é»å’Œé“é¤¨
      console.log('è¼‰å…¥ç«™é»å’Œé“é¤¨');
      loadAllBusStops();
      
      // èª¿æ•´åœ°åœ–å¤§å°ä»¥ç¢ºä¿æ­£ç¢ºæ¸²æŸ“
      setTimeout(function() {
        console.log('èª¿æ•´åœ°åœ–å¤§å°');
        gameMap.invalidateSize();
      }, 500);
      
      // è¨­ç½®ç²¾éˆç”Ÿæˆå®šæ™‚å™¨
      console.log('è¨­ç½®ç²¾éˆç”Ÿæˆå®šæ™‚å™¨');
      startCreatureSpawning();
      
      // æ›´æ–°ç”¨æˆ¶ä½ç½®
      updateUserLocation();
      
      hideLoading();
    } else {
      console.error('åœ°åœ–åˆå§‹åŒ–å¤±æ•—ï¼ŒgameMap ç‚º null');
      hideLoading();
      showGameAlert('åœ°åœ–åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦ã€‚', 'danger');
    }
  } catch (error) {
    console.error('åˆå§‹åŒ–åœ°åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    hideLoading();
    showGameAlert('åˆå§‹åŒ–åœ°åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'danger');
  }
}

// ç²¾éˆç”Ÿæˆç›¸é—œå‡½æ•¸
function startCreatureSpawning() {
  console.log('é–‹å§‹ç²¾éˆç”Ÿæˆç³»çµ±');
  
  // æ¸…é™¤ç¾æœ‰ç²¾éˆ
  if (creaturesLayer) {
    creaturesLayer.clearLayers();
  }
  currentCreatures = [];
  
  // åˆå§‹ç”Ÿæˆä¸€äº›ç²¾éˆ
  spawnCreaturesOnRoutes();
  
  // å®šæ™‚ç”Ÿæˆæ–°ç²¾éˆ
  setInterval(spawnCreaturesOnRoutes, SPAWN_INTERVAL);
}

// åœ¨è·¯ç·šä¸Šç”Ÿæˆç²¾éˆ
function spawnCreaturesOnRoutes() {
  console.log('å˜—è©¦åœ¨è·¯ç·šä¸Šç”Ÿæˆç²¾éˆ');
  
  // ç§»é™¤è¶…éå­˜åœ¨æ™‚é–“çš„ç²¾éˆ
  const currentTime = Date.now();
  currentCreatures = currentCreatures.filter(creature => {
    if (currentTime > creature.spawnTime + CREATURE_LIFETIME) {
      console.log(`ç²¾éˆ ${creature.name} å­˜åœ¨æ™‚é–“åˆ°ï¼Œæ¶ˆå¤±`);
      if (creature.marker) {
        creaturesLayer.removeLayer(creature.marker);
      }
      return false;
    }
    return true;
  });
  
  // ç‚ºæ¯æ¢è·¯ç·šå˜—è©¦ç”Ÿæˆç²¾éˆ
  Object.keys(routeCoordinates).forEach(routeKey => {
    // æª¢æŸ¥è©²è·¯ç·šä¸Šçš„ç²¾éˆæ•¸é‡
    const routeCreatureCount = currentCreatures.filter(c => c.routeKey === routeKey).length;
    
    // å¦‚æœè©²è·¯ç·šç²¾éˆæ•¸é‡æœªé”åˆ°ä¸Šé™ï¼Œå˜—è©¦ç”Ÿæˆ
    if (routeCreatureCount < MAX_CREATURES_PER_ROUTE) {
      // æª¢æŸ¥ç”Ÿæˆæ©Ÿç‡
      if (Math.random() < SPAWN_CHANCE) {
        // ç²å–è·¯ç·šåº§æ¨™
        const coordinates = routeCoordinates[routeKey];
        
        if (coordinates.length > 0) {
          // å¾è·¯ç·šä¸Šéš¨æ©Ÿé¸æ“‡ä¸€å€‹ä½ç½®
          const randomIndex = Math.floor(Math.random() * coordinates.length);
          const position = coordinates[randomIndex];
          
          // å¾è©²è·¯ç·šçš„ç²¾éˆåˆ—è¡¨ä¸­éš¨æ©Ÿé¸æ“‡ä¸€ç¨®
          const routeCreatureList = routeCreatureTypes[routeKey];
          const randomCreatureIndex = Math.floor(Math.random() * routeCreatureList.length);
          const creatureTemplate = routeCreatureList[randomCreatureIndex];
          
          // å‰µå»ºç²¾éˆå¯¦ä¾‹
          const creatureId = `${creatureTemplate.id}-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
          const creature = {
            ...creatureTemplate,
            id: creatureId,
            position: position,
            routeKey: routeKey,
            spawnTime: Date.now()
          };
          
          // å‰µå»ºç²¾éˆåœ–æ¨™
          const creatureIcon = L.divIcon({
            className: 'creature-marker',
            html: `
              <div style="
                width: 40px;
                height: 40px;
                background-color: ${routeColors[routeKey]};
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                border: 2px solid white;
                box-shadow: 0 0 5px rgba(0,0,0,0.5);
                color: white;
                font-weight: bold;
                font-size: 18px;
                cursor: pointer;
              ">
                ${getCreatureEmoji(creature.type)}
              </div>
            `,
            iconSize: [40, 40],
            iconAnchor: [20, 20]
          });
          
          // å‰µå»ºåœ°åœ–æ¨™è¨˜
          const marker = L.marker(position, {
            icon: creatureIcon,
            zIndexOffset: 900
          }).addTo(creaturesLayer);
          
          // ç¶å®šå½ˆå‡ºæ¡†
          marker.bindPopup(`
            <div class="text-center py-2">
              <h5 class="mb-2">${creature.name}</h5>
              <p class="mb-2">
                <span class="badge ${getTypeBadgeClass(creature.type)}">${creature.type}</span>
                <span class="badge ${getRarityBadgeClass(creature.rarity)}">${creature.rarity}</span>
              </p>
              <p class="mb-3"><strong>åŠ›é‡:</strong> ${creature.power}</p>
              <button class="btn btn-success btn-sm w-100 catch-btn" onclick="catchCreature('${creature.id}')">
                <i class="fas fa-hand-sparkles me-1"></i>æ•æ‰
              </button>
            </div>
          `);
          
          // é»æ“Šç²¾éˆç›´æ¥æ‰“é–‹å½ˆå‡ºæ¡†
          marker.on('click', function() {
            marker.openPopup();
          });
          
          // ä¿å­˜æ¨™è¨˜å¼•ç”¨
          creature.marker = marker;
          
          // æ·»åŠ åˆ°ç²¾éˆåˆ—è¡¨
          currentCreatures.push(creature);
          
          console.log(`åœ¨ ${routeKey} è·¯ç·šä¸Šç”Ÿæˆç²¾éˆ: ${creature.name}`);
        }
      }
    }
  });
}

// æ•æ‰ç²¾éˆçš„å‡½æ•¸
function catchCreature(creatureId) {
  // å°‹æ‰¾å°æ‡‰çš„ç²¾éˆè³‡è¨Š
  const creature = currentCreatures.find(c => c.id === creatureId);
  if (!creature) {
    console.error('æ‰¾ä¸åˆ°æŒ‡å®šç²¾éˆ:', creatureId);
    showGameAlert('é€™å€‹ç²¾éˆå·²ç¶“æ¶ˆå¤±äº†ï¼Œè«‹å°‹æ‰¾å…¶ä»–ç²¾éˆã€‚', 'warning');
    return;
  }
  
  // é¡¯ç¤ºåŠ è¼‰ä¸­
  showLoading();
  
  // å‡†å‚™è¦ç™¼é€åˆ°å¾Œç«¯çš„è³‡æ–™
  const creatureData = {
    creatureId: creature.id,
    creatureName: creature.name,
    creatureType: creature.type,
    creatureRarity: creature.rarity,
    creaturePower: creature.power,
    creatureImg: creature.img || `https://placehold.co/200x200/${getTypeColor(creature.type)}/white?text=${encodeURIComponent(creature.name)}`
  };
  
  // ç™¼é€åˆ°å¾Œç«¯API
  fetch('/game/api/catch-creature', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(creatureData)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('æ•æ‰ç²¾éˆå¤±æ•—');
    }
    return response.json();
  })
  .then(data => {
    console.log('æ•æ‰æˆåŠŸ:', data);
    
    // å¾åœ°åœ–ä¸Šå’Œåˆ—è¡¨ä¸­ç§»é™¤è©²ç²¾éˆ
    if (creature.marker) {
      creaturesLayer.removeLayer(creature.marker);
    }
    
    const index = currentCreatures.findIndex(c => c.id === creatureId);
    if (index !== -1) {
      currentCreatures.splice(index, 1);
    }
    
    // æ›´æ–°æ•æ‰æ•¸é‡
    capturedCreatures++;
    
    // æ›´æ–°UIä¸­çš„ç²¾éˆè³‡è¨Š
    document.getElementById('creature-power').textContent = creature.power;
    document.getElementById('creature-type').textContent = creature.type;
    document.getElementById('creature-rarity').textContent = creature.rarity;
    
    // é¡¯ç¤ºæˆåŠŸæ¨¡æ…‹æ¡†
    document.getElementById('catchSuccessMessage').textContent = `æ­å–œï¼ä½ æˆåŠŸæ•æ‰åˆ°äº† ${creature.name}ï¼`;
    document.getElementById('caughtCreatureImage').src = creature.img || `https://placehold.co/200x200/${getTypeColor(creature.type)}/white?text=${encodeURIComponent(creature.name)}`;
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†ä¸¦å•Ÿå‹•å‹•ç•«
    const successModal = new bootstrap.Modal(document.getElementById('catchSuccessModal'));
    successModal.show();
    animateSparkles();
    
    // æ’­æ”¾æ•æ‰æˆåŠŸéŸ³æ•ˆ
    playCatchSound();
    
    hideLoading();
  })
  .catch(error => {
    console.error('æ•æ‰ç²¾éˆéŒ¯èª¤:', error);
    hideLoading();
    showGameAlert('æ•æ‰ç²¾éˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼', 'danger');
  });
}

// æ ¹æ“šç²¾éˆé¡å‹ç²å–é¡è‰²
function getTypeColor(type) {
  switch(type) {
    case 'æ°´ç³»': return '3498db';
    case 'ç«ç³»': return 'e74c3c';
    case 'åœŸç³»': return 'd35400';
    case 'é¢¨ç³»': return '9b59b6';
    case 'é›»ç³»': return 'f1c40f';
    default: return '3498db';
  }
}

// æ ¹æ“šç²¾éˆé¡å‹ç²å–å¾½ç« é¡åˆ¥
function getTypeBadgeClass(type) {
  switch(type) {
    case 'æ°´ç³»': return 'bg-primary';
    case 'ç«ç³»': return 'bg-danger';
    case 'åœŸç³»': return 'bg-warning';
    case 'é¢¨ç³»': return 'bg-info';
    case 'é›»ç³»': return 'bg-warning';
    default: return 'bg-secondary';
  }
}

// æ ¹æ“šç¨€æœ‰åº¦ç²å–å¾½ç« é¡åˆ¥
function getRarityBadgeClass(rarity) {
  switch(rarity) {
    case 'æ™®é€š': return 'bg-secondary';
    case 'ç¨€æœ‰': return 'bg-info';
    case 'å²è©©': return 'bg-primary';
    case 'å‚³èªª': return 'bg-danger';
    default: return 'bg-secondary';
  }
}

// æ ¹æ“šç²¾éˆé¡å‹ç²å–è¡¨æƒ…ç¬¦è™Ÿ
function getCreatureEmoji(type) {
  switch(type) {
    case 'æ°´ç³»': return 'ğŸ’§';
    case 'ç«ç³»': return 'ğŸ”¥';
    case 'åœŸç³»': return 'ğŸŒ±';
    case 'é¢¨ç³»': return 'ğŸ’¨';
    case 'é›»ç³»': return 'âš¡';
    default: return 'âœ¨';
  }
}

// ç²å–æ“‚å°åˆ—è¡¨
function fetchArenasInfo() {
  console.log('ç²å–æ“‚å°è³‡è¨Š');
  showLoading();
  
  const arenaListElement = document.getElementById('arenaList');
  if (!arenaListElement) {
    console.error('æ‰¾ä¸åˆ°æ“‚å°åˆ—è¡¨å…ƒç´ ');
    hideLoading();
    return;
  }
  
  // å¦‚æœå°šæœªç²å–åˆ°æ“‚å°åˆ—è¡¨ï¼Œç­‰å¾…é“é¤¨åŠ è¼‰å®Œæˆ
  if (!window.busStopsArenas || Object.keys(window.busStopsArenas).length === 0) {
    console.log('å°šæœªç²å–åˆ°æ“‚å°åˆ—è¡¨ï¼Œç­‰å¾…ä¸€ç§’å¾Œé‡è©¦');
    setTimeout(fetchArenasInfo, 1000);
    return;
  }
  
  // æ¸…ç©ºåˆ—è¡¨
  arenaListElement.innerHTML = '';
  
  // å°‡æ“‚å°è³‡è¨Šè½‰æ›ç‚ºé™£åˆ—
  arenaList = Object.values(window.busStopsArenas);
  
  if (arenaList.length === 0) {
    arenaListElement.innerHTML = '<div class="col-12 text-center py-5"><p>æ‰¾ä¸åˆ°ä»»ä½•æ“‚å°è³‡è¨Š</p></div>';
    hideLoading();
    return;
  }
  
  // æŒ‰ç…§è·¯ç·šåˆ†çµ„
  const groupedArenas = {};
  
  arenaList.forEach(arena => {
    if (!groupedArenas[arena.routeName]) {
      groupedArenas[arena.routeName] = [];
    }
    groupedArenas[arena.routeName].push(arena);
  });
  
  // ç”ŸæˆHTML
  Object.keys(groupedArenas).forEach(routeName => {
    const arenas = groupedArenas[routeName];
    
    // æ·»åŠ è·¯ç·šæ¨™é¡Œ
    const routeColor = getRouteColorByName(routeName);
    arenaListElement.innerHTML += `
      <div class="col-12 mb-3">
        <div class="d-flex align-items-center mb-2">
          <span class="route-line" style="background-color:${routeColor};"></span>
          <h5 class="mb-0">${routeName} ç«™é»é“é¤¨</h5>
        </div>
      </div>
    `;
    
    // æ·»åŠ è©²è·¯ç·šçš„æ“‚å°
    arenas.forEach(arena => {
      const arenaCard = document.createElement('div');
      arenaCard.className = 'col-md-4 col-sm-6 mb-3';
      arenaCard.innerHTML = `
        <div class="card arena-card" style="background-image: url('https://placehold.co/600x400/${routeColor.replace('#', '')}/white?text=${encodeURIComponent(arena.stopName)}')">
          <div class="arena-level-badge">${arena.level}</div>
          <div class="card-header arena-card-header text-center">
            <h5 class="mb-0">${arena.stopName}</h5>
          </div>
          <div class="card-body arena-card-body d-flex flex-column justify-content-end">
            <div class="arena-status mb-2">
              <p class="mb-0"><small>æ“‚ä¸»: ${arena.owner || 'ç„¡'}</small></p>
              <p class="mb-0"><small>å®ˆè­·ç²¾éˆ: ${arena.guardianName || 'ç„¡'}</small></p>
            </div>
            <button class="btn btn-light btn-sm challenge-arena-btn" 
                  onclick="goToArena('${arena.stopId}', '${arena.stopName}', '${arena.routeName}')">
              <i class="fas fa-trophy me-1"></i>å‰å¾€é“é¤¨
            </button>
          </div>
        </div>
      `;
      arenaListElement.appendChild(arenaCard);
    });
  });
  
  console.log('æ“‚å°åˆ—è¡¨ç”Ÿæˆå®Œæˆ');
  hideLoading();
}

// å‰å¾€é“é¤¨çš„å‡½æ•¸
function goToArena(stopId, stopName, routeName) {
  // ç²å–ç›®å‰ä½ç½®ï¼ˆç”¨æ–¼latå’Œlonåƒæ•¸ï¼‰
  const location = userLocation || [25.0282, 121.5432]; // é»˜èªä½ç½®
  
  window.location.href = `/game/battle?stopId=${stopId}&stopName=${encodeURIComponent(stopName)}&routeName=${encodeURIComponent(routeName)}&lat=${location[0]}&lon=${location[1]}`;
}

// æ ¹æ“šè·¯ç·šåç¨±ç²å–é¡è‰²
function getRouteColorByName(routeName) {
  if (routeName.includes('å³ç·š')) {
    return '#ff9800';
  } else if (routeName.includes('å·¦ç·š') && routeName.includes('å‹•ç‰©åœ’')) {
    return '#4caf50';
  } else if (routeName.includes('å·¦ç·š') && routeName.includes('æŒ‡å—å®®')) {
    return '#9c27b0';
  }
  return '#3498db'; // é è¨­è—è‰²
}

// é¡¯ç¤ºéŠæˆ²æç¤º
function showGameAlert(message, type = 'info') {
  const alertContainer = document.createElement('div');
  alertContainer.className = `alert alert-${type} alert-dismissible fade show game-alert position-fixed`;
  alertContainer.style.top = '80px';
  alertContainer.style.right = '20px';
  alertContainer.style.zIndex = '9999';
  alertContainer.style.maxWidth = '300px';
  alertContainer.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.2)';
  
  alertContainer.innerHTML = `
    <div class="d-flex">
      <div class="me-3">
        <i class="fas fa-${type === 'danger' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
      </div>
      <div>${message}</div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  
  document.body.appendChild(alertContainer);
  
  // è‡ªå‹•æ¶ˆå¤±
  setTimeout(() => {
    const bsAlert = new bootstrap.Alert(alertContainer);
    bsAlert.close();
  }, 5000);
}

// åˆå§‹åŒ–æ•æ‰æ¨¡æ…‹æ¡†å‹•ç•«
function initCatchModal() {
  const modal = document.getElementById('catchSuccessModal');
  if (modal) {
    modal.addEventListener('shown.bs.modal', function() {
      animateSparkles();
    });
  }
}

// é–ƒå…‰å‹•ç•«
function animateSparkles() {
  const sparkles = document.querySelectorAll('.catch-sparkle');
  sparkles.forEach(sparkle => {
    // é‡ç½®å‹•ç•«
    sparkle.style.animation = 'none';
    sparkle.offsetHeight; // è§¸ç™¼é‡æ’
    
    // éš¨æ©Ÿä½ç½®
    const top = 10 + Math.random() * 80;
    const left = 10 + Math.random() * 80;
    sparkle.style.top = `${top}%`;
    sparkle.style.left = `${left}%`;
    
    // éš¨æ©Ÿå¤§å°
    const size = 10 + Math.random() * 20;
    sparkle.style.width = `${size}px`;
    sparkle.style.height = `${size}px`;
    
    // éš¨æ©Ÿå‹•ç•«
    const duration = 1 + Math.random() * 2;
    const delay = Math.random() * 0.5;
    sparkle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite alternate`;
  });
}

// æ’­æ”¾æ•æ‰æˆåŠŸéŸ³æ•ˆ
function playCatchSound() {
  // å¦‚æœå¯ä»¥ï¼Œé€™è£¡å¯ä»¥æ·»åŠ è²éŸ³æ•ˆæœ
  console.log('æ’­æ”¾æ•æ‰æˆåŠŸéŸ³æ•ˆ');
}

// é¡¯ç¤ºè¼‰å…¥ä¸­
function showLoading() {
  document.getElementById('loadingOverlay').style.visibility = 'visible';
}

// éš±è—è¼‰å…¥ä¸­
function hideLoading() {
  document.getElementById('loadingOverlay').style.visibility = 'hidden';
}

// ç•¶ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œåœ¨æ§åˆ¶å°è¼¸å‡ºéŒ¯èª¤ä¿¡æ¯
window.onerror = function(message, source, lineno, colno, error) {
  console.error('å…¨å±€éŒ¯èª¤:', message, 'at', source, lineno, colno);
  hideLoading();
  return false;
};
</script>
{% endblock %}