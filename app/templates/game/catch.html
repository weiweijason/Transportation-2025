{% extends "base.html" %}

{% block title %}捕捉精靈 - 精靈公車{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS (OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .location-info {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 0 5px rgba(0,0,0,0.05);
    }
    .creature-container {
        margin-top: 30px;
    }
    .creature-card {
        border-radius: 15px;
        transition: transform 0.3s;
        margin-bottom: 20px;
        overflow: hidden;
    }
    .creature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .catch-btn {
        width: 100%;
        margin-top: 10px;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        visibility: hidden;
    }
    .spinner {
        width: 50px;
        height: 50px;
    }
    .bus-routes-legend {
        padding: 10px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    }
    .route-line {
        display: inline-block;
        width: 30px;
        height: 3px;
        margin-right: 8px;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary spinner" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
</div>

<h1 class="mb-4">精靈探索</h1>
<p class="lead">探索周圍環境，發現並捕捉特殊的公車精靈！</p>

<div class="alert alert-info">
    <i class="bi bi-info-circle-fill"></i> 提示：移動到不同的公車站點附近會增加發現稀有精靈的機會。
</div>

<!-- 地圖區域 -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title mb-3">貓空右線探索地圖</h5>
        
        <div id="map"></div>
        
        <div class="location-info">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>當前位置：</strong> <span id="currentLocation">載入中...</span></p>
                    <p><strong>附近公車站：</strong> <span id="nearbyStops">搜尋中...</span></p>
                </div>
                <div class="col-md-6 text-end">
                    <button id="refreshLocationBtn" class="btn btn-primary">
                        <i class="bi bi-geo-alt"></i> 重新定位
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 可捕捉的精靈區域 -->
<div class="creature-container" id="creatureContainer">
    <h3 class="mb-4">附近的精靈</h3>
    <div class="row" id="creatureList">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">搜尋中...</span>
            </div>
            <p class="mt-3">正在搜尋附近的精靈...</p>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Leaflet JS (OpenStreetMap) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- 引入公車路線地圖 JS -->
<script src="{{ url_for('static', filename='js/bus-route-map.js') }}"></script>
<script>
    // 精靈相關變數
    const creatureTypes = [
        { name: '火焰雄獅', type: '火', rarity: '稀有', power: 75, img: 'https://placehold.co/300x200/ff5733/ffffff?text=火焰雄獅' },
        { name: '水晶海豚', type: '水', rarity: '普通', power: 50, img: 'https://placehold.co/300x200/33a1ff/ffffff?text=水晶海豚' },
        { name: '翠綠蜥蜴', type: '草', rarity: '普通', power: 45, img: 'https://placehold.co/300x200/4caf50/ffffff?text=翠綠蜥蜴' },
        { name: '雷電貓頭鷹', type: '電', rarity: '稀有', power: 70, img: 'https://placehold.co/300x200/ffd700/ffffff?text=雷電貓頭鷹' },
        { name: '星塵兔子', type: '一般', rarity: '普通', power: 40, img: 'https://placehold.co/300x200/8c9eff/ffffff?text=星塵兔子' }
    ];
    
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化地圖（bus-route-map.js 中已實現）
        initMap('map');
        
        // 直接加載貓空右線，無需用戶選擇
        loadCatRightRoute();
        
        // 重新定位按鈕事件
        document.getElementById('refreshLocationBtn').addEventListener('click', function() {
            updateUserLocation();
        });
        
        // 其他頁面初始化代碼...
        // 根據用戶位置生成附近精靈
        generateNearbyCreatures();
    });
    
    // 根據用戶位置生成附近的精靈
    function generateNearbyCreatures() {
        // 模擬獲取附近的精靈
        // 在實際應用中，這裡可以根據用戶位置和公車路線進行更複雜的計算
        
        const creatureList = document.getElementById('creatureList');
        creatureList.innerHTML = ''; // 清空現有內容
        
        // 隨機選擇2-4個精靈
        const creatureCount = Math.floor(Math.random() * 3) + 2;
        
        for (let i = 0; i < creatureCount; i++) {
            // 隨機選擇一個精靈類型
            const creatureIndex = Math.floor(Math.random() * creatureTypes.length);
            const creature = creatureTypes[creatureIndex];
            
            // 創建精靈卡片
            const creatureCard = document.createElement('div');
            creatureCard.className = 'col-md-4 col-sm-6';
            creatureCard.innerHTML = `
                <div class="card creature-card">
                    <img src="${creature.img}" class="card-img-top" alt="${creature.name}">
                    <div class="card-body">
                        <h5 class="card-title">${creature.name}</h5>
                        <p class="card-text">
                            類型: <span class="badge bg-${getTypeBadgeColor(creature.type)}">${creature.type}</span><br>
                            稀有度: ${creature.rarity}<br>
                            力量: ${creature.power}
                        </p>
                        <button class="btn btn-success catch-btn" data-creature-id="${creatureIndex}">捕捉</button>
                    </div>
                </div>
            `;
            
            creatureList.appendChild(creatureCard);
        }
        
        // 為所有捕捉按鈕添加事件
        document.querySelectorAll('.catch-btn').forEach(button => {
            button.addEventListener('click', function() {
                const creatureId = this.getAttribute('data-creature-id');
                catchCreature(creatureId);
            });
        });
    }
    
    // 根據精靈類型獲取適合的 Bootstrap 徽章顏色
    function getTypeBadgeColor(type) {
        switch (type) {
            case '火': return 'danger';
            case '水': return 'primary';
            case '草': return 'success';
            case '電': return 'warning';
            default: return 'secondary';
        }
    }
    
    // 處理精靈捕捉
    function catchCreature(creatureId) {
        const creature = creatureTypes[creatureId];
        
        // 模擬捕捉成功率 (在實際應用中，這可能與玩家等級、道具等有關)
        const successRate = creature.rarity === '稀有' ? 0.6 : 0.8;
        const isSuccess = Math.random() < successRate;
        
        if (isSuccess) {
            alert(`恭喜！你成功捕捉了 ${creature.name}！`);
            // 在實際應用中，這裡可以調用 API 將精靈添加到玩家的收藏中
        } else {
            alert(`可惜！${creature.name} 逃走了！再試一次吧！`);
        }
        
        // 重新生成精靈
        generateNearbyCreatures();
    }
</script>
{% endblock %}