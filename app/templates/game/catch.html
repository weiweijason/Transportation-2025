{% extends "base.html" %}

{% block title %}捕捉精靈 - 精靈公車{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS (OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .location-info {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 0 5px rgba(0,0,0,0.05);
    }
    .creature-container {
        margin-top: 30px;
    }
    .creature-card {
        border-radius: 15px;
        transition: transform 0.3s;
        margin-bottom: 20px;
        overflow: hidden;
    }
    .creature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .catch-btn {
        width: 100%;
        margin-top: 10px;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        visibility: hidden;
    }
    .spinner {
        width: 50px;
        height: 50px;
    }
    .bus-routes-legend {
        padding: 10px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    }
    .route-line {
        display: inline-block;
        width: 30px;
        height: 3px;
        margin-right: 8px;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary spinner" role="status">
        <span class="visually-hidden">載入中...</span>
    </div>
</div>

<h1 class="mb-4">精靈探索</h1>
<p class="lead">探索公車路線，發現並捕捉特殊的公車精靈！</p>

<div class="alert alert-info">
    <i class="bi bi-info-circle-fill"></i> 提示：不同的公車路線會出現不同種類的精靈，路線重疊處可能會出現多種路線的精靈。
</div>

<!-- 地圖區域 -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title mb-3">公車路線探索地圖</h5>
        
        <div id="map"></div>
        
        <div class="location-info">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>當前位置：</strong> <span id="currentLocation">載入中...</span></p>
                    <p><strong>精靈生成：</strong> 路線上精靈每5分鐘更新一次，每分鐘有80%機率生成</p>
                </div>
                <div class="col-md-6 text-end">
                    <button id="refreshLocationBtn" class="btn btn-primary">
                        <i class="bi bi-geo-alt"></i> 重新定位
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 可捕捉的精靈區域 -->
<div class="creature-container" id="creatureContainer">
    <h3 class="mb-4">路線上的精靈</h3>
    <div class="row" id="creatureList">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">搜尋中...</span>
            </div>
            <p class="mt-3">正在搜尋路線上的精靈...</p>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Leaflet JS (OpenStreetMap) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- 引入公車路線地圖 JS -->
<script src="{{ url_for('static', filename='js/bus-route-map.js') }}"></script>
<script>
    // 處理精靈捕捉
    function catchCreature(creatureId) {
        // 從路線精靈列表中查找該精靈
        const creatureIndex = routeCreatures.findIndex(c => c.id === creatureId);
        
        if (creatureIndex === -1) {
            console.error('找不到指定ID的精靈:', creatureId);
            alert('找不到該精靈，可能已經被捕捉或消失了！');
            return;
        }
        
        const creature = routeCreatures[creatureIndex];
        
        // 模擬捕捉成功率 (在實際應用中，這可能與玩家等級、道具等有關)
        const successRate = creature.rarity === '稀有' ? 0.6 : 0.8;
        const isSuccess = Math.random() < successRate;
        
        if (isSuccess) {
            alert(`恭喜！你成功捕捉了 ${creature.name}！`);
            // 在實際應用中，這裡可以調用 API 將精靈添加到玩家的收藏中
            
            // 從地圖上移除該精靈的標記
            if (creature.marker) {
                creaturesLayer.removeLayer(creature.marker);
            }
            
            // 從精靈列表中移除
            routeCreatures.splice(creatureIndex, 1);
            
            // 更新UI
            updateCreaturesList();
        } else {
            alert(`可惜！${creature.name} 逃走了！再試一次吧！`);
        }
    }
    
    // 為了支持地圖上的捕捉功能，將該函數暴露到全域
    window.catchCreatureFromMap = function(creatureId) {
        catchCreature(creatureId);
        // 關閉彈出窗口
        map.closePopup();
    };
</script>
{% endblock %}