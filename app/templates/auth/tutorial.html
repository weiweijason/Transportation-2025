{% extends "base.html" %}

{% block title %}新手導覽 - 精靈公車{% endblock %}

{% block content %}
<div class="tutorial-container">
    <!-- 導覽步驟進度條 -->
    <div class="tutorial-progress-bar">
        <div class="tutorial-progress" id="tutorialProgress" style="width: 0%"></div>
    </div>
    
    <!-- 地圖容器 -->
    <div id="tutorialMap" class="tutorial-map"></div>
    
    <!-- 導覽提示對話框 -->
    <div class="tutorial-dialog" id="tutorialDialog">
        <div class="tutorial-dialog-content">
            <div class="tutorial-dialog-header">
                <h4 id="tutorialTitle">歡迎來到精靈公車世界！</h4>
                <div class="tutorial-step-indicator">
                    步驟 <span id="currentStep">1</span>/<span id="totalSteps">5</span>
                </div>
            </div>
            <div class="tutorial-dialog-body">
                <p id="tutorialText">在這個世界中，您可以探索城市，捕捉精靈，並與其他玩家競爭占領道館。讓我們開始基礎教學吧！</p>
  <!-- 捕捉精靈介面 (最初隱藏) -->
                <div id="catchInterface" class="catch-interface" style="display: none;">
                    <div class="creature-card">
                        <img id="creatureImage" src="" alt="精靈" class="creature-image">
                        <div class="creature-info">
                            <h5 id="creatureName">初始精靈</h5>
                            <div class="d-flex flex-wrap gap-1 mb-2">
                                <span id="creatureType" class="creature-type badge"></span>
                                <span id="creatureRarity" class="badge bg-secondary">普通</span>
                            </div>
                            <div class="creature-stats">
                                <div class="stat">
                                    <span class="stat-label">能量</span>
                                    <div class="stat-bar">
                                        <div id="powerBar" class="stat-fill"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="catch-actions mt-3">
                        <button id="catchButton" class="btn btn-primary btn-lg">
                            <i class="fas fa-hand-sparkles me-2"></i>捕捉
                        </button>
                    </div>
                    <div class="catch-info mt-2">
                        <small class="text-muted">精靈將在 <span id="catchCountdown">30</span> 秒後消失</small>
                    </div>
                </div>
                  <!-- 道館選擇介面 (最初隱藏) -->
                <div id="gymSelection" class="gym-selection" style="display: none;">
                    <h5>附近公車站牌擂台</h5>
                    <p class="small text-muted mb-3">選擇一個站牌擂台開始您的冒險</p>
                    <div class="gym-list">
                        <div class="gym-item" data-gym-id="tutorial-gym-1" data-lat="25.03556" data-lng="121.51972">
                            <div class="gym-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="gym-info">
                                <h6>中正紀念堂站道館</h6>
                                <small>等級: 3級 (經過3條公車路線)</small>
                                <div class="d-flex align-items-center mt-1">
                                    <span class="route-badge" style="background-color: #4caf50;">貓空左線</span>
                                    <span class="route-badge" style="background-color: #ff9800;">貓空右線</span>
                                    <span class="route-badge" style="background-color: #9c27b0;">貓左指南宮</span>
                                </div>
                            </div>
                        </div>
                        <div class="gym-item" data-gym-id="tutorial-gym-2" data-lat="25.03756" data-lng="121.52172">
                            <div class="gym-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="gym-info">
                                <h6>東門站道館</h6>
                                <small>等級: 2級 (經過2條公車路線)</small>
                                <div class="d-flex align-items-center mt-1">
                                    <span class="route-badge" style="background-color: #4caf50;">貓空左線</span>
                                    <span class="route-badge" style="background-color: #ff9800;">貓空右線</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                  <!-- 占領道館介面 (最初隱藏) -->
                <div id="gymOccupation" class="gym-occupation" style="display: none;">
                    <div class="battle-header mb-3">
                        <h5 id="battleArenaName">中正紀念堂站道館</h5>
                        <div class="battle-status">
                            <span class="badge bg-success">空置</span>
                            <span class="text-muted small">尚無人佔領此道館</span>
                        </div>
                    </div>
                    <h5>選擇一隻精靈進行佔領</h5>
                    <p class="text-muted small mb-3">放置強大的精靈來守護您的道館</p>
                    <div class="creatures-list">
                        <div class="creature-selection-item" data-creature-id="starter_creature">
                            <img id="starterCreatureImg" src="" alt="初始精靈" class="creature-select-img">
                            <div class="creature-select-info">
                                <h6 id="starterCreatureName">初始精靈</h6>
                                <div class="d-flex flex-wrap gap-1 mb-1">
                                    <span id="starterCreatureType" class="creature-select-type badge"></span>
                                    <span class="badge bg-secondary">普通</span>
                                </div>
                                <div class="creature-select-power">
                                    <i class="fas fa-bolt"></i> <span id="starterCreaturePower">0</span> 力量
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="occupation-notice alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>佔領道館後，其他玩家可以挑戰您的精靈。如果他們獲勝，道館擁有權將轉移給他們。</small>
                    </div>
                    <button id="occupyGymButton" class="btn btn-danger btn-block mt-3 w-100">
                        <i class="fas fa-flag me-2"></i>佔領道館
                    </button>
                </div>
            </div>
            <div class="tutorial-dialog-footer">
                <button id="tutorialPrev" class="btn btn-outline-secondary" style="display: none;">
                    <i class="fas fa-arrow-left me-2"></i>上一步
                </button>
                <button id="tutorialNext" class="btn btn-success">
                    <span id="nextBtnText">開始</span>
                    <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
    </div>
      <!-- 完成導覽的對話框 -->
    <div class="tutorial-complete-dialog" id="tutorialComplete" style="display: none;">
        <div class="tutorial-complete-content">
            <div class="complete-icon">
                <i class="fas fa-check-circle fa-3x"></i>
            </div>
            <h3>恭喜完成新手導覽！</h3>
            <p>您已經學會了精靈公車的基本玩法。現在，整個城市都等待著您的探索！捕捉更多精靈，占領更多道館，成為最強的訓練師吧！</p>
            <a href="{{ url_for('auth.login') }}" class="btn btn-success btn-lg">
                <i class="fas fa-play me-2"></i>開始遊戲
            </a>
        </div>
    </div>
    
    <!-- 捕捉成功模態框 -->
    <div class="capture-success-modal" id="captureSuccessModal" style="display: none;">
        <div class="capture-success-content">
            <div class="success-icon">
                <i class="fas fa-star fa-3x"></i>
            </div>
            <div class="success-creature">
                <img id="successCreatureImg" src="" alt="捕獲的精靈" class="success-creature-img">
            </div>
            <h4>恭喜您捕獲了</h4>
            <h3 id="successCreatureName">精靈</h3>
            <div class="success-creature-info">
                <span id="successCreatureType" class="badge">類型</span>
                <span class="badge bg-secondary" id="successCreatureRarity">稀有度</span>
            </div>
            <p class="success-message">這隻精靈已加入您的收藏！</p>
            <button id="continueButton" class="btn btn-primary btn-lg">
                <i class="fas fa-check me-2"></i>繼續
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
<style>
    .tutorial-container {
        position: relative;
        width: 100%;
        height: 100vh;
        overflow: hidden;
    }
    
    .tutorial-map {
        width: 100%;
        height: 100%;
        z-index: 1;
    }
    
    .tutorial-progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 8px;
        background-color: rgba(255, 255, 255, 0.2);
        z-index: 10;
    }
    
    .tutorial-progress {
        height: 100%;
        background-color: #4CAF50;
        transition: width 0.5s ease-in-out;
    }
    
    .tutorial-dialog {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 500px;
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 2;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .tutorial-dialog-content {
        padding: 20px;
    }
    
    .tutorial-dialog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .tutorial-dialog-header h4 {
        margin: 0;
        color: #2c3e50;
    }
    
    .tutorial-step-indicator {
        font-size: 0.9rem;
        color: #7f8c8d;
        background-color: #f1f1f1;
        padding: 5px 10px;
        border-radius: 10px;
    }
    
    .tutorial-dialog-body {
        margin-bottom: 20px;
        min-height: 120px;
    }
    
    .tutorial-dialog-footer {
        display: flex;
        justify-content: space-between;
    }
      /* 捕捉精靈介面 */
    .catch-interface {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .creature-card {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        background-color: white;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
    }
    
    .creature-image {
        width: 80px;
        height: 80px;
        object-fit: contain;
        margin-right: 15px;
        border-radius: 8px;
        background-color: #f5f5f5;
        padding: 5px;
    }
    
    .creature-info {
        text-align: left;
        flex-grow: 1;
    }
    
    .creature-type {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
        margin-bottom: 5px;
    }
    
    .creature-stats {
        margin-top: 5px;
    }
    
    .stat {
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #7f8c8d;
        margin-right: 10px;
    }
    
    .stat-bar {
        display: inline-block;
        width: 150px;
        height: 8px;
        background-color: #ecf0f1;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .stat-fill {
        height: 100%;
        background-color: #3498db;
        width: 0;
    }
    
    .catch-actions {
        margin-top: 10px;
    }
      /* 道館選擇 */
    .gym-selection {
        max-height: 300px;
        overflow-y: auto;
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
    
    .gym-list {
        margin-top: 10px;
    }
    
    .gym-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        background-color: #f8f9fa;
    }
    
    .gym-item:hover {
        background-color: #f5f5f5;
        transform: translateY(-2px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
    }
    
    .gym-item.selected {
        border-color: #4CAF50;
        background-color: rgba(76, 175, 80, 0.1);
    }
    
    .gym-icon {
        width: 40px;
        height: 40px;
        background-color: #3498db;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin-right: 15px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }
    
    .gym-info {
        flex-grow: 1;
    }
    
    .gym-info h6 {
        margin: 0;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .gym-info small {
        color: #7f8c8d;
        display: block;
        margin-top: 3px;
        font-size: 0.8rem;
    }
    
    .route-badge {
        display: inline-block;
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 5px;
    }
    
    /* 占領道館 */
    .gym-occupation {
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
    
    .battle-header {
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .battle-status {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
    }
    
    .creatures-list {
        margin: 15px 0;
    }
    
    .creature-selection-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 10px;
        background-color: #f8f9fa;
        border: 2px solid #4CAF50;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
    }
    
    .creature-select-img {
        width: 70px;
        height: 70px;
        object-fit: contain;
        margin-right: 15px;
        background-color: #f5f5f5;
        border-radius: 8px;
        padding: 5px;
    }
    
    .creature-select-info {
        text-align: left;
        flex-grow: 1;
    }
    
    .creature-select-info h6 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
    }
    
    .creature-select-type {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
        margin: 5px 0;
    }
    
    .creature-select-power {
        font-size: 0.85rem;
        color: #e67e22;
        font-weight: 600;
    }
      /* 完成導覽 */
    .tutorial-complete-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .tutorial-complete-content {
        background-color: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        text-align: center;
    }
    
    .complete-icon {
        color: #4CAF50;
        margin-bottom: 20px;
    }
    
    /* 捕捉成功模態框 */
    .capture-success-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        animation: fadeIn 0.5s ease-in-out;
    }
    
    .capture-success-content {
        background-color: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        animation: scaleIn 0.5s ease-in-out;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .success-icon {
        color: #f39c12;
        margin-bottom: 10px;
        animation: rotate 1s ease-in-out;
    }
    
    .success-creature {
        margin: 15px 0;
    }
    
    .success-creature-img {
        width: 120px;
        height: 120px;
        object-fit: contain;
        border-radius: 50%;
        border: 3px solid #f39c12;
        padding: 10px;
        background-color: rgba(243, 156, 18, 0.1);
        animation: bounce 1s ease-in-out infinite alternate;
    }
    
    .success-creature-info {
        margin: 15px 0;
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    
    .success-message {
        margin: 15px 0;
        color: #7f8c8d;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes scaleIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    @keyframes bounce {
        from { transform: translateY(0); }
        to { transform: translateY(-10px); }
    }
    
    /* 響應式設計 */
    @media (max-width: 767.98px) {
        .tutorial-dialog {
            width: 95%;
            max-width: none;
            bottom: 15px;
        }
        
        .tutorial-dialog-content {
            padding: 15px;
        }
        
        .stat-bar {
            width: 100px;
        }
    }
    
    /* 深色模式適配 */
    [data-theme="dark"] .tutorial-dialog {
        background-color: rgba(33, 37, 41, 0.95);
    }
    
    [data-theme="dark"] .tutorial-dialog-header h4 {
        color: #e0e0e0;
    }
    
    [data-theme="dark"] .tutorial-step-indicator {
        background-color: #343a40;
        color: #adb5bd;
    }
    
    [data-theme="dark"] .catch-interface {
        background-color: rgba(33, 37, 41, 0.9);
    }
    
    [data-theme="dark"] .stat-bar {
        background-color: #343a40;
    }
    
    [data-theme="dark"] .gym-item:hover {
        background-color: #343a40;
    }
    
    [data-theme="dark"] .gym-info small {
        color: #adb5bd;
    }
    
    [data-theme="dark"] .creature-selection-item {
        background-color: #343a40;
    }
    
    [data-theme="dark"] .tutorial-complete-content {
        background-color: #2d3436;
        color: #e0e0e0;
    }
    
    /* 類型顏色 */
    .water-type {
        background-color: #3498db;
    }
    
    .fire-type {
        background-color: #e74c3c;
    }
    
    .air-type, .wind-type {
        background-color: #9b59b6;
    }
      /* Leaflet 地圖自定義標記 */
    .gym-marker {
        background-color: #e74c3c;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        transition: all 0.3s ease;
    }
    
    .gym-marker.high-level {
        background-color: #e74c3c;
        border: 3px solid #f39c12;
    }
    
    .gym-marker.mid-level {
        background-color: #3498db;
        border: 3px solid white;
    }
    
    .gym-marker:hover {
        transform: scale(1.1);
    }
    
    .creature-marker {
        background-color: #3498db;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        animation: pulse 2s infinite;
        cursor: pointer;
    }
    
    .creature-marker:hover {
        animation: none;
        transform: scale(1.2);
    }
    
    .player-marker {
        background-color: #2ecc71;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        z-index: 1000;
    }
    
    .pulse-ring {
        position: absolute;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgba(52, 152, 219, 0.3);
        z-index: -1;
        animation: pulse-ring 2s infinite;
    }
    
    /* 站牌道館氣泡窗口 */
    .gym-popup {
        min-width: 200px;
        text-align: center;
    }
    
    .routes-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 5px;
    }
    
    /* 動畫 */
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(52, 152, 219, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(52, 152, 219, 0);
        }
    }
    
    @keyframes pulse-ring {
        0% {
            transform: scale(0.8);
            opacity: 0.8;
        }
        50% {
            opacity: 0.4;
        }
        100% {
            transform: scale(1.5);
            opacity: 0;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Leaflet 地圖庫 -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

<!-- 初始化數據 -->
<script>
    // 從後端獲取的數據
    const defaultCreature = {{ default_creature|tojson }};
    const gyms = {{ gyms|tojson }};
</script>

<!-- 拆分的 JavaScript 模塊 -->
<script src="{{ url_for('static', filename='js/tutorial/tutorial-config.js') }}"></script>
<script src="{{ url_for('static', filename='js/tutorial/tutorial-map.js') }}"></script>
<script src="{{ url_for('static', filename='js/tutorial/tutorial-creature.js') }}"></script>
<script src="{{ url_for('static', filename='js/tutorial/tutorial-gym.js') }}"></script>
<script src="{{ url_for('static', filename='js/tutorial/tutorial-ui.js') }}"></script>
<script src="{{ url_for('static', filename='js/tutorial/tutorial-main.js') }}"></script>
{% endblock %}