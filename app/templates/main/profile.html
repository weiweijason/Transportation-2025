{% extends "base.html" %}

{% block title %}個人精靈 - 精靈公車{% endblock %}

{% block content %}
<div class="profile-header mb-4">
    <div class="row align-items-center">
        <div class="col-lg-12 text-center">
            <h2 class="profile-title"><i class="fas fa-id-card me-2"></i>訓練師檔案</h2>
        </div>
    </div>
</div>

<div class="row">
    <!-- 玩家資料卡 -->
    <div class="col-md-4 mb-4">
        <div class="card profile-card shadow-lg">
            <div class="profile-banner" style="background-image: url('https://img.freepik.com/free-vector/gradient-mountain-landscape_23-2149162007.jpg?w=740&t=st=1711400000~exp=1711400600~hmac=0d7b12bc87e46f2ce2b8c5b2400c5fb8d0f9dab991a753e4a3cb3324354a7c47');">                <div class="profile-avatar-wrapper">
                    <img src="{{ url_for('static', filename='img/avatar-default.png') }}" alt="玩家頭像" class="profile-avatar" id="user-avatar">
                    <div class="level-badge">
                        <span id="user-level">1</span>
                    </div>
                </div>
            </div>
            <div class="card-body text-center">
                <h4 class="trainer-name">{{ session['user']['username'] }}</h4>
                <div class="trainer-stats mb-3">
                    <div class="row">
                        <div class="col-4">
                            <div class="stat-item">
                                <span class="stat-value" id="captured-count">0</span>
                                <span class="stat-label">已捕獲</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <span class="stat-value" id="arena-count">0</span>
                                <span class="stat-label">擂台</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <span class="stat-value" id="battle-count">0</span>
                                <span class="stat-label">戰鬥</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="exp-container mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small">經驗值</span>
                        <span class="small" id="exp-text">0/100</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" id="exp-progress" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <button class="btn btn-outline-primary btn-rounded w-100">
                    <i class="fas fa-pencil-alt me-2"></i>編輯資料
                </button>
            </div>
            <div class="card-footer bg-light">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="achievement">
                            <i class="fas fa-medal text-warning"></i>
                            <span>成就: 3/20</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="achievement">
                            <i class="fas fa-trophy text-danger"></i>
                            <span>排名: #42</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- 功能選單卡片 -->
    <div class="col-md-8">
        <div class="row g-3">
            {% set menu_items = [
                {"label": "精靈", "icon": url_for('static', filename='img/profile/elf.png'), "url": url_for('bylin.myelf')},
                {"label": "背包", "icon": url_for('static', filename='img/profile/bag.png'), "url": url_for('#')},
                {"label": "我的道館", "icon": url_for('static', filename='img/profile/arena.png'), "url": url_for('bylin.myarena')},
                {"label": "競技場", "icon": url_for('static', filename='img/profile/battle.png'), "url": url_for('friend_fight.choose')},
                {"label": "好友", "icon": url_for('static', filename='img/profile/friends.png'), "url": url_for('community.friends')},
                {"label": "成就", "icon": url_for('static', filename='img/profile/achievement.png'), "url": url_for('achievement.achievement')}
            ] %}
            {% for item in menu_items %}
            <div class="col-4 text-center">
                <a href="{{ item.url }}" class="menu-link d-block p-2">
                    <img src="{{ item.icon }}" alt="{{ item.label }}" class="img-fluid mb-2 menu-icon">
                    <div class="menu-label">{{ item.label }}</div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile/profile.css') }}">
{% endblock %}

{% block extra_js %}
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script>
    // 初始化Firebase
    var firebaseConfig = {
        apiKey: "{{ firebase_config.apiKey }}",
        authDomain: "{{ firebase_config.authDomain }}",
        projectId: "{{ firebase_config.projectId }}",
        storageBucket: "{{ firebase_config.storageBucket }}",
        messagingSenderId: "{{ firebase_config.messagingSenderId }}",
        appId: "{{ firebase_config.appId }}"
    };
    
    // 初始化Firebase應用
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    // 取得Firestore資料庫實例
    var db = firebase.firestore();
      // 從Firebase獲取用戶數據
    document.addEventListener('DOMContentLoaded', function() {
        const userId = "{{ session['user']['uid'] }}";
        
        if (!userId) {
            console.error("未登入或找不到用戶ID");
            return;
        }
        
        console.log("正在從 Firebase 獲取用戶數據, 用戶ID:", userId);
        
        // 從Firestore獲取用戶資料
        db.collection('users').doc(userId).get()
            .then(function(doc) {
                if (doc.exists) {
                    const userData = doc.data();
                    console.log("成功獲取用戶資料:", userData);
                    
                    // 檢查頭像資料
                    if (userData.avatar) {
                        console.log("用戶頭像 URL:", userData.avatar);
                        console.log("頭像 URL 長度:", userData.avatar.length);
                    } else {
                        console.log("用戶資料中沒有頭像 URL");
                    }
                    
                    updateUserProfile(userData);
                    
                    // 獲取用戶已捕獲的精靈
                    loadUserCreatures(userId);
                    
                    // 獲取用戶擁有的擂台
                    loadUserArenas(userId);
                } else {
                    console.error("找不到用戶資料!");
                }
            })
            .catch(function(error) {
                console.error("獲取用戶資料錯誤:", error);
            });
    });
      // 更新用戶資料顯示
    function updateUserProfile(userData) {
        console.log("從 Firebase 獲取的用戶資料:", userData);
        
        // 設定用戶等級
        const userLevel = userData.level || 1;
        document.getElementById('user-level').textContent = userLevel;
        
        // 設定經驗值
        const userExp = userData.experience || 0;
        const nextLevelExp = userLevel * 100; // 假設每級需要100*等級的經驗值
        document.getElementById('exp-text').textContent = `${userExp}/${nextLevelExp}`;
        
        // 更新經驗值進度條
        const expPercentage = (userExp / nextLevelExp) * 100;
        document.getElementById('exp-progress').style.width = `${expPercentage}%`;
        
        // 更新戰鬥次數
        const battleCount = userData.fight_count || 0;
        document.getElementById('battle-count').textContent = battleCount;
        
        // 更新用戶頭像
        const userAvatar = userData.avatar || null;
        if (userAvatar && userAvatar !== 'default.png') {
            console.log("設置用戶頭像:", userAvatar);
            document.getElementById('user-avatar').src = userAvatar;
        } else {
            console.log("使用默認頭像");
        }
    }
    
    
    
    // 格式化日期
    function formatDate(timestamp) {
        if (!timestamp) return '未知日期';
        
        // 如果是Firebase Timestamp格式
        if (timestamp && timestamp.seconds) {
            const date = new Date(timestamp.seconds * 1000);
            return date.toLocaleDateString('zh-TW');
        }
        
        // 如果是其他格式，嘗試轉換為日期
        try {
            const date = new Date(timestamp);
            return date.toLocaleDateString('zh-TW');
        } catch (e) {
            return '未知日期';
        }
    }
</script>
{% endblock %}