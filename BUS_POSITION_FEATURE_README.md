# 公車實時位置功能說明

## 功能概述

此功能在精靈捕捉遊戲的地圖上顯示公車的實時位置，並且支援點擊公車標記查看車號資訊。公車位置數據每30秒與精靈更新、用戶位置同步更新。

## 功能特點

### 1. 公車位置顯示
- ✅ 在地圖上以彩色公車圖標顯示不同路線的公車
- ✅ 支援4條路線：棕3、貓空左線(動物園)、貓空左線(指南宮)、貓空右線
- ✅ 每條路線使用不同顏色的圖標進行區分

### 2. 互動功能
- ✅ 點擊公車圖標顯示彈出窗口，包含：
  - 車號資訊
  - 所屬路線
  - 精確座標位置
- ✅ 彈出窗口採用美觀的設計，與遊戲UI風格一致

### 3. 自動更新機制
- ✅ 每30秒自動更新公車位置
- ✅ 同時更新精靈位置和用戶位置
- ✅ 更新失敗時顯示友善錯誤提示

### 4. 跨頁面支援
- ✅ 在精靈捕捉頁面 (`catch.html`) 顯示公車位置
- ✅ 在全螢幕地圖頁面 (`map.html`) 顯示公車位置
- ✅ 兩個頁面的功能完全同步

## 技術實現

### 文件結構
```
app/
├── static/
│   ├── js/
│   │   ├── modules/
│   │   │   └── bus-position-manager.js    # 公車位置管理模組
│   │   ├── game/
│   │   │   ├── catch-game.js              # 更新了綜合更新邏輯
│   │   │   └── fullscreen-map-main-fixed.js  # 全螢幕地圖支援
│   │   └── bus-route-map.js               # 主地圖模組(已更新)
│   ├── css/
│   │   └── game/
│   │       └── catch-game.css             # 公車標記樣式
│   └── data/
│       └── bus/                           # 公車數據文件
│           ├── br3_bus.json
│           ├── cat_left_bus.json
│           ├── cat_left_zhinan_bus.json
│           └── cat_right_bus.json
└── templates/
    └── game/
        ├── catch.html                     # 精靈捕捉頁面(已更新)
        └── map.html                       # 全螢幕地圖頁面(已更新)
```

### 核心模組

#### 1. bus-position-manager.js
負責公車位置的載入、顯示和管理：
- `initBusPositionLayer()` - 初始化公車位置圖層
- `loadAllBusPositions()` - 載入所有路線的公車位置
- `updateBusPositions()` - 更新公車位置
- `clearBusMarkers()` - 清除公車標記
- `toggleBusLayer()` - 切換圖層顯示/隱藏

#### 2. 數據格式
公車數據採用JSON格式，每輛公車包含：
```json
[
  {
    "PlateNumb": "車牌號碼",
    "PositionLon": 經度,
    "PositionLat": 緯度
  }
]
```

#### 3. 圖標設計
- 使用SVG格式的公車圖標
- 根據路線顏色動態生成
- 包含車輛外觀和顏色標識

## 路線顏色配置

| 路線 | 顏色 | 代碼 |
|------|------|------|
| 棕3路線 | 棕色 | #8B4513 |
| 貓空左線(動物園) | 綠色 | #4caf50 |
| 貓空左線(指南宮) | 紫色 | #9c27b0 |
| 貓空右線 | 橙色 | #ff9800 |

## 更新機制

### 30秒定期更新
系統每30秒執行一次綜合更新，包括：
1. 📍 更新精靈位置（從CSV獲取）
2. 🚌 更新公車位置（從JSON文件獲取）
3. 📱 更新用戶位置（重新定位）

### 錯誤處理
- 如果精靈更新失敗，仍會嘗試更新公車位置和用戶位置
- 顯示具體的錯誤信息給用戶
- 提供重試機制

## 使用方式

### 對於用戶
1. 打開精靈捕捉遊戲頁面
2. 等待地圖載入完成
3. 觀察地圖上的彩色公車圖標
4. 點擊任意公車圖標查看詳細資訊
5. 系統會自動每30秒更新一次所有數據

### 對於開發者
1. 更新公車位置數據：
   ```bash
   # 編輯對應的JSON文件
   app/static/data/bus/[路線名稱]_bus.json
   ```

2. 手動觸發更新：
   ```javascript
   // 在瀏覽器控制台執行
   window.updateBusPositions();
   ```

3. 切換公車圖層顯示：
   ```javascript
   // 隱藏公車圖層
   window.toggleBusLayer(false);
   // 顯示公車圖層
   window.toggleBusLayer(true);
   ```

## 測試

### 自動測試
在瀏覽器控制台中執行：
```javascript
window.testBusPositionFeatures.runFullTest();
```

### 測試頁面
開啟 `test_bus_position.html` 進行完整的功能測試：
- 地圖初始化測試
- 公車位置載入測試
- 數據文件驗證
- 互動功能測試

## 未來擴展

### 可能的改進方向
1. 🔄 支援即時API數據源
2. 📊 公車到站時間預測
3. 🗺️ 公車路線軌跡顯示
4. 📲 公車位置推送通知
5. 🎯 最近公車站點導航

### 性能優化
1. 實現公車標記的虛擬化渲染
2. 增加數據快取機制
3. 優化圖標載入性能
4. 實現增量更新

## 問題排除

### 常見問題

**Q: 公車標記沒有顯示？**
A: 檢查以下項目：
1. 確認公車數據文件存在且格式正確
2. 檢查瀏覽器控制台是否有錯誤
3. 驗證地圖是否已完全載入

**Q: 點擊公車標記沒有反應？**
A: 確認：
1. 彈出窗口功能已啟用
2. 沒有其他JavaScript錯誤阻擋事件
3. 瀏覽器支援點擊事件

**Q: 公車位置更新失敗？**
A: 檢查：
1. 網路連接是否正常
2. 公車數據文件是否可訪問
3. 檢查瀏覽器控制台的具體錯誤信息

**Q: 出現 "InvalidCharacterError: Failed to execute 'btoa'" 錯誤？**
A: 這個問題已在v1.0.1中修復：
1. 移除了SVG中的中文字符
2. 使用 `encodeURIComponent` 替代 `btoa` 進行編碼
3. 更新到最新版本即可解決

**Q: 某些路線顯示"沒有公車在運行"？**
A: 這是正常情況：
1. 路線可能尚未發車或已收班
2. 系統會顯示空陣列 `[]` 表示該路線暫無公車
3. 系統會在載入結果中明確標示哪些路線暫無公車運行

### 已修復的問題 (v1.0.1)

#### 1. SVG編碼錯誤修復
**問題**: 使用 `btoa()` 編碼包含中文字符的SVG時出錯
```javascript
// 錯誤的方式
btoa(`<text>公車</text>`) // InvalidCharacterError
```

**解決方案**: 
- 移除SVG中的中文字符
- 使用 `encodeURIComponent` 替代 `btoa`
- 採用 `data:image/svg+xml;charset=utf-8,` 格式

#### 2. 空陣列處理優化
**問題**: 路線尚未發車時返回空陣列 `[]`，缺乏適當處理

**解決方案**:
- 添加空陣列檢測邏輯
- 提供友善的狀態提示
- 統計並報告活躍/非活躍路線數量

#### 3. 錯誤信息優化
**改進**:
- 更詳細的載入狀態報告
- 區分不同類型的錯誤（載入失敗 vs 暫無公車）
- 提供更友善的用戶提示

### 修復驗證

執行以下測試驗證修復效果：
```javascript
// 在瀏覽器控制台執行
window.busPositionFixTests.runAllTests();
```

## 版本信息

- **版本**: 1.0.1 (修復版)
- **發布日期**: 2025年6月18日
- **修復內容**: 
  - ✅ SVG編碼錯誤修復
  - ✅ 空陣列處理優化  
  - ✅ 錯誤信息改進
- **相容性**: 支援所有現代瀏覽器
- **依賴**: Leaflet.js, Bootstrap 5, Font Awesome

---
*此功能為精靈公車遊戲的重要組成部分，提供了真實的公車位置資訊以增強遊戲體驗。*
